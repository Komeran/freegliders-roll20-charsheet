<input type="hidden" class="sheet-pc-tabstoggle" name="attr_pcTab" value="pc" />
<input type="hidden" name="attr_agileBonus" value="0" />
<input type="hidden" name="attr_analyticalMindBonus" value="0" />
<input type="hidden" name="attr_educatedBonus" value="0" />
<input type="hidden" name="attr_quickReflexesBonus" value="0" />
<input type="hidden" name="attr_toughBonus" value="0" />
<input type="hidden" name="attr_sneakyBonus" value="0" />
<input type="hidden" name="attr_inspiringPresenceBonus" value="0" />
<input type="hidden" name="attr_strongBonus" value="0" />
<input type="hidden" name="attr_silverTongueBonus" value="0" />
<input type="hidden" name="attr_addictPenalty" value="0" />
<input type="hidden" name="attr_clumsyPenalty" value="0" />
<input type="hidden" name="attr_dullPenalty" value="0" />
<input type="hidden" name="attr_fragilePenalty" value="0" />
<input type="hidden" name="attr_weakPenalty" value="0" />
<input type="hidden" name="attr_sociallyIneptPenalty" value="0" />

<!-- PC / NPC tabs -->
<div>
    <button type="action" name="act_pc" class="sheet-pc-button0">PC</button>
    <button type="action" name="act_npc" class="sheet-pc-button1">NPC</button>
</div>

<hr class="sheet-separator"/>

<!-- PC -->
<div class="sheet-pc">
    <!-- Tabs -->
    <input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="character" />
    <div>
        <button type="action" name="act_character" class="sheet-button0">Character</button>
        <button type="action" name="act_combat" class="sheet-button1">Combat</button>
        <button type="action" name="act_qualities" class="sheet-button2">Qualities</button>
        <button type="action" name="act_inventory" class="sheet-button3">Inventory</button>
        <button type="action" name="act_prayer" class="sheet-button4">Prayer</button>
        <button type="action" name="act_witchcraft" class="sheet-button5">Witchcraft</button>
        <button type="action" name="act_alchemy" class="sheet-button6">Alchemy</button>
        <button type="action" name="act_clockworkMechanics" class="sheet-button7">Clockwork Mechanics</button>
        <button type="action" name="act_augmentations" class="sheet-button8">Augmentations</button>
    </div>

    <!-- Character -->
    <div class="sheet-character sheet-page">
        <h2>Character</h2>

        <hr class="sheet-separator"/>

        <div class="sheet-character-basics">
            <!-- Character Name -->
            <div>
                <input type="text" name="attr_character_name" />
                <label>Character Name</label>
            </div>

            <!-- Background -->
            <div>
                <input type="text" name="attr_background" />
                <label>Background</label>
            </div>

            <!-- Religion -->
            <div>
                <input type="text" name="attr_religion" />
                <label>Religion</label>
            </div>

            <!-- Player -->
            <div>
                <input type="text" name="attr_player" />
                <label>Player</label>
            </div>

            <!-- Level -->
            <div>
                <input type="number" name="attr_level" min="1" value="1" />
                <label>Level</label>
            </div>

            <!-- GP -->
            <div>
                <input type="number" name="attr_gp" min="0" />
                <label>GP</label>
            </div>

            <!-- Age -->
            <div>
                <input type="number" name="attr_age" min="0" />
                <label>Age</label>
            </div>

            <!-- Gender -->
            <div>
                <input type="text" name="attr_gender" />
                <label>Gender</label>
            </div>
        </div>

        <hr class="sheet-separator"/>

        <!-- Attributes -->
        <div class="sheet-character-attributes">
            <!-- Agility -->
            <div class="sheet-attribute">
                <button type="roll" name="roll_agi" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Agility Test [@{agi}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{agi}]]}}">
                    <span name="attr_agi"></span>
                </button>
                <div class="sheet-attribute-score">
                    <input type="number" name="attr_agility" value="1" min="0"/>
                </div>
                <label class="sheet-attribute-label">Agility</label>
            </div>

            <!-- Body -->
            <div class="sheet-attribute">
                <button type="roll" name="roll_bod" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Body Test [@{bod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{bod}]]}}">
                    <span name="attr_bod"></span>
                </button>
                <div class="sheet-attribute-score">
                    <input type="number" name="attr_body" value="1" min="0"/>
                </div>
                <label class="sheet-attribute-label">Body</label>
            </div>

            <!-- Charisma -->
            <div class="sheet-attribute">
                <button type="roll" name="roll_cha" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Charisma Test [@{cha}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{cha}]]}}">
                    <span name="attr_cha"></span>
                </button>
                <div class="sheet-attribute-score">
                    <input type="number" name="attr_charisma" value="1" min="0"/>
                </div>
                <label class="sheet-attribute-label">Charisma</label>
            </div>

            <!-- Intuition -->
            <div class="sheet-attribute">
                <button type="roll" name="roll_int" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Intuition Test [@{int}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{int}]]}}">
                    <span name="attr_int"></span>
                </button>
                <div class="sheet-attribute-score">
                    <input type="number" name="attr_intuition" value="1" min="0"/>
                </div>
                <label class="sheet-attribute-label">Intuition</label>
            </div>

            <!-- Logic -->
            <div class="sheet-attribute">
                <button type="roll" name="roll_log" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Logic Test [@{log}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{log}]]}}">
                    <span name="attr_log"></span>
                </button>
                <div class="sheet-attribute-score">
                    <input type="number" name="attr_logic" value="1" min="0"/>
                </div>
                <label class="sheet-attribute-label">Logic</label>
            </div>

            <!-- Willpower -->
            <div class="sheet-attribute">
                <button type="roll" name="roll_wil" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Willpower Test [@{wil}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{wil}]]}}">
                    <span name="attr_wil"></span>
                </button>
                <div class="sheet-attribute-score">
                    <input type="number" name="attr_willpower" value="1" min="0"/>
                </div>
                <label class="sheet-attribute-label">Willpower</label>
            </div>
        </div>

        <hr class="sheet-separator"/>

        <!-- Skills -->
        <div class="sheet-skills">
            <div class="sheet-character-skills-left">
                <!-- Physical Skills -->
                <table class="sheet-skill-group">
                    <tr class="sheet-skill-group-head">
                        <th>Physical Skills</th>
                        <th>Passive</th>
                        <th>Ranks</th>
                        <th>Mod</th>
                    </tr>
                    <!-- Athletics -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Athletics [BOD]</td>
                        <td><span name="attr_athleticsPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_athletics" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_athletics" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Athletics [BOD] Test [@{athleticsMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{athleticsMod}]]}}">
                                <span name="attr_athleticsMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Perception -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Perception [INT]</td>
                        <td><span name="attr_perceptionPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_perception" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_perception" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Perception [INT] Test [@{perceptionMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{perceptionMod}]]}}">
                                <span name="attr_perceptionMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Piloting -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Piloting [AGI]</td>
                        <td><span name="attr_pilotingPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_piloting" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_piloting" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Piloting [AGI] Test [@{pilotingMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{pilotingMod}]]}}">
                                <span name="attr_pilotingMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Stealth -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Stealth [AGI]</td>
                        <td><span name="attr_stealthPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_stealth" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_stealth" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Stealth [AGI] Test [@{stealthMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{stealthMod}]]}}">
                                <span name="attr_stealthMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Artisanship -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Artisanship [AGI]</td>
                        <td><span name="attr_artisanshipPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_artisanship" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_artisanship" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Artisanship [AGI] Test [@{artisanshipMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{artisanshipMod}]]}}">
                                <span name="attr_artisanshipMod"></span>
                            </button>
                        </td>
                    </tr>
                </table>
                <!-- Social Skills -->
                <table class="sheet-skill-group">
                    <tr class="sheet-skill-group-head">
                        <th>Social Skills</th>
                        <th>Passive</th>
                        <th>Ranks</th>
                        <th>Mod</th>
                    </tr>
                    <!-- Deception -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Deception [CHA]</td>
                        <td><span name="attr_deceptionPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_deception" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_deception" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Deception [CHA] Test [@{deceptionMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{deceptionMod}]]}}">
                                <span name="attr_deceptionMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Intimidation -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Intimidation [CHA]</td>
                        <td><span name="attr_intimidationPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_intimidation" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_intimidation" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Intimidation [CHA] Test [@{intimidationMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{intimidationMod}]]}}">
                                <span name="attr_intimidationMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Performance -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Performance [CHA]</td>
                        <td><span name="attr_performancePassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_performance" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_performance" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Performance [CHA] Test [@{performanceMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{performanceMod}]]}}">
                                <span name="attr_performanceMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Persuasion -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Persuasion [CHA]</td>
                        <td><span name="attr_persuasionPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_persuasion" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_persuasion" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Persuasion [CHA] Test [@{persuasionMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{persuasionMod}]]}}">
                                <span name="attr_persuasionMod"></span>
                            </button>
                        </td>
                    </tr>
                </table>
                <!-- Knowledge Skills -->
                <table class="sheet-skill-group">
                    <tr class="sheet-skill-group-head">
                        <th>Knowledge Skills</th>
                        <th>Passive</th>
                        <th>Ranks</th>
                        <th>Mod</th>
                    </tr>
                    <!-- Astronomy -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Astronomy [LOG]</td>
                        <td><span name="attr_astronomyPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_astronomy" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_astronomy" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Astronomy [LOG] Test [@{astronomyMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{astronomyMod}]]}}">
                                <span name="attr_astronomyMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Economy -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Economy [LOG]</td>
                        <td><span name="attr_economyPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_economy" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_economy" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Economy [LOG] Test [@{economyMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{economyMod}]]}}">
                                <span name="attr_economyMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- History -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">History [LOG]</td>
                        <td><span name="attr_historyPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_history" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_history" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=History [LOG] Test [@{historyMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{historyMod}]]}}">
                                <span name="attr_historyMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Literature -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Literature [LOG]</td>
                        <td><span name="attr_literaturePassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_literature" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_literature" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Literature [LOG] Test [@{literatureMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{literatureMod}]]}}">
                                <span name="attr_literatureMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Medicine -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Medicine [LOG]</td>
                        <td><span name="attr_medicinePassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_medicine" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_medicine" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Medicine [LOG] Test [@{medicineMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{medicineMod}]]}}">
                                <span name="attr_medicineMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Mythology -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Mythology [LOG]</td>
                        <td><span name="attr_mythologyPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_mythology" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_mythology" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Mythology [LOG] Test [@{mythologyMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{mythologyMod}]]}}">
                                <span name="attr_mythologyMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Nature -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Nature [LOG]</td>
                        <td><span name="attr_naturePassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_nature" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_nature" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Nature [LOG] Test [@{natureMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{natureMod}]]}}">
                                <span name="attr_natureMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Survival -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Survival [INT]</td>
                        <td><span name="attr_survivalPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_survival" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_survival" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Survival [INT] Test [@{survivalMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{survivalMod}]]}}">
                                <span name="attr_survivalMod"></span>
                            </button>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="sheet-character-skills-right">
                <!-- Engineering Skills -->
                <table class="sheet-skill-group">
                    <tr class="sheet-skill-group-head">
                        <th>Engineering Skills</th>
                        <th>Passive</th>
                        <th>Ranks</th>
                        <th>Mod</th>
                    </tr>
                    <!-- Clockwork Mechanics -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Clockwork Mechanics [LOG]</td>
                        <td><span name="attr_clockworkmechanicsPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_clockworkmechanics" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_clockworkmechanics" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Clockwork Mechanics [LOG] Test [@{clockworkmechanicsMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{clockworkmechanicsMod}]]}}">
                                <span name="attr_clockworkmechanicsMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Automachinery -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Automachinery [LOG]</td>
                        <td><span name="attr_automachineryPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_automachinery" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_automachinery" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Automachinery [LOG] Test [@{automachineryMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{automachineryMod}]]}}">
                                <span name="attr_automachineryMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Augmentation -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Augmentation [LOG]</td>
                        <td><span name="attr_augmentationPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_augmentation" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_augmentation" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Augmentation [LOG] Test [@{augmentationMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{augmentationMod}]]}}">
                                <span name="attr_augmentationMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Gunsmithing -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Gunsmithing [AGI]</td>
                        <td><span name="attr_gunsmithingPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_gunsmithing" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_gunsmithing" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Gunsmithing [AGI] Test [@{gunsmithingMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{gunsmithingMod}]]}}">
                                <span name="attr_gunsmithingMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Tinkering -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Tinkering [AGI]</td>
                        <td><span name="attr_tinkeringPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_tinkering" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_tinkering" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Tinkering [AGI] Test [@{tinkeringMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{tinkeringMod}]]}}">
                                <span name="attr_tinkeringMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Vehicle Mechanics -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Vehicle Mechanics [BOD]</td>
                        <td><span name="attr_vehiclemechanicsPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_vehiclemechanics" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_vehiclemechanics" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Vehicle Mechanics [BOD] Test [@{vehiclemechanicsMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{vehiclemechanicsMod}]]}}">
                                <span name="attr_vehiclemechanicsMod"></span>
                            </button>
                        </td>
                    </tr>
                </table>

                <!-- Magic Skills -->
                <table class="sheet-skill-group">
                    <tr class="sheet-skill-group-head">
                        <th>Magic Skills</th>
                        <th>Passive</th>
                        <th>Ranks</th>
                        <th>Mod</th>
                    </tr>
                    <!-- Alchemy -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Alchemy [LOG]</td>
                        <td><span name="attr_alchemyPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_alchemy" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_alchemy" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Alchemy [LOG] Test [@{alchemyMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{alchemyMod}]]}}">
                                <span name="attr_alchemyMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Prayer -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Prayer [WIL]</td>
                        <td><span name="attr_prayerPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_prayer" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_prayer" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Prayer [WIL] Test [@{prayerMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{prayerMod}]]}}">
                                <span name="attr_prayerMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Spellwork -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Spellwork [WIL]</td>
                        <td><span name="attr_spellworkPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_spellwork" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_spellwork" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Spellwork [WIL] Test [@{spellworkMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{spellworkMod}]]}}">
                                <span name="attr_spellworkMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Runecraft -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Runecraft [LOG]</td>
                        <td><span name="attr_runecraftPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_runecraft" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_runecraft" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Runecraft [LOG] Test [@{runecraftMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{runecraftMod}]]}}">
                                <span name="attr_runecraftMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Summoning -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Summoning [WIL]</td>
                        <td><span name="attr_summoningPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_summoning" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_summoning" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Summoning [WIL] Test [@{summoningMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{summoningMod}]]}}">
                                <span name="attr_summoningMod"></span>
                            </button>
                        </td>
                    </tr>
                </table>

                <!-- Combat Skills -->
                <table class="sheet-skill-group">
                    <tr class="sheet-skill-group-head">
                        <th>Combat Skills</th>
                        <th>Passive</th>
                        <th>Ranks</th>
                        <th>Mod</th>
                    </tr>
                    <!-- Artillery -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Artillery [AGI]</td>
                        <td><span name="attr_artilleryPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_artillery" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_artillery" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Artillery [AGI] Test [@{artilleryMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{artilleryMod}]]}}">
                                <span name="attr_artilleryMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Brawling -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Brawling [AGI]</td>
                        <td><span name="attr_brawlingPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_brawling" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_brawling" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Brawling [AGI] Test [@{brawlingMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{brawlingMod}]]}}">
                                <span name="attr_brawlingMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Bow -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Bow [AGI]</td>
                        <td><span name="attr_bowPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_bow" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_bow" type="roll"
                            value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Bow [AGI] Test [@{bowMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{bowMod}]]}}">
                                <span name="attr_bowMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Pistol -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Pistol [AGI]</td>
                        <td><span name="attr_pistolPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_pistol" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_pistol" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Pistol [AGI] Test [@{pistolMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{pistolMod}]]}}">
                                <span name="attr_pistolMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Rifle -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Rifle [AGI]</td>
                        <td><span name="attr_riflePassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_rifle" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_rifle" type="roll"
                            value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Rifle [AGI] Test [@{rifleMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{rifleMod}]]}}">
                                <span name="attr_rifleMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Shield -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Shield [BOD]</td>
                        <td><span name="attr_shieldPassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_shield" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_shield" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Shield [BOD] Test [@{shieldMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{shieldMod}]]}}">
                                <span name="attr_shieldMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- One-Handed Melee -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">One-Handed Melee [AGI]</td>
                        <td><span name="attr_onehandedmeleePassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_onehandedmelee" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_onehandedmelee" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=One-Handed Melee [AGI] Test [@{onehandedmeleeMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{onehandedmeleeMod}]]}}">
                                <span name="attr_onehandedmeleeMod"></span>
                            </button>
                        </td>
                    </tr>
                    <!-- Two-Handed Melee -->
                    <tr class="sheet-skill-line">
                        <td class="sheet-skill-name">Two-Handed Melee [BOD]</td>
                        <td><span name="attr_twohandedmeleePassive"></span></td>
                        <td><input class="sheet-skill-ranks" min="0" name="attr_twohandedmelee" type="number" /></td>
                        <td>
                            <button class="sheet-skill-mod" name="roll_twohandedmelee" type="roll"
                                value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Two-Handed Melee [BOD] Test [@{twohandedmeleeMod}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{twohandedmeleeMod}]]}}">
                                <span name="attr_twohandedmeleeMod"></span>
                            </button>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Combat -->
    <div class="sheet-combat sheet-page">
        <h2>Combat</h2>

        <hr class="sheet-separator"/>

        <div class="sheet-combat-topline">
            <!-- HP -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" max="attr_hp_max" min="0" name="attr_hp" value="0"/>
                    <span name="attr_hp_max">0</span>
                </div>
                <label class="sheet-resource-label">HP</label>
                <span class="sheet-resource-calculation">(Body + (Hit Die Max / 2)) Ã— Level</span>
            </div>

            <!-- Hit Die -->
            <div class="sheet-item" name="hitdie">
                <div class="sheet-resource-hitdie">
                    <span name="attr_hitdie"></span>
                </div>
                <label class="sheet-resource-label">Hit Die</label>
            </div>

            <!-- Initiative -->
            <div class="sheet-item">
                <button type="roll" name="roll_initiative" class="sheet-rollable-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Initiative [@{initiative}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{initiative} &{tracker}]]}}">
                    <span name="attr_initiative"></span>
                </button>
                <label class="sheet-resource-label">Initiative</label>
                <span class="sheet-resource-calculation">AGI + INT</span>
            </div>

            <!-- Evasion -->
            <div class="sheet-item">
                <button type="roll" name="roll_evasion" class="sheet-rollable-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Evasion [@{evasion}]}} {{result=[[?{Roll Type|Normal,1d20|Advantage,2d20kh1|Disadvantage,2d20kl1}@{evasion}]]}}">
                    <span name="attr_evasion"></span>
                </button>
                <label class="sheet-resource-label">Evasion</label>
                <span class="sheet-resource-calculation">AGI + INT</span>
            </div>

            <!-- DAV -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <span name="attr_dav">0</span>
                </div>
                <label class="sheet-resource-label">DAV</label>
                <span class="sheet-resource-calculation">Torso AV</span>
            </div>
        </div>
        
        <div class="sheet-combat-bottom">
            <div class="sheet-combat-bottom-left">
                <!-- Death Tests -->
                <h2>Death Tests</h2>
                <hr class="sheet-section-separator"/>
                <div class="sheet-deathtests">
                    <div class="sheet-deathtest-success">
                        <input type="checkbox" name="attr_deathsuccess1"/>
                    </div>
                    <div class="sheet-deathtest-success">
                        <input type="checkbox" name="attr_deathsuccess2"/>
                    </div>
                    <div class="sheet-deathtest-success">
                        <input type="checkbox" name="attr_deathsuccess3"/>
                    </div>
                </div>
                <label>Successes</label>
                <div class="sheet-deathtests">
                    <div class="sheet-deathtest-success">
                        <input type="checkbox" name="attr_deathfailure1"/>
                    </div>
                    <div class="sheet-deathtest-success">
                        <input type="checkbox" name="attr_deathfailure2"/>
                    </div>
                    <div class="sheet-deathtest-success">
                        <input type="checkbox" name="attr_deathfailure3"/>
                    </div>
                </div>
                <label>Failures</label>

                <!-- Armor -->
                <table class="sheet-armor-table">
                    <tr>
                        <th>Body Part</th>
                        <th>Equipment/Armor</th>
                        <th>Base<br>AV</th>
                        <th>Augm. AV</th>
                        <th>Total AV</th>
                    </tr>
                    <!-- Head -->
                    <tr>
                        <td>Head</td>
                        <td>
                            <input type="text" name="attr_headArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_headAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_headAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_headTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Left Eye -->
                    <tr>
                        <td>Left Eye</td>
                        <td>
                            <input type="text" name="attr_leftEyeArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_leftEyeAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_leftEyeAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_leftEyeTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Right Eye -->
                    <tr>
                        <td>Right Eye</td>
                        <td>
                            <input type="text" name="attr_rightEyeArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_rightEyeAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_rightEyeAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_rightEyeTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Torso -->
                    <tr>
                        <td>Torso</td>
                        <td>
                            <input type="text" name="attr_torsoArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_torsoAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_torsoAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_torsoTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Left Arm -->
                    <tr>
                        <td>Left Arm</td>
                        <td>
                            <input type="text" name="attr_leftArmArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_leftArmAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_leftArmAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_leftArmTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Right Arm -->
                    <tr>
                        <td>Right Arm</td>
                        <td>
                            <input type="text" name="attr_rightArmArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_rightArmAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_rightArmAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_rightArmTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Left Hand -->
                    <tr>
                        <td>Left Hand</td>
                        <td>
                            <input type="text" name="attr_leftHandArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_leftHandAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_leftHandAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_leftHandTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Right Hand -->
                    <tr>
                        <td>Right Hand</td>
                        <td>
                            <input type="text" name="attr_rightHandArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_rightHandAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_rightHandAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_rightHandTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Left Leg -->
                    <tr>
                        <td>Left Leg</td>
                        <td>
                            <input type="text" name="attr_leftLegArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_leftLegAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_leftLegAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_leftLegTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Right Leg -->
                    <tr>
                        <td>Right Leg</td>
                        <td>
                            <input type="text" name="attr_rightLegArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_rightLegAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_rightLegAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_rightLegTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Left Foot -->
                    <tr>
                        <td>Left Foot</td>
                        <td>
                            <input type="text" name="attr_leftFootArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_leftFootAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_leftFootAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_leftFootTotalAV">0</span>
                        </td>
                    </tr>
                    <!-- Right Foot -->
                    <tr>
                        <td>Right Foot</td>
                        <td>
                            <input type="text" name="attr_rightFootArmor" />
                        </td>
                        <td>
                            <input type="number" name="attr_rightFootAV" min="0" value="0" />
                        </td>
                        <td>
                            <span name="attr_rightFootAugmentAV">+0</span>
                        </td>
                        <td>
                            <span name="attr_rightFootTotalAV">0</span>
                        </td>
                    </tr>
                </table>

                <!-- Ammunition -->
                <h2>Ammunition</h2>
                <hr class="sheet-section-separator"/>
                <table class="sheet-ammunition-header">
                    <tr>
                        <th>Ammunition</th>
                        <th>Effect</th>
                        <th>Count</th>
                    </tr>
                </table>
                <fieldset class="repeating_ammunition">
                    <input type="text" name="attr_ammunition_name" placeholder="Ammunition" />
                    <input type="text" name="attr_ammunition_effect" placeholder="Effect" />
                    <input type="number" name="attr_ammunition_count" min="0" value="0" />
                </fieldset>
            </div>

            <div class="sheet-combat-bottom-right">
                <!-- Movement Speed -->
                <div class="sheet-movementspeed">
                    <input type="text" name="attr_movementspeed" />
                    <label>Movement Speed</label>
                </div>

                <!-- Vulnerabilities, Resistances, Immunities -->
                <div>
                    <h2>Vulnerabilities, Resistances, Immunities</h2>
                    <textarea name="attr_vulnerabilitesResistancesImmunities" />
                </div>

                <!-- Conditions -->
                <div>
                    <h2>Conditions</h2>
                    <textarea name="attr_conditions" />
                </div>

                <!-- Shield -->
                <h2>Shield</h2>
                <hr class="sheet-section-separator"/>
                <table class="sheet-shield-header">
                    <tr>
                        <th>Shield</th>
                        <th>Type</th>
                        <th>AV</th>
                    </tr>
                </table>
                <datalist id="shields">
                    <option>Buckler</option>
                    <option>Round Shield</option>
                    <option>Kite Shield</option>
                    <option>Tower Shield</option>
                </datalist>
                <div class="sheet-shield">
                    <input type="text" name="attr_shieldName" list="shields" placeholder="Shield" />
                    <select name="attr_shieldType">
                        <option selected>Light</option>
                        <option>Heavy</option>
                    </select>
                    <input type="text" name="attr_shieldAV" placeholder="AV" />
                </div>

                <!-- Melee Weapons -->
                <h2>Melee Weapons</h2>
                <hr class="sheet-section-separator"/>
                <div class="sheet-unarmedStrike">
                    <span name="unarmedStrike_name">Unarmed Strike</span>
                    <span name="attr_unarmedStrike_atk">+0</span>
                    <span name="attr_unarmedStrike_damage">0 Blunt</span>
                </div>

                <datalist id="meleeWeapons">
                    <option>Brass Knuckle</option>
                    <option>Cestus</option>
                    <option>Knife</option>
                    <option>Dagger</option>
                    <option>Throwing Knife</option>
                    <option>Broadsword</option>
                    <option>Longsword</option>
                    <option>Cutlass</option>
                    <option>Rapier</option>
                    <option>Smallsword</option>
                    <option>Cane Sword</option>
                    <option>Hardened Cane</option>
                    <option>Baton</option>
                    <option>Spiked Club</option>
                    <option>Mace</option>
                    <option>Warhammer</option>
                    <option>War Pick</option>
                    <option>Battle Axe</option>
                    <option>Throwing Axe</option>
                    <option>Hatchet</option>
                    <option>Staff</option>
                    <option>Greatsword</option>
                    <option>Maul</option>
                    <option>Pike</option>
                    <option>Halberd</option>
                    <option>Glaive</option>
                    <option>Whip</option>
                </datalist>

                <fieldset class="repeating_meleeWeapon">
                    <details class="sheet-attack">
                        <summary class="sheet-spoiler0">
                            <span name="attr_meleeWeapon_name">New Weapon</span>
                            <button type="roll" name="roll_meleeWeapon_rollButton" value="@{meleeWeapon_roll}" />
                        </summary>

                        <!-- Name -->
                        <div>
                            <label class="sheet-spell-label">Name:</label>
                            <input type="text" name="attr_meleeWeapon_name" placeholder="Melee Weapon" list="meleeWeapons" />
                        </div>

                        <!-- Skill -->
                        <div>
                            <label class="sheet-spell-label">Skill:</label>
                            <select name="attr_meleeWeapon_skill">
                                <option selected>Brawling</option>
                                <option>Shield</option>
                                <option>One-Handed Melee</option>
                                <option>Two-Handed Melee</option>
                            </select>
                        </div>

                        <!-- To Hit -->
                        <div>
                            <label class="sheet-spell-label">To Hit:</label>
                            <input type="text" name="attr_meleeWeapon_atk" placeholder="To Hit" />
                        </div>

                        <!-- Damage -->
                        <div>
                            <label class="sheet-spell-label">Damage:</label>
                            <input type="text" name="attr_meleeWeapon_damage" placeholder="Damage" />
                        </div>

                        <!-- Weapon Expert -->
                        <div>
                            <label class="sheet-spell-label">Weapon Expert:</label>
                            <input type="checkbox" name="attr_meleeWeapon_weaponExpert" />
                        </div>

                    </details>

                    <input type="hidden" name="attr_meleeWeapon_roll" />
                </fieldset>

                <datalist id="rangedWeapons">
                    <option>Derringer</option>
                    <option>Flintlock Pistol</option>
                    <option>Revolver</option>
                    <option>Pepperbox</option>
                    <option>Flintlock Rifle</option>
                    <option>Blunderbuss</option>
                    <option>Lever-Action Rifle</option>
                    <option>Bolt-Action Rifle</option>
                    <option>Shotgun</option>
                    <option>Hand-Crossbow</option>
                    <option>Crossbow</option>
                    <option>Shortbow</option>
                    <option>Longbow</option>
                    <option>Rocket Launcher</option>
                    <option>Machine Gun (Normal)</option>
                    <option>Machine Gun (Spray)</option>
                    <option>Flamethrower</option>
                    <option>Railgun </option>
                </datalist>

                <!-- Ranged Weapons -->
                <h2>Ranged Weapons</h2>
                <hr class="sheet-section-separator"/>
                <table class="sheet-ranged-header">
                    <tr>
                        <th>Ranged Weapon</th>
                        <th>Range</th>
                        <th>ATK</th>
                        <th>Damage</th>
                        <th>Ammo</th>
                    </tr>
                </table>
                <fieldset class="repeating_rangedWeapon">
                    <details class="sheet-attack">
                        <summary class="sheet-spoiler0">
                            <span name="attr_rangedWeapon_name">New Weapon</span>
                            <button type="roll" name="roll_rangedWeapon_rollButton" value="@{rangedWeapon_roll}" />
                        </summary>

                        <!-- Name -->
                        <div>
                            <label class="sheet-spell-label">Name:</label>
                            <input type="text" name="attr_rangedWeapon_name" placeholder="Ranged Weapon" list="rangedWeapons" />
                        </div>

                        <!-- Skill -->
                        <div>
                            <label class="sheet-spell-label">Skill:</label>
                            <select name="attr_rangedWeapon_skill">
                                <option selected>Artillery</option>
                                <option>Bow</option>
                                <option>Pistol</option>
                                <option>Rifle</option>
                            </select>
                        </div>

                        <!-- To Hit -->
                        <div>
                            <label class="sheet-spell-label">To Hit:</label>
                            <input type="text" name="attr_rangedWeapon_atk" placeholder="To Hit" />
                        </div>

                        <!-- Damage -->
                        <div>
                            <label class="sheet-spell-label">Damage:</label>
                            <input type="text" name="attr_rangedWeapon_damage" placeholder="Damage" />
                        </div>

                        <!-- Weapon Expert -->
                        <div>
                            <label class="sheet-spell-label">Weapon Expert:</label>
                            <input type="checkbox" name="attr_rangedWeapon_weaponExpert" />
                        </div>

                        <!-- Range -->
                        <div>
                            <label class="sheet-spell-label">Range:</label>
                            <input type="text" name="attr_rangedWeapon_range" placeholder="Range" />
                        </div>

                        <!-- Ammo -->
                        <div>
                            <label class="sheet-spell-label">Ammo:</label>
                            <input type="text" name="attr_rangedWeapon_ammo" placeholder="Ammo" />
                        </div>

                        <!-- Quality -->
                        <div>
                            <label class="sheet-spell-label">Quality:</label>
                            <input type="number" name="attr_rangedWeapon_quality" placeholder="Quality" />
                        </div>

                    </details>
                    
                    <input type="hidden" name="attr_rangedWeapon_roll" />
                </fieldset>
            </div>
        </div>
    </div>

    <!-- Qualities -->
    <div class="sheet-qualities sheet-page">
        <h2>Qualities</h2>

        <hr class="sheet-separator"/>

        <div class="sheet-quality-columns">
            <div class="sheet-qualities-positive">
                <h2>Positive</h2>
                <hr class="sheet-section-separator"/>
                
                <datalist id="positiveQualities">
                    <option>Agile</option>
                    <option>Ambidextrous</option>
                    <option>Analytical Mind</option>
                    <option>Educated</option>
                    <option>Eidetic Memory</option>
                    <option>Elemental Attunement (Air)</option>
                    <option>Elemental Attunement (Earth)</option>
                    <option>Elemental Attunement (Fire)</option>
                    <option>Elemental Attunement (Water)</option>
                    <option>Empathetic</option>
                    <option>Essence Sensitivity</option>
                    <option>Fast</option>
                    <option>Pious</option>
                    <option>Quick Reflexes</option>
                    <option>Sniper</option>
                    <option>Sharpshooter</option>
                    <option>Tough</option>
                    <option>Weapon Expert</option>
                    <option>Sneaky</option>
                    <option>Inspiring Presence</option>
                    <option>Strong</option>
                    <option>Silver Tongue</option>
                </datalist>

                <input type="hidden" name="attr_elementalAttunement" />
        
                <fieldset class="repeating_positiveQuality">
                    <input type="text" name="attr_positiveQuality_name" placeholder="Quality" list="positiveQualities" />
                    <input type="number" name="attr_positiveQuality_level" placeholder="Level" min="0" />
                    <textarea name="attr_positiveQuality_description" placeholder="Description" />
                </fieldset>
            </div>
        
            <div class="sheet-qualities-negative">
                <h2>Negative</h2>
                <hr class="sheet-section-separator"/>
                
                <datalist id="negativeQualities">
                    <option>Addict</option>
                    <option>Callous</option>
                    <option>Clumsy</option>
                    <option>Disgraced</option>
                    <option>Dull</option>
                    <option>Essence Vulnerability</option>
                    <option>Farsighted</option>
                    <option>Fragile</option>
                    <option>Hard of Hearing</option>
                    <option>Nearsighted</option>
                    <option>Slow</option>
                    <option>Weak</option>
                    <option>Phobia</option>
                    <option>Socially Inept</option>
                </datalist>
        
                <fieldset class="repeating_negativeQuality">
                    <input type="text" name="attr_negativeQuality_name" placeholder="Quality" list="negativeQualities" />
                    <input type="number" name="attr_negativeQuality_level" placeholder="Level" min="0" />
                    <textarea name="attr_negativeQuality_description" placeholder="Description" />
                </fieldset>
            </div>
        </div>
    </div>

    <!-- Inventory -->
    <div class="sheet-inventory sheet-page">
        <h2>Inventory</h2>

        <hr class="sheet-separator"/>

        <div class="sheet-inventory-topline">
            <div class="sheet-inventory-left">
                <!-- Bolts -->
                <div class="sheet-inventory-material">
                    <label class="sheet-resource-label">Bolts</label>
                    <div class="sheet-resource">
                        <input type="number" name="attr_bolts" min="0" />
                    </div>
                </div>

                <!-- Plates -->
                <div class="sheet-inventory-material">
                    <label class="sheet-resource-label">Plates</label>
                    <div class="sheet-resource">
                        <input type="number" name="attr_plates" min="0" />
                    </div>
                </div>

                <!-- Wires -->
                <div class="sheet-inventory-material">
                    <label class="sheet-resource-label">Wires</label>
                    <div class="sheet-resource">
                        <input type="number" name="attr_wires" min="0" />
                    </div>
                </div>

                <!-- Cogs -->
                <div class="sheet-inventory-material">
                    <label class="sheet-resource-label">Cogs</label>
                    <div class="sheet-resource">
                        <input type="number" name="attr_cogs" min="0" />
                    </div>
                </div>

                <!-- Rods -->
                <div class="sheet-inventory-material">
                    <div class="sheet-resource">
                        <input type="number" name="attr_rods" min="0" />
                    </div>
                    <label class="sheet-resource-label">Rods</label>
                </div>

                <!-- Lenses -->
                <div class="sheet-inventory-material">
                    <div class="sheet-resource">
                        <input type="number" name="attr_lenses" min="0" />
                    </div>
                    <label class="sheet-resource-label">Lenses</label>
                </div>

                <!-- Gunpowder -->
                <div class="sheet-inventory-material">
                    <div class="sheet-resource">
                        <input type="number" name="attr_gunpowder" min="0" />
                    </div>
                    <label class="sheet-resource-label">Gunpowder</label>
                </div>
            </div>

            <div class="sheet-inventory-topline-item">
                <span name="attr_inventory_load">0 Slots</span>
                <hr class="sheet-section-separator"/>
                <label>Load</label>
            </div>
            <div class="sheet-inventory-topline-item">
                <span name="attr_carryCapacity">0 Slots</span>
                <hr class="sheet-section-separator"/>
                <label>Carry<br>Capacity</label>
            </div>

            <!-- Essence -->
            <div class="sheet-inventory-right">
                <!-- Fire Essence -->
                <div class="sheet-inventory-material">
                    <div class="sheet-resource">
                        <input type="number" name="attr_essence_fire" min="0" />
                    </div>
                    <label class="sheet-resource-label">Fire</label>
                </div>

                <!-- Water Essence -->
                <div class="sheet-inventory-material">
                    <div class="sheet-resource">
                        <input type="number" name="attr_essence_water" min="0" />
                    </div>
                    <label class="sheet-resource-label">Water</label>
                </div>

                <!-- Earth Essence -->
                <div class="sheet-inventory-material">
                    <div class="sheet-resource">
                        <input type="number" name="attr_essence_earth" min="0" />
                    </div>
                    <label class="sheet-resource-label">Earth</label>
                </div>

                <!-- Air Essence -->
                <div class="sheet-inventory-material">
                    <div class="sheet-resource">
                        <input type="number" name="attr_essence_air" min="0" />
                    </div>
                    <label class="sheet-resource-label">Air</label>
                </div>
            </div>
        </div>

        <input type="hidden" class="sheet-inventory-tabstoggle" name="attr_inventoryTab" value="equipment" />
        <div>
            <button type="action" name="act_equipment" class="sheet-inventory-button0">Equipment</button>
            <button type="action" name="act_money" class="sheet-inventory-button1">Money</button>
        </div>

        <!-- Equipment -->
        <div class="sheet-inventory-items">
            <div class="sheet-inventory-equipment">
                <h2>Equipment</h2>
                <hr class="sheet-section-separator"/>
                <table class="sheet-equipment-header">
                    <tr>
                        <th>Item</th>
                        <th>Size</th>
                        <th>Count</th>
                        <th>Slots</th>
                    </tr>
                </table>
                <fieldset class="repeating_equipment">
                    <label class="sheet-checkbox-label">Equip</label><input type="checkbox" name="attr_equipment_equip" class="sheet-equip-checkbox" checked />
                    <input type="text" name="attr_equipment_name" placeholder="Item" />
                    <input type="text" name="attr_equipment_size" placeholder="Size" />
                    <input type="number" name="attr_equipment_count" placeholder="Count" min="0" />
                    <span name="attr_equipment_slots">0</span>
                </fieldset>
            </div>

            <datalist id="containers">
                <option>Backpack</option>
                <option>Travel Pack</option>
                <option>Shoulder Bag</option>
            </datalist>
            
            <!-- Equipped Container -->
            <div class="sheet-inventory-back">
                <h2>Equipped Container</h2>
                <hr class="sheet-section-separator"/>
                <table class="sheet-back-header">
                    <tr>
                        <th>Container</th>
                        <th>Size</th>
                        <th>Cap</th>
                        <th>Load</th>
                    </tr>
                </table>
                <div class="sheet-back-container">
                    <label class="sheet-checkbox-label">Equip</label><input type="checkbox" name="attr_containerBack_equip" class="sheet-equip-checkbox" checked />
                    <input type="text" name="attr_containerBack_name" list="containers" />
                    <input type="text" name="attr_containerBack_size" />
                    <input type="number" name="attr_containerBack_capacity" />
                    <span name="attr_containerBack_load">0</span>
                </div>

                <table class="sheet-back-header">
                    <tr>
                        <th>Item</th>
                        <th>Size</th>
                        <th>Count</th>
                        <th>Slots</th>
                    </tr>
                </table>
                <fieldset class="repeating_backItem">
                    <input type="text" name="attr_backItem_name" placeholder="Item" />
                    <input type="text" name="attr_backItem_size" placeholder="Size" />
                    <input type="number" name="attr_backItem_count" placeholder="Count" min="0" />
                    <span name="attr_backItem_slots">0</span>
                </fieldset>
            </div>
        </div>

        <!-- Money -->
        <div class="sheet-inventory-money">
            <h2>Money</h2>
            <hr class="sheet-section-separator" />

            <div class="sheet-money-row">
                <input type="number" name="attr_imperialPounds" min="0" value="0" />
                <span class="sheet-currency-symbol">Â£</span>
                <input type="number" name="attr_imperialShillings" min="0" value="0" />
                <span class="sheet-currency-symbol">s</span>
                <input type="number" name="attr_imperialPence" min="0" value="0" />
                <span class="sheet-currency-symbol">d</span>
                <input type="number" name="attr_imperialFarthings" min="0" value="0" />
                <span class="sheet-currency-symbol">f</span>
            </div>

            <h2>Debt</h2>
            <hr class="sheet-section-separator" />
            <fieldset class="repeating_debt">
                <input type="text" name="attr_debt_creditor" placeholder="Creditor" />
                <input type="text" name="attr_debt_dueBy" placeholder="due by" />
                <div class="sheet-money-row">
                    <input type="number" name="attr_debt_imperialPounds" min="0" value="0" />
                    <span class="sheet-currency-symbol">Â£</span>
                    <input type="number" name="attr_debt_imperialShillings" min="0" value="0" />
                    <span class="sheet-currency-symbol">s</span>
                    <input type="number" name="attr_debt_imperialPence" min="0" value="0" />
                    <span class="sheet-currency-symbol">d</span>
                    <input type="number" name="attr_debt_imperialFarthings" min="0" value="0" />
                    <span class="sheet-currency-symbol">f</span>
                </div>
            </fieldset>
        </div>
    </div>

    <!-- Prayer -->
    <div class="sheet-prayer sheet-page">
        <h2>Prayer</h2>

        <hr class="sheet-separator"/>

        <div class="sheet-prayer-topline">
            <!-- Faith -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" min="0" name="attr_faith" value="0"/>
                    <span name="attr_faith_max">0</span>
                </div>
                <label class="sheet-resource-label">Faith</label>
                <span class="sheet-resource-calculation">Willpower Ã— Prayer</span>
            </div>

            <!-- Healing -->
            <div class="sheet-item">
                <button type="action" name="act_healing" class="sheet-rollable-mod">
                    <span name="attr_healing"></span>
                </button>
                <label class="sheet-resource-label">Healing</label>
                <span class="sheet-resource-calculation">Xd6 + Prayer</span>
            </div>

            <!-- Power -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <span name="attr_prayer">0</span>
                </div>
                <label class="sheet-resource-label">Power</label>
            </div>
        </div>

        <hr class="sheet-separator"/>

        <div class="sheet-prayer-bottom">
            <h2>Blessings</h2>
            <div class="sheet-spells-memorised">
                <span>Memorised:</span>
                <span name="attr_memorisedBlessings">0</span>
                <span>/</span>
                <span name="attr_memorisedBlessings_max">0</span>
            </div>
            <hr class="sheet-section-separator"/>

            <datalist id="blessings">
                <option>Blessing of Regeneration</option>
                <option>Blessing of Protection</option>
                <option>Blessing of Haste</option>
                <option>Blessing of Attention</option>
                <option>Blessing of Burden</option>
                <option>Blessing of Warding off Evil</option>
                <option>Blessing of Sanctity</option>
                <option>Blessing of Purification</option>
                <option>Blessing of Health</option>
                <option>Blessing of Wound Closure</option>
                <option>Blessing of Guidance</option>
                <option>Blessing of Smiting</option>
                <option>Blessing of Comprehension</option>
                <option>Blessing of Comfort</option>
            </datalist>
            
            <fieldset class="repeating_blessing">
                <details>
                    <summary class="sheet-spoiler0">
                        <span name="attr_blessing_name">New Blessing</span>
                        <button type="action" name="act_blessinginvoke">Invoke</button>
                        <div>
                            <label class="sheet-spell-label">Memorised</label>
                            <input type="checkbox" name="attr_blessing_memorised" />
                        </div>
                    </summary>

                    <!-- Name -->
                    <div>
                        <label class="sheet-spell-label">Name:</label>
                        <input type="text" name="attr_blessing_name" placeholder="Blessing" list="blessings" />
                    </div>
                    <!-- Components -->
                    <div>
                        <label class="sheet-spell-label">Components:</label>
                        <input type="text" name="attr_blessing_components" placeholder="Components" />
                    </div>
                    <!-- Faith -->
                    <div>
                        <label class="sheet-spell-label">Faith:</label>
                        <input type="number" name="attr_blessing_faith" placeholder="Faith" min="0" />
                    </div>
                    <!-- Range -->
                    <div>
                        <label class="sheet-spell-label">Range:</label>
                        <input type="text" name="attr_blessing_range" placeholder="Range" />
                    </div>
                    <!-- Area -->
                    <div>
                        <label class="sheet-spell-label">Area:</label>
                        <input type="text" name="attr_blessing_area" placeholder="Area" />
                    </div>
                    <!-- Duration -->
                    <div>
                        <label class="sheet-spell-label">Duration:</label>
                        <input type="text" name="attr_blessing_duration" placeholder="Duration" />
                    </div>
                    
                    <textarea name="attr_blessing_description" placeholder="Description" />
                </details>
            </fieldset>
        </div>
    </div>

    <!-- Witchcraft -->
    <div class="sheet-witchcraft sheet-page">
        <h2>Witchcraft</h2>
        <hr class="sheet-separator"/>

        <div class="sheet-witchcraft-topline">
            <!-- Spellwork -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <span name="attr_spellwork">0</span>
                </div>
                <label class="sheet-resource-label">Spellwork</label>
            </div>

            <!-- SRD -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <span name="attr_srd">0</span>
                </div>
                <label class="sheet-resource-label">SRD</label>
            </div>

            <!-- Runecraft -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <span name="attr_runecraft">0</span>
                </div>
                <label class="sheet-resource-label">Runecraft</label>
            </div>

            <!-- Fire Essence -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_essence_fire" min="0" />
                </div>
                <label class="sheet-resource-label">Fire</label>
            </div>

            <!-- Water Essence -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_essence_water" min="0" />
                </div>
                <label class="sheet-resource-label">Water</label>
            </div>

            <!-- Earth Essence -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_essence_earth" min="0" />
                </div>
                <label class="sheet-resource-label">Earth</label>
            </div>

            <!-- Air Essence -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_essence_air" min="0" />
                </div>
                <label class="sheet-resource-label">Air</label>
            </div>
        </div>

        <hr class="sheet-separator"/>

        <div class="sheet-witchcraft-bottom">
            <input type="hidden" class="sheet-witchcraft-tabstoggle" name="attr_witchcraftTab" value="runes" />
            <div>
                <button type="action" name="act_runes" class="sheet-witchcraft-button0">Runes</button>
                <button type="action" name="act_rituals" class="sheet-witchcraft-button1">Rituals</button>
                <button type="action" name="act_spells" class="sheet-witchcraft-button2">Spells</button>
                <button type="action" name="act_curses" class="sheet-witchcraft-button3">Curses</button>
            </div>

            <!-- Runes -->
            <div class="sheet-witchcraft-runes">
                <h2>Runes</h2>
                <hr class="sheet-section-separator"/>
        
                <datalist id="runes">
                    <option>Calidum</option>
                    <option>Frigus</option>
                    <option>Reparo</option>
                    <option>Sano</option>
                    <option>Conservo</option>
                    <option>Respiratio</option>
                    <option>Purgo</option>
                    <option>Levis</option>
                    <option>Gravis</option>
                    <option>Sera</option>
                    <option>Mundo</option>
                    <option>Protego</option>
                    <option>Silentium</option>
                    <option>Damnum</option>
                    <option>Clypeus Cordis</option>
                    <option>Radians</option>
                    <option>Supprimo</option>
                    <option>Visio Obscura</option>
                    <option>Vita Surripuit</option>
                    <option>Auge Salus</option>
                </datalist>
                
                <fieldset class="repeating_rune">
                    <details>
                        <summary class="sheet-spoiler0">
                            <span name="attr_rune_name">New Rune</span>
                        </summary>

                        <!-- Name -->
                        <div>
                            <label class="sheet-spell-label">Name:</label>
                            <input type="text" name="attr_rune_name" placeholder="Rune" list="runes" />
                        </div>
                        <!-- Target -->
                        <div>
                            <label class="sheet-spell-label">Target:</label>
                            <input type="text" name="attr_rune_target" placeholder="Target" />
                        </div>
                        <!-- Natura -->
                        <div>
                            <label class="sheet-spell-label">Natura:</label>
                            <input type="text" name="attr_rune_natura" placeholder="Natura" />
                        </div>

                        <textarea name="attr_rune_description" placeholder="Description" />
                    </details>
                </fieldset>
            </div>

            <!-- Rituals -->
            <div class="sheet-witchcraft-rituals">
                <h2>Rituals</h2>
                <hr class="sheet-section-separator"/>
        
                <datalist id="rituals">
                    <option>Scrying</option>
                    <option>Nightvision</option>
                    <option>Water Breathing</option>
                    <option>Warming</option>
                    <option>Cooling</option>
                    <option>Beauty</option>
                    <option>Disguise</option>
                    <option>Locate</option>
                    <option>Astral Projection</option>
                    <option>Dreamwalk</option>
                    <option>Identify</option>
                    <option>Divination Warding</option>
                    <option>Spirit Warding</option>
                    <option>Monster Warding</option>
                    <option>Death Warding</option>
                    <option>[Damage Type] Warding</option>
                    <option>Open Portal</option>
                    <option>Blade Bond</option>
                    <option>Bought Time</option>
                </datalist>
                
                <fieldset class="repeating_ritual">
                    <details>
                        <summary class="sheet-spoiler0">
                            <span name="attr_ritual_name">New Ritual</span>
                        </summary>

                        <!-- Name -->
                        <div>
                            <label class="sheet-spell-label">Name:</label>
                            <input type="text" name="attr_ritual_name" placeholder="Ritual" list="rituals" />
                        </div>
                        <!-- Natura -->
                        <div>
                            <label class="sheet-spell-label">Natura:</label>
                            <input type="text" name="attr_ritual_essence" placeholder="Essence" />
                        </div>

                        <textarea name="attr_ritual_description" placeholder="Description" />
                    </details>
                </fieldset>
            </div>

            <!-- Spells -->
            <div class="sheet-witchcraft-spells">
                <h2>Spells</h2>
                <div class="sheet-spells-memorised">
                    <span>Memorised:</span>
                    <span name="attr_memorisedSpells">0</span>
                    <span>/</span>
                    <span name="attr_memorisedSpells_max">0</span>
                </div>
                <hr class="sheet-section-separator"/>
        
                <datalist id="spells">
                    <option>Fire Bolt</option>
                    <option>Fireball</option>
                    <option>Water Bolt</option>
                    <option>Waterball</option>
                    <option>Tremor</option>
                    <option>Earthquake</option>
                    <option>Air Bolt</option>
                    <option>Air Bomb</option>
                    <option>Icicle</option>
                    <option>Lava Mote</option>
                    <option>Spark</option>
                    <option>Steam Cloud</option>
                    <option>Acid Splash</option>
                    <option>Acid Rain</option>
                    <option>Dust Cloud</option>
                    <option>Break Warding</option>
                    <option>Levitate</option>
                    <option>Unlock</option>
                    <option>Deflect</option>
                    <option>Reflect</option>
                    <option>Control Fire</option>
                    <option>Control Water</option>
                    <option>Blink</option>
                    <option>Group Blink</option>
                    <option>Teleport</option>
                    <option>Group Teleport</option>
                    <option>Glow</option>
                    <option>Hex</option>
                    <option>Stupor</option>
                    <option>Mindlink</option>
                    <option>Silence</option>
                    <option>Restrain</option>
                    <option>Chain Pull</option>
                    <option>Air Bubble</option>
                    <option>Command</option>
                    <option>Enthrall</option>
                    <option>Clean</option>
                    <option>Ignite</option>
                </datalist>
                
                <fieldset class="repeating_spell">
                    <details>
                        <summary class="sheet-spoiler0">
                            <span name="attr_spell_name">New Spell</span>
                            <button type="action" name="act_spellcast">Cast</button>
                            <div>
                                <label class="sheet-spell-label">Memorised</label>
                                <input type="checkbox" name="attr_spell_memorised" />
                            </div>
                            <span class="error" name="attr_spell_error"></span>
                        </summary>

                        <!-- Name -->
                        <div>
                            <label class="sheet-spell-label">Name:</label>
                            <input type="text" name="attr_spell_name" placeholder="Spell" list="spells" />
                        </div>
                        <!-- Action -->
                        <div>
                            <label class="sheet-spell-label">Action:</label>
                            <select name="attr_spell_action">
                                <option selected>Major Action</option>
                                <option>Minor Action</option>
                                <option>Major Reaction</option>
                                <option>Minor Reaction</option>
                            </select>
                        </div>
                        <!-- Components -->
                        <div>
                            <label class="sheet-spell-label">Components:</label>
                            <input type="text" name="attr_spell_components" placeholder="Components" />
                        </div>
                        <!-- Natura -->
                        <div>
                            <label class="sheet-spell-label">Natura:</label>
                            <input type="text" name="attr_spell_natura" placeholder="Natura" />
                        </div>
                        <!-- Range -->
                        <div>
                            <label class="sheet-spell-label">Range:</label>
                            <input type="text" name="attr_spell_range" placeholder="Range" />
                        </div>
                        <!-- Area -->
                        <div>
                            <label class="sheet-spell-label">Area:</label>
                            <input type="text" name="attr_spell_area" placeholder="Area" />
                        </div>
                        <!-- Duration -->
                        <div>
                            <label class="sheet-spell-label">Duration:</label>
                            <input type="text" name="attr_spell_duration" placeholder="Duration" />
                        </div>
                        <!-- Attack -->
                        <div>
                            <label class="sheet-spell-label">Attack:</label>
                            <select class="feature-attack-type" name="attr_spell_attackType">
                                <option value="none" selected>-</option>
                                <option>Melee</option>
                                <option>Ranged</option>
                            </select>
                        </div>
                        <!-- Save -->
                        <div>
                            <label class="sheet-spell-label">Save:</label>
                            <select class="feature-save-type" name="attr_spell_saveType">
                                <option value="none" selected>-</option>
                                <option>Evasion</option>
                                <option>Body</option>
                                <option>Willpower</option>
                            </select>
                        </div>
                        <!-- Save DT Type -->
                        <div class="feature-save-details">
                            <label class="sheet-spell-label"></label>
                            <select class="feature-save-dttype" name="attr_spell_saveDTType">
                                <option value="srd" selected>SRD</option>
                                <option value="dt">DT</option>
                                <option value="contest">Contest</option>
                            </select>
                        </div>
                        <!-- Save DT -->
                        <div class="feature-save-details feature-save-dt">
                            <label class="sheet-spell-label"></label>
                            <div>
                                <select name="attr_spell_saveDTSkill">
                                    <option selected>-</option>
                                    <option>Athletics</option>
                                    <option>Perception</option>
                                    <option>Piloting</option>
                                    <option>Stealth</option>
                                    <option>Artisanship</option>
                                    <option>Deception</option>
                                    <option>Intimidation</option>
                                    <option>Performance</option>
                                    <option>Persuasion</option>
                                    <option>Astronomy</option>
                                    <option>Economy</option>
                                    <option>History</option>
                                    <option>Literature</option>
                                    <option>Medicine</option>
                                    <option>Mythology</option>
                                    <option>Nature</option>
                                    <option>Survival</option>
                                    <option>Clockwork Mechanics</option>
                                    <option>Automachinery</option>
                                    <option>Augmentation</option>
                                    <option>Gunsmithing</option>
                                    <option>Tinkering</option>
                                    <option>Vehicle Mechanics</option>
                                    <option>Alchemy</option>
                                    <option>Prayer</option>
                                    <option>Spellwork</option>
                                    <option>Runecraft</option>
                                    <option>Summoning</option>
                                    <option>Artillery</option>
                                    <option>Brawling</option>
                                    <option>Bow</option>
                                    <option>Pistol</option>
                                    <option>Rifle</option>
                                    <option>Shield</option>
                                    <option>One-Handed Melee</option>
                                    <option>Two-Handed Melee</option>
                                </select>
                                <select name="attr_spell_saveDTAttribute">
                                    <option selected>-</option>
                                    <option>Agility</option>
                                    <option>Body</option>
                                    <option>Charisma</option>
                                    <option>Intuition</option>
                                    <option>Logic</option>
                                    <option>Willpower</option>
                                </select>
                                <input type="number" name="attr_spell_saveDTBonus" placeholder="+0" />
                                &nbsp;=&nbsp;
                                <span name="attr_spell_saveDT">0</span>
                            </div>
                        </div>
                        <!-- Damage -->
                        <div>
                            <label class="sheet-spell-label">Damage:</label>
                            <input type="text" name="attr_spell_damage" placeholder="Damage" />
                        </div>
                        
                        <textarea name="attr_spell_description" placeholder="Description" />
                    </details>
                </fieldset>
            </div>

            <!-- Curses -->
            <div class="sheet-witchcraft-curses">
                <h2>Curses</h2>
                <hr class="sheet-section-separator"/>
        
                <datalist id="curses">
                    <option>Lycanthropy</option>
                    <option>Bad Luck</option>
                    <option>Eternal Nightmares</option>
                    <option>Rusting Decay</option>
                    <option>Forked Tongue</option>
                    <option>Shattered Fate</option>
                    <option>Gluttony</option>
                    <option>Stolen Voice</option>
                    <option>Grasping Roots</option>
                    <option>Sanguine Seal</option>
                </datalist>
                
                <fieldset class="repeating_curse">
                    <details>
                        <summary class="sheet-spoiler0">
                            <span name="attr_curse_name">New Curse</span>
                        </summary>

                        <!-- Name -->
                        <div>
                            <label class="sheet-spell-label">Name:</label>
                            <input type="text" name="attr_curse_name" placeholder="Curse" list="curses" />
                        </div>
                        <!-- Natura -->
                        <div>
                            <label class="sheet-spell-label">Natura:</label>
                            <input type="text" name="attr_curse_natura" placeholder="Natura" />
                        </div>
                        <!-- Target -->
                        <div>
                            <label class="sheet-spell-label">Target:</label>
                            <input type="text" name="attr_curse_target" placeholder="Target" />
                        </div>

                        <details>
                            <summary class="sheet-spoiler1">
                                <span>Sacrifice</span>
                            </summary>
                            <textarea name="attr_curse_sacrifice" placeholder="Sacrifice" />
                        </details>

                        <details>
                            <summary class="sheet-spoiler1">
                                <span>Description</span>
                            </summary>
                            <textarea name="attr_curse_description" placeholder="Description" />
                        </details>

                        <details>
                            <summary class="sheet-spoiler1">
                                <span>Breaking Condition</span>
                            </summary>
                            <textarea name="attr_curse_breakingCondition" placeholder="Breaking Condition" />
                        </details>
                    </details>
                </fieldset>
            </div>
        </div>
    </div>

    <!-- Alchemy -->
    <div class="sheet-alchemy sheet-page">
        <h2>Alchemy</h2>
        <hr class="sheet-separator"/>

        <div class="sheet-alchemy-topline">
            <!-- Potency -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <span name="attr_alchemy">0</span>
                </div>
                <label class="sheet-resource-label">Potency</label>
            </div>

            <!-- Fire Essence -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_essence_fire" min="0" />
                </div>
                <label class="sheet-resource-label">Fire</label>
            </div>

            <!-- Water Essence -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_essence_water" min="0" />
                </div>
                <label class="sheet-resource-label">Water</label>
            </div>

            <!-- Earth Essence -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_essence_earth" min="0" />
                </div>
                <label class="sheet-resource-label">Earth</label>
            </div>

            <!-- Air Essence -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_essence_air" min="0" />
                </div>
                <label class="sheet-resource-label">Air</label>
            </div>
        </div>
        
        <hr class="sheet-separator"/>

        <div class="sheet-alchemy-bottom">
            <input type="hidden" class="sheet-alchemy-tabstoggle" name="attr_alchemyTab" value="elixirs" />
            <div>
                <button type="action" name="act_elixirs" class="sheet-alchemy-button0">Elixirs</button>
                <button type="action" name="act_potions" class="sheet-alchemy-button1">Potions</button>
                <button type="action" name="act_infusions" class="sheet-alchemy-button2">Infusions</button>
            </div>

            <!-- Elixirs -->
            <div class="sheet-alchemy-elixirs">
                <h2>Elixirs</h2>
                <hr class="sheet-section-separator"/>
                
                <div class="sheet-elixir">
                    <h3>Gunpowder</h3>
                    <div><label>Essence:</label><span>1 Fire, 1 Earth</span></div>
                    <span>For the crafting process, gunpowder is considered an elixir and 100g of Gunpowder (or 1G in every blueprint) costs 1 Fire essence and 1 Earth essence to make.</span>
                </div>
                <div class="sheet-elixir">
                    <h3>Vita</h3>
                    <div><label>Essence:</label><span>1 Water, 1 Fire, 1 Earth, 1 Air</span></div>
                    <span>Restores [P] health points to a creature with 0 health points that isnâ€™t dead.</span>
                </div>
                <div class="sheet-elixir">
                    <h3>Cura</h3>
                    <div><label>Essence:</label><span>2 Water, 2 Earth</span></div>
                    <span>Cures [P] stacks of poison.</span>
                </div>
                <div class="sheet-elixir">
                    <h3>Velocitas</h3>
                    <div><label>Essence:</label><span>2 Fire, 3 Air</span></div>
                    <span>Grants +1 Minor Action until the start of your next turn.</span>
                </div>
                <div class="sheet-elixir">
                    <h3>Arma</h3>
                    <div><label>Essence:</label><span>5 Earth</span></div>
                    <span>Adds [P] to your Default Armor Value until the start of your next turn.</span>
                </div>
                <div class="sheet-elixir">
                    <h3>Lumos</h3>
                    <div><label>Essence:</label><span>3 Fire</span></div>
                    <span>When activated, it shines brightly in a 20m radius for [P] hours and is consumed at the end of that duration.</span>
                </div>
                <div class="sheet-elixir">
                    <h3>Acidum</h3>
                    <div><label>Essence:</label><span>1 Water, 3 Fire, 2 Air</span></div>
                    <span>When applied to an object or creature, it takes [P] acid damage, shredding the same amount of armor.</span>
                </div>
                <div class="sheet-elixir">
                    <h3>Baculum</h3>
                    <div><label>Essence:</label><span>2 Water, 2 Earth</span></div>
                    <span>Can be used as a powerful glue that requires a successful Body test against 15 + [P] or 10 + [P] acid damage to break it.</span>
                </div>
            </div>

            <!-- Potions -->
            <div class="sheet-alchemy-potions">
                <h2>Potions</h2>
                <hr class="sheet-section-separator"/>
        
                <datalist id="potions">
                    <option>Healing</option>
                    <option>Cleansing</option>
                    <option>Haste</option>
                    <option>Restoration</option>
                    <option>Water Breathing</option>
                    <option>Flight</option>
                    <option>Charm</option>
                    <option>Muscle</option>
                    <option>Fire Immunity</option>
                    <option>Lightning Immunity</option>
                    <option>Acid Immunity</option>
                    <option>Poison Immunity</option>
                    <option>Hardening</option>
                    <option>Night Vision</option>
                    <option>Explosion</option>
                    <option>Last Stand</option>
                    <option>Wound Closure</option>
                </datalist>
                
                <fieldset class="repeating_potion">
                    <details>
                        <summary class="sheet-spoiler0">
                            <span name="attr_potion_name">New Potion</span>
                        </summary>

                        <!-- Name -->
                        <div>
                            <label class="sheet-spell-label">Name:</label>
                            <input type="text" name="attr_potion_name" placeholder="Potion" list="potions" />
                        </div>
                        <!-- Essence -->
                        <div>
                            <label class="sheet-spell-label">Essence:</label>
                            <input type="text" name="attr_potion_essence" placeholder="Essence" />
                        </div>

                        <textarea name="attr_potion_effect" placeholder="Effect" />
                    </details>
                </fieldset>
            </div>

            <!-- Infusions -->
            <div class="sheet-alchemy-infusions">
                <h2>Infusions</h2>
                <hr class="sheet-section-separator"/>
                <span>Infusions will be added soon.</span>
            </div>
        </div>
    </div>

    <!-- Clockwork Mechanics -->
    <div class="sheet-clockwork-mechanics sheet-page">
        <h2>Clockwork Mechanics</h2>
        <hr class="sheet-separator"/>

        <div class="sheet-clockwork-mechanics-topline">
            <!-- Quality -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <span name="attr_clockworkmechanics">0</span>
                </div>
                <label class="sheet-resource-label">Quality</label>
            </div>

            <!-- Bolts -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_bolts" min="0" />
                </div>
                <label class="sheet-resource-label">Bolts</label>
            </div>

            <!-- Plates -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_plates" min="0" />
                </div>
                <label class="sheet-resource-label">Plates</label>
            </div>

            <!-- Wires -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_wires" min="0" />
                </div>
                <label class="sheet-resource-label">Wires</label>
            </div>

            <!-- Cogs -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_cogs" min="0" />
                </div>
                <label class="sheet-resource-label">Cogs</label>
            </div>

            <!-- Rods -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_rods" min="0" />
                </div>
                <label class="sheet-resource-label">Rods</label>
            </div>

            <!-- Lenses -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_lenses" min="0" />
                </div>
                <label class="sheet-resource-label">Lenses</label>
            </div>
        </div>
        
        <hr class="sheet-separator"/>

        <div class="sheet-clockwork-mechanics-bottom">
            <input type="hidden" class="sheet-clockwork-mechanics-tabstoggle" name="attr_clockworkMechanicsTab" value="blueprints" />
            <div>
                <button type="action" name="act_blueprints" class="sheet-clockwork-mechanics-button0">Blueprints</button>
                <button type="action" name="act_automatons" class="sheet-clockwork-mechanics-button1">Automatons</button>
                <button type="action" name="act_artificing" class="sheet-clockwork-mechanics-button2">Artificing</button>
            </div>

            <!-- Blueprints -->
            <div class="sheet-clockwork-mechanics-blueprints">
                <h2>Blueprints</h2>
                <hr class="sheet-section-separator"/>
                
                <fieldset class="repeating_blueprint">
                    <input type="text" name="attr_blueprint_name" placeholder="Blueprint" />
                    <select name="attr_blueprint_type" class="sheet-blueprint-type">
                        <option value="clockwork" selected>Clockwork</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                        <option value="automaton">Automaton</option>
                        <option value="automaton module">Automaton Module</option>
                        <option value="clockwork module">Clockwork Module</option>
                        <option value="automech">Automech</option>
                    </select>
                    <input type="text" name="attr_blueprint_parts" placeholder="Parts" />
                    <div class="sheet-blueprint-clockwork">
                        <label>Remote Controlled</label>
                        <input type="checkbox" name="attr_blueprint_remoteControlled" />
                    </div>
                    <div class="sheet-blueprint-automaton">
                        <table class="sheet-blueprint-automaton-headers">
                            <tr>
                                <th>Chassis</th>
                                <th>Movement Parts</th>
                            </tr>
                        </table>
                    </div>
                    <div class="sheet-blueprint-automaton">
                        <select name="attr_blueprint_automatonChassis" class="sheet-blueprint-automaton-chassis">
                            <option value="small" selected>Small</option>
                            <option value="medium">Medium</option>
                            <option value="large">Large</option>
                        </select>
                        <select name="attr_blueprint_movementPart1">
                            <option>None</option>
                            <option>Legs</option>
                            <option>Wheels</option>
                            <option>Wings</option>
                            <option>Propellers (Swimming)</option>
                            <option>Propellers (Flying)</option>
                            <option>Fins</option>
                        </select>
                        <select name="attr_blueprint_movementPart2" class="sheet-blueprint-automaton-medium sheet-blueprint-automaton-large">
                            <option>None</option>
                            <option>Legs</option>
                            <option>Wheels</option>
                            <option>Wings</option>
                            <option>Propellers (Swimming)</option>
                            <option>Propellers (Flying)</option>
                            <option>Fins</option>
                        </select>
                        <select name="attr_blueprint_movementPart3" class="sheet-blueprint-automaton-large">
                            <option>None</option>
                            <option>Legs</option>
                            <option>Wheels</option>
                            <option>Wings</option>
                            <option>Propellers (Swimming)</option>
                            <option>Propellers (Flying)</option>
                            <option>Fins</option>
                        </select>
                    </div>
                    <div class="sheet-blueprint-autolimb sheet-blueprint-prosthetic">
                        <select name="attr_blueprint_limb">
                            <option value="arm" selected>Arm</option>
                            <option value="leg">Leg</option>
                            <option value="hand">Hand</option>
                            <option value="foot">Foot</option>
                            <option value="ear">Ear</option>
                            <option value="eye">Eye</option>
                            <option value="nose">Nose</option>
                            <option value="jaw">Jaw</option>
                        </select>
                    </div>
                    <div class="sheet-blueprint-automaton sheet-blueprint-prosthetic sheet-blueprint-autolimb">
                        <label>Min. CR:</label>
                        <span name="attr_blueprint_minCR">0</span>
                    </div>
                    <div class="sheet-blueprint-clockwork sheet-blueprint-automech">
                        <label>Min. CR:</label>
                        <input type="number" name="attr_blueprint_minCR" placeholder="min. CR" min="0" />
                    </div>
                    <textarea name="attr_blueprint_description" placeholder="Description" />
                </fieldset>
            </div>

            <!-- Automatons -->
            <div class="sheet-clockwork-mechanics-automatons">
                <h2>Automatons</h2>
                <hr class="sheet-section-separator"/>
                <fieldset class="repeating_automaton">
                    <!-- Name & Quality-->
                    <div>
                        <div class="sheet-rep-item">
                            <input type="text" name="attr_automaton_name" placeholder="Name" class="sheet-rep-data" />
                            <label class="sheet-rep-label">Name</label>
                        </div>
                        <div class="sheet-rep-item">
                            <input type="number" name="attr_automaton_quality" min="0" value="0" class="sheet-rep-data" />
                            <label class="sheet-rep-label">Quality</label>
                        </div>
                    </div>
                    <!-- Size & Movement Parts -->
                    <div>
                        <div class="sheet-rep-item">
                            <select name="attr_automaton_chassis" class="sheet-rep-data sheet-blueprint-automaton-chassis">
                                <option value="small" selected>Small</option>
                                <option value="medium">Medium</option>
                                <option value="large">Large</option>
                            </select>
                            <label class="sheet-rep-label">Size</label>
                        </div>
                        <div class="sheet-rep-item">
                            <select name="attr_automaton_movementPart1" class="sheet-rep-data">
                                <option>None</option>
                                <option>Legs</option>
                                <option>Wheels</option>
                                <option>Wings</option>
                                <option>Propellers (Swimming)</option>
                                <option>Propellers (Flying)</option>
                                <option>Fins</option>
                            </select>
                            <label class="sheet-rep-label">Movement Part</label>
                        </div>
                        <div class="sheet-rep-item sheet-blueprint-automaton-medium sheet-blueprint-automaton-large">
                            <select name="attr_automaton_movementPart2" class="sheet-rep-data">
                                <option>None</option>
                                <option>Legs</option>
                                <option>Wheels</option>
                                <option>Wings</option>
                                <option>Propellers (Swimming)</option>
                                <option>Propellers (Flying)</option>
                                <option>Fins</option>
                            </select>
                            <label class="sheet-rep-label">Movement Part</label>
                        </div>
                        <div class="sheet-rep-item sheet-blueprint-automaton-large">
                            <select name="attr_automaton_movementPart3" class="sheet-rep-data">
                                <option>None</option>
                                <option>Legs</option>
                                <option>Wheels</option>
                                <option>Wings</option>
                                <option>Propellers (Swimming)</option>
                                <option>Propellers (Flying)</option>
                                <option>Fins</option>
                            </select>
                            <label class="sheet-rep-label">Movement Part</label>
                        </div>
                    </div>
                    <!-- Plating -->
                    <div>
                        <div class="sheet-rep-item">
                            <select name="attr_automaton_plating" class="sheet-rep-data">
                                <option value="none" selected>None</option>
                                <option value="aluminium">Aluminium</option>
                                <option value="copper">Copper</option>
                                <option value="steel">Steel</option>
                                <option value="ceramic">Ceramic</option>
                                <option value="titanium">Titanium</option>
                            </select>
                            <label class="sheet-rep-label">Plating</label>
                        </div>
                        <!-- DAV -->
                        <div class="sheet-rep-item">
                            <span name="attr_automaton_dav">0</span>
                            <label class="sheet-rep-label">DAV</label>
                        </div>
                    </div>
                    <!-- Stats -->
                    <div>
                        <!-- HP -->
                        <div class="sheet-rep-item">
                            <div class="sheet-rep-currentMax">
                                <input type="number" min="0" value="0" name="attr_automaton_hp" class="sheet-rep-data" />
                                <span>/</span>
                                <span name="attr_automaton_hp_max">0</span>
                            </div>
                            <label class="sheet-rep-label">HP</label>
                        </div>
                        <!-- CR -->
                        <div class="sheet-rep-item">
                            <span name="attr_automaton_coreRating">0</span>
                            <label class="sheet-rep-label">CR</label>
                        </div>
                        <!-- Modules -->
                        <div class="sheet-rep-item">
                            <div class="sheet-rep-currentMax">
                                <span name="attr_automaton_modules">0</span>
                                <span>/</span>
                                <span name="attr_automaton_modules_max">0</span>
                            </div>
                            <label class="sheet-rep-label">Modules</label>
                        </div>
                    </div>
                </fieldset>
            </div>

            <!-- Artificing -->
            <div class="sheet-clockwork-mechanics-artificing">
                <h2>Artificing</h2>
                <hr class="sheet-section-separator"/>
            </div>
        </div>
    </div>
    
    <!-- Augmentations -->
    <div class="sheet-augmentations sheet-page">
        <h2>Augmentations</h2>
        <hr class="sheet-separator"/>

        <div class="sheet-clockwork-mechanics-topline">
            <!-- Quality -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <span name="attr_augmentation">0</span>
                </div>
                <label class="sheet-resource-label">Quality</label>
            </div>

            <!-- Bolts -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_bolts" min="0" />
                </div>
                <label class="sheet-resource-label">Bolts</label>
            </div>

            <!-- Plates -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_plates" min="0" />
                </div>
                <label class="sheet-resource-label">Plates</label>
            </div>

            <!-- Wires -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_wires" min="0" />
                </div>
                <label class="sheet-resource-label">Wires</label>
            </div>

            <!-- Cogs -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_cogs" min="0" />
                </div>
                <label class="sheet-resource-label">Cogs</label>
            </div>

            <!-- Rods -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_rods" min="0" />
                </div>
                <label class="sheet-resource-label">Rods</label>
            </div>

            <!-- Lenses -->
            <div class="sheet-item">
                <div class="sheet-resource">
                    <input type="number" name="attr_lenses" min="0" />
                </div>
                <label class="sheet-resource-label">Lenses</label>
            </div>
        </div>
        
        <hr class="sheet-separator"/>

        <div class="sheet-clockwork-mechanics-bottom sheet-augmentations-bottom">
            <!-- Head -->
            <details>
                <summary class="sheet-spoiler0">Head</summary>

                <select name="attr_augmentations_head">
                    <option selected>None</option>
                    <option value="prosthetic">Prosthetic</option>
                    <option value="autolimb">Autolimb</option>
                </select>
                <input type="number" name="attr_augmentations_head_quality" min="1" placeholder="Q" class=".sheet-augmentation-augmentationOnly" />
                <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_head_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                <label class="sheet-checkbox-label">AV: </label><span name="attr_headAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                <details>
                    <summary class="sheet-spoiler-list">Modules</summary>

                    <fieldset class="repeating_headModule">
                        <input type="text" name="attr_headModule_name" placeholder="Module" />
                        <input type="number" name="attr_headModule_quality" min="1" placeholder="Q" />
                        <input type="number" name="attr_headModule_capacityCost" placeholder="CC" />
                        <textarea name="attr_headModule_description" placeholder="Description..." />
                    </fieldset>
                </details>
            </details>
            
            <!-- Eyes -->
            <details>
                <summary class="sheet-spoiler0">Eyes</summary>

                <!-- Left Eye -->
                <details>
                    <summary class="sheet-spoiler1">Left Eye</summary>

                    <select name="attr_augmentations_leftEye">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_leftEye_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_leftEye_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_leftEyeAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_leftEyeModule">
                            <input type="text" name="attr_leftEyeModule_name" placeholder="Module" />
                            <input type="number" name="attr_leftEyeModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_leftEyeModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_leftEyeModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>

                <!-- Right Eye -->
                <details>
                    <summary class="sheet-spoiler1">Right Eye</summary>

                    <select name="attr_augmentations_rightEye">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_rightEye_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_rightEye_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_rightEyeAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_rightEyeModule">
                            <input type="text" name="attr_rightEyeModule_name" placeholder="Module" />
                            <input type="number" name="attr_rightEyeModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_rightEyeModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_rightEyeModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>
            </details>

            <!-- Jaw -->
            <details>
                <summary class="sheet-spoiler0">Jaw</summary>

                <select name="attr_augmentations_jaw">
                    <option selected>None</option>
                    <option value="prosthetic">Prosthetic</option>
                    <option value="autolimb">Autolimb</option>
                </select>
                <input type="number" name="attr_augmentations_jaw_quality" min="1" placeholder="Q" />
                <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_jaw_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                <details>
                    <summary class="sheet-spoiler-list">Modules</summary>

                    <fieldset class="repeating_jawModule">
                        <input type="text" name="attr_jawModule_name" placeholder="Module" />
                        <input type="number" name="attr_jawModule_quality" min="1" placeholder="Q" />
                        <input type="number" name="attr_jawModule_capacityCost" placeholder="CC" />
                        <textarea name="attr_jawModule_description" placeholder="Description..." />
                    </fieldset>
                </details>
            </details>

            <!-- Torso -->
            <details>
                <summary class="sheet-spoiler0">Torso</summary>

                <select name="attr_augmentations_torso">
                    <option selected>None</option>
                    <option value="prosthetic">Prosthetic</option>
                    <option value="autolimb">Autolimb</option>
                </select>
                <input type="number" name="attr_augmentations_torso_quality" min="1" placeholder="Q" />
                <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_torso_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                <label class="sheet-checkbox-label">AV: </label><span name="attr_torsoAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                <details>
                    <summary class="sheet-spoiler-list">Modules</summary>

                    <fieldset class="repeating_torsoModule">
                        <input type="text" name="attr_torsoModule_name" placeholder="Module" />
                        <input type="number" name="attr_torsoModule_quality" min="1" placeholder="Q" />
                        <input type="number" name="attr_torsoModule_capacityCost" placeholder="CC" />
                        <textarea name="attr_torsoModule_description" placeholder="Description..." />
                    </fieldset>
                </details>
            </details>
            
            <!-- Arms -->
            <details>
                <summary class="sheet-spoiler0">Arms</summary>

                <!-- Left Arm -->
                <details>
                    <summary class="sheet-spoiler1">Left Arm</summary>

                    <select name="attr_augmentations_leftArm">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_leftArm_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_leftArm_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_leftArmAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_leftArmModule">
                            <input type="text" name="attr_leftArmModule_name" placeholder="Module" />
                            <input type="number" name="attr_leftArmModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_leftArmModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_leftArmModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>

                <!-- Right Arm -->
                <details>
                    <summary class="sheet-spoiler1">Right Arm</summary>

                    <select name="attr_augmentations_rightArm">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_rightArm_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_rightArm_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_rightArmAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_rightArmModule">
                            <input type="text" name="attr_rightArmModule_name" placeholder="Module" />
                            <input type="number" name="attr_rightArmModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_rightArmModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_rightArmModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>
            </details>
            
            <!-- Hands -->
            <details>
                <summary class="sheet-spoiler0">Hands</summary>

                <!-- Left Hand -->
                <details>
                    <summary class="sheet-spoiler1">Left Hand</summary>

                    <select name="attr_augmentations_leftHand">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_leftHand_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_leftHand_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_leftHandAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_leftHandModule">
                            <input type="text" name="attr_leftHandModule_name" placeholder="Module" />
                            <input type="number" name="attr_leftHandModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_leftHandModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_leftHandModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>

                <!-- Right Hand -->
                <details>
                    <summary class="sheet-spoiler1">Right Hand</summary>

                    <select name="attr_augmentations_rightHand">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_rightHand_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_rightHand_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_rightHandAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_rightHandModule">
                            <input type="text" name="attr_rightHandModule_name" placeholder="Module" />
                            <input type="number" name="attr_rightHandModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_rightHandModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_rightHandModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>
            </details>
            
            <!-- Legs -->
            <details>
                <summary class="sheet-spoiler0">Legs</summary>

                <!-- Left Leg -->
                <details>
                    <summary class="sheet-spoiler1">Left Leg</summary>

                    <select name="attr_augmentations_leftLeg">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_leftLeg_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_leftLeg_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_leftLegAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_leftLegModule">
                            <input type="text" name="attr_leftLegModule_name" placeholder="Module" />
                            <input type="number" name="attr_leftLegModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_leftLegModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_leftLegModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>

                <!-- Right Leg -->
                <details>
                    <summary class="sheet-spoiler1">Right Leg</summary>

                    <select name="attr_augmentations_rightLeg">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_rightLeg_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_rightLeg_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_rightLegAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_rightArmModule">
                            <input type="text" name="attr_rightLegModule_name" placeholder="Module" />
                            <input type="number" name="attr_rightLegModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_rightLegModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_rightLegModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>
            </details>
            
            <!-- Feet -->
            <details>
                <summary class="sheet-spoiler0">Feet</summary>

                <!-- Left Foot -->
                <details>
                    <summary class="sheet-spoiler1">Left Foot</summary>

                    <select name="attr_augmentations_leftFoot">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_leftFoot_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_leftFoot_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_leftFootAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_leftFootModule">
                            <input type="text" name="attr_leftFootModule_name" placeholder="Module" />
                            <input type="number" name="attr_leftFootModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_leftFootModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_leftFootModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>

                <!-- Right Foot -->
                <details>
                    <summary class="sheet-spoiler1">Right Foot</summary>

                    <select name="attr_augmentations_rightFoot">
                        <option selected>None</option>
                        <option value="prosthetic">Prosthetic</option>
                        <option value="autolimb">Autolimb</option>
                    </select>
                    <input type="number" name="attr_augmentations_rightFoot_quality" min="1" placeholder="Q" />
                    <label class="sheet-checkbox-label">Module Capacity: </label><span name="attr_augmentations_rightFoot_moduleCapacity" class=".sheet-augmentation-augmentationOnly">0</span>
                    <label class="sheet-checkbox-label">AV: </label><span name="attr_rightFootAugmentAV" class=".sheet-augmentation-augmentationOnly">+0</span>
                    <details>
                        <summary class="sheet-spoiler-list">Modules</summary>

                        <fieldset class="repeating_rightFootModule">
                            <input type="text" name="attr_rightFootModule_name" placeholder="Module" />
                            <input type="number" name="attr_rightFootModule_quality" min="1" placeholder="Q" />
                            <input type="number" name="attr_rightFootModule_capacityCost" placeholder="CC" />
                            <textarea name="attr_rightFootModule_description" placeholder="Description..." />
                        </fieldset>
                    </details>
                </details>
            </details>
        </div>
    </div>
</div>

<!-- NPC -->
<div class="sheet-npc">
    <h2>NPC</h2>

    <div class="sheet-character-basics">
        <!-- Name -->
        <div>
            <input type="text" name="attr_character_name" />
            <label>Name</label>
        </div>

        <!-- Power Level -->
        <div>
            <input type="number" name="attr_npc_powerLevel" value="0" />
            <label>Power Level</label>
        </div>

        <!-- Size -->
        <div>
            <select name="attr_npc_size">
                <option>Tiny</option>
                <option>Small</option>
                <option selected>Medium</option>
                <option>Large</option>
                <option>Huge</option>
                <option>Gargantuan</option>
                <option>Colossal</option>
            </select>
            <label>Size</label>
        </div>

        <!-- Sanctity -->
        <div>
            <select name="attr_npc_sanctity">
                <option selected>-</option>
                <option>Holy</option>
                <option>Unholy</option>
            </select>
            <label>Sanctity</label>
        </div>

        <!-- Type -->
        <div class="sheet-npc-type">
            <select name="attr_npc_type">
                <option selected value="human">Human</option>
                <option value="animal">Animal</option>
                <option value="mythological">Mythological</option>
            </select>
            <label>Type</label>
        </div>

        <!-- Subtype -->
        <div class="sheet-npc-subtype">
            <select name="attr_npc_subtype">
                <option selected>-</option>
                <option>Angel</option>
                <option>Deity</option>
                <option>Demon</option>
                <option>Risen</option>
                <option>Chimera</option>
                <option>Cryptid</option>
                <option>Monster</option>
                <option>Spirit</option>
            </select>
            <label>Subtype</label>
        </div>
    </div>

    <hr class="sheet-separator" />
    
    <div class="sheet-npc-topline">
        <!-- HP -->
        <div class="sheet-item">
            <div class="sheet-resource">
                <input type="number" min="0" name="attr_npc_hp" value="0"/>
                <input type="number" min="0" name="attr_npc_hp_max" value="0"/>
            </div>
            <label class="sheet-resource-label">HP</label>
            <span class="sheet-resource-calculation">(Body + (Hit Die Max / 2)) Ã— Power Level</span>
        </div>

        <!-- Hit Die -->
        <div class="sheet-item" name="hitdie">
            <div class="sheet-resource-hitdie">
                <select name="attr_hitdie">
                    <option>d4</option>
                    <option selected>d6</option>
                    <option>d8</option>
                    <option>d10</option>
                    <option>d12</option>
                    <option>d20</option>
                </select>
            </div>
            <label class="sheet-resource-label">Hit Die</label>
        </div>

        <!-- Initiative -->
        <div class="sheet-item">
            <button type="roll" name="roll_initiative" class="sheet-rollable-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Initiative [@{initiative}]}} {{result=[[1d20@{initiative} &{tracker}]]}}">
                <span name="attr_initiative"></span>
            </button>
            <label class="sheet-resource-label">Initiative</label>
            <span class="sheet-resource-calculation">AGI + INT</span>
        </div>

        <!-- Evasion -->
        <div class="sheet-item">
            <button type="roll" name="roll_evasion" class="sheet-rollable-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Evasion [@{evasion}]}} {{result=[[1d20@{evasion}]]}}">
                <span name="attr_evasion"></span>
            </button>
            <label class="sheet-resource-label">Evasion</label>
            <span class="sheet-resource-calculation">AGI + INT</span>
        </div>

        <!-- DAV -->
        <div class="sheet-item">
            <div class="sheet-resource">
                <span name="attr_dav">0</span>
            </div>
            <label class="sheet-resource-label">DAV</label>
            <span class="sheet-resource-calculation">Torso AV</span>
        </div>
    </div>

    <hr class="sheet-separator" />

    <div class="sheet-character-attributes">
        <div class="sheet-attribute">
            <button type="roll" name="roll_agi" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Agility Test [@{agi}]}} {{result=[[1d20@{agi}]]}}">
                <span name="attr_agi"></span>
            </button>
            <div class="sheet-attribute-score">
                <input type="number" name="attr_agility" value="1" min="0"/>
            </div>
            <label class="sheet-attribute-label">Agility</label>
        </div>

        <div class="sheet-attribute">
            <button type="roll" name="roll_bod" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Body Test [@{bod}]}} {{result=[[1d20@{bod}]]}}">
                <span name="attr_bod"></span>
            </button>
            <div class="sheet-attribute-score">
                <input type="number" name="attr_body" value="1" min="0"/>
            </div>
            <label class="sheet-attribute-label">Body</label>
        </div>

        <div class="sheet-attribute">
            <button type="roll" name="roll_cha" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Charisma Test [@{cha}]}} {{result=[[1d20@{cha}]]}}">
                <span name="attr_cha"></span>
            </button>
            <div class="sheet-attribute-score">
                <input type="number" name="attr_charisma" value="1" min="0"/>
            </div>
            <label class="sheet-attribute-label">Charisma</label>
        </div>

        <div class="sheet-attribute">
            <button type="roll" name="roll_int" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Intuition Test [@{int}]}} {{result=[[1d20@{int}]]}}">
                <span name="attr_int"></span>
            </button>
            <div class="sheet-attribute-score">
                <input type="number" name="attr_intuition" value="1" min="0"/>
            </div>
            <label class="sheet-attribute-label">Intuition</label>
        </div>

        <div class="sheet-attribute">
            <button type="roll" name="roll_log" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Logic Test [@{log}]}} {{result=[[1d20@{log}]]}}">
                <span name="attr_log"></span>
            </button>
            <div class="sheet-attribute-score">
                <input type="number" name="attr_logic" value="1" min="0"/>
            </div>
            <label class="sheet-attribute-label">Logic</label>
        </div>

        <div class="sheet-attribute">
            <button type="roll" name="roll_wil" class="sheet-attribute-mod" value="?{Secret|Open,|Secret,/w gm} &{template:custom} {{name=Willpower Test [@{wil}]}} {{result=[[1d20@{wil}]]}}">
                <span name="attr_wil"></span>
            </button>
            <div class="sheet-attribute-score">
                <input type="number" name="attr_willpower" value="1" min="0"/>
            </div>
            <label class="sheet-attribute-label">Willpower</label>
        </div>
    </div>

    <div class="sheet-npc-attacks">
        <fieldset class="repeating_npcAttack">
            <input type="text" name="attr_npc_attack_name" placeholder="Name" />
            <select name="attr_npc_attack_type">
                <option selected>Melee</option>
                <option>Ranged</option>
                <option>Special</option>
            </select>
            <select name="attr_npc_attack_type2">
                <option selected>Weapon</option>
                <option>Unarmed</option>
                <option>Spell</option>
                <option>Innate</option>
            </select>
            <br/>
            <label class="sheet-checkbox-label">Attack Test</label><input type="checkbox" name="attr_npc_attack_isAttackTest"/>
            <label class="sheet-checkbox-label">Requires Save</label><input type="checkbox" name="attr_npc_attack_requiresSave"/>
            <div class="sheet-npc-attack-atk">
                <label>Attack:</label>
                <input type="text" name="attr_npc_attack_atkMod" placeholder="ATK" />
                +
                <select name="attr_npc_attack_atkAttribute">
                    <option value="none" selected>- Attribute -</option>
                    <option>Agility</option>
                    <option>Body</option>
                    <option>Charisma</option>
                    <option>Intuition</option>
                    <option>Logic</option>
                    <option>Willpower</option>
                </select>
                =
                <span name="attr_npc_attack_atk">0</span>
            </div>
            <div class="sheet-npc-attack-save">
                <label>Save DT:</label>
                <input type="text" name="attr_npc_attack_difficultyMod" placeholder="DT"/>
                +
                <select name="attr_npc_attack_difficultyAttribute">
                    <option value="none" selected>- DT Attribute -</option>
                    <option>Agility</option>
                    <option>Body</option>
                    <option>Charisma</option>
                    <option>Intuition</option>
                    <option>Logic</option>
                    <option>Willpower</option>
                </select>
                =
                <span name="attr_npc_attack_difficulty">0</span>
                <br>
                <label>Save Test:</label>
                <select name="attr_npc_attack_saveAttribute">
                    <option value="none" selected>- Save Attribute -</option>
                    <option>Agility</option>
                    <option>Body</option>
                    <option>Charisma</option>
                    <option>Intuition</option>
                    <option>Logic</option>
                    <option>Willpower</option>
                </select>
                <select name="attr_npc_attack_saveSkill">
                    <option value="none" selected>- Save Skill -</option>
                    <option>Evasion</option>
                    <option>Athletics</option>
                    <option>Perception</option>
                    <option>Piloting</option>
                    <option>Stealth</option>
                    <option>Artisanship</option>
                    <option>Deception</option>
                    <option>Intimidation</option>
                    <option>Performance</option>
                    <option>Persuasion</option>
                    <option>Astronomy</option>
                    <option>Economy</option>
                    <option>History</option>
                    <option>Literature</option>
                    <option>Medicine</option>
                    <option>Mythology</option>
                    <option>Nature</option>
                    <option>Survival</option>
                    <option>Clockwork Mechanics</option>
                    <option>Automachinery</option>
                    <option>Augmentation</option>
                    <option>Gunsmithing</option>
                    <option>Tinkering</option>
                    <option>Vehicle Mechanics</option>
                    <option>Alchemy</option>
                    <option>Prayer</option>
                    <option>Spellwork</option>
                    <option>Runecraft</option>
                    <option>Summoning</option>
                    <option>Artillery</option>
                    <option>Brawling</option>
                    <option>Bow</option>
                    <option>Pistol</option>
                    <option>Rifle</option>
                    <option>Shield</option>
                    <option>One-Handed Melee</option>
                    <option>Two-Handed Melee</option>
                </select>
            </div>
            <div class="sheet-npc-attack-damage">
                <input type="text" name="attr_npc_attack_damage" placeholder="Damage" />
            </div>
            <div class="sheet-npc-attack-description">
                <textarea name="attr_npc_attack_description" placeholder="Description..."/>
            </div>
            <button type="action" name="act_npcattackrollbutton">
                Roll
            </button>
        </fieldset>
    </div>
</div>

<script type="text/worker">
// Constants
const TEST_TYPE_PROMPT = "?{Roll Type|Normal,[[1d20]]|Advantage,{[[1d20]]&#44;[[1d20]]&#125;kh1|Disadvantage,{[[1d20]]&#44;[[1d20]]&#125;kl1}";

const SKILLS = [
    "athletics",
    "perception",
    "piloting",
    "stealth",
    "artisanship",
    "deception",
    "intimidation",
    "performance",
    "persuasion",
    "astronomy",
    "economy",
    "history",
    "literature",
    "medicine",
    "mythology",
    "nature",
    "survival",
    "clockworkmechanics",
    "automachinery",
    "augmentation",
    "gunsmithing",
    "tinkering",
    "vehiclemechanics",
    "alchemy",
    "prayer",
    "spellwork",
    "runecraft",
    "summoning",
    "artillery",
    "brawling",
    "bow",
    "pistol",
    "rifle",
    "shield",
    "onehandedmelee",
    "twohandedmelee"
];

const ATTRIBUTES = [
    "agility",
    "body",
    "charisma",
    "intuition",
    "logic",
    "willpower"
];

const ATTRIBUTE_MODS = [
    "agi",
    "bod",
    "cha",
    "int",
    "log",
    "wil"
];

const DAMAGE_TYPES = {
    "blunt": "&#x1F528;",
    "slashing": "&#x1F52A;",
    "piercing": "&#x27B6;",
    "fire": "&#x1F525;",
    "cold": "&#x2744;",
    "electrical": "&#x26A1;",
    "acid": "&#x1F9EA;",
    "poison": "&#x2620;"
};

// Tabs management
const sheetButtonlist = ["pc", "npc"];
sheetButtonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            pcTab: button
        });
    });
});

const buttonlist = ["character", "combat", "qualities", "inventory", "prayer", "witchcraft", "alchemy", "clockworkMechanics", "augmentations"];
buttonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            sheetTab: button
        });
    });
});

const witchcraftButtonlist = ["runes", "rituals", "spells", "curses"];
witchcraftButtonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            witchcraftTab: button
        });
    });
});

const alchemyButtonlist = ["elixirs", "potions", "infusions"];
alchemyButtonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            alchemyTab: button
        });
    });
});

const clockworkMechanicsButtonlist = ["blueprints", "automatons", "artificing"];
clockworkMechanicsButtonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            clockworkMechanicsTab: button
        });
    });
});

const inventoryButtonlist = ["equipment", "money"];
inventoryButtonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            inventoryTab: button
        });
    });
});

// Event Listeners for attribute changes
on("change:agility", UpdateAgi);
on("change:body", UpdateBod);
on("change:charisma", UpdateCha);
on("change:intuition", UpdateInt);
on("change:logic", UpdateLog);
on("change:willpower", UpdateWil);
on("sheet:opened", UpdateAttributes);

// Event Listeners for Skill Rank changes
on("change:athletics", UpdateAthletics);
on("change:perception", UpdatePerception);
on("change:piloting", UpdatePiloting);
on("change:stealth", UpdateStealth);
on("change:artisanship", UpdateArtisanship);
on("change:deception", UpdateDeception);
on("change:intimidation", UpdateIntimidation);
on("change:performance", UpdatePerformance);
on("change:persuasion", UpdatePersuasion);
on("change:astronomy", UpdateAstronomy);
on("change:economy", UpdateEconomy);
on("change:history", UpdateHistory);
on("change:literature", UpdateLiterature);
on("change:medicine", UpdateMedicine);
on("change:mythology", UpdateMythology);
on("change:nature", UpdateNature);
on("change:survival", UpdateSurvival);
on("change:clockworkmechanics", UpdateClockworkMechanics);
on("change:automachinery", UpdateAutomachinery);
on("change:augmentation", UpdateAugmentation);
on("change:gunsmithing", UpdateGunsmithing);
on("change:tinkering", UpdateTinkering);
on("change:vehiclemechanics", UpdateVehicleMechanics);
on("change:alchemy", UpdateAlchemy);
on("change:prayer", UpdatePrayer);
on("change:spellwork", UpdateSpellwork);
on("change:runecraft", UpdateRunecraft);
on("change:summoning", UpdateSummoning);
on("change:artillery", UpdateArtillery);
on("change:brawling", UpdateBrawling);
on("change:bow", UpdateBow);
on("change:pistol", UpdatePistol);
on("change:rifle", UpdateRifle);
on("change:shield", UpdateShield);
on("change:onehandedmelee", UpdateOneHandedMelee);
on("change:twohandedmelee", UpdateTwoHandedMelee);
on("change:level", UpdateLevelStats);
on("change:repeating_positiveQuality:positiveQuality_name", UpdatePositiveQuality);
on("change:repeating_positiveQuality:positiveQuality_level", UpdatePositiveQualityLevel);
on("remove:repeating_positiveQuality", RemovePositiveQuality);
on("change:agileBonus", UpdateAgi);
on("change:analyticalMindBonus", UpdateLog);
on("change:educatedBonus", UpdateKnowledgeSkills);
on("change:quickReflexesBonus", UpdateEvasion);
on("change:toughBonus", UpdateHP);
on("change:sneakyBonus", UpdateStealth);
on("change:inspiringPresenceBonus", UpdateWil);
on("change:strongBonus", UpdateAthletics);
on("change:silverTongueBonus", UpdateCha);
on("change:repeating_negativeQuality:negativeQuality_name", UpdateNegativeQuality);
on("change:repeating_negativeQuality:negativeQuality_level", UpdateNegativeQualityLevel);
on("remove:repeating_negativeQuality", RemoveNegativeQuality);
on("change:addictPenalty", UpdateBod);
on("change:clumsyPenalty", UpdateAgi);
on("change:dullPenalty", UpdateLog);
on("change:fragilePenalty", UpdateHP);
on("change:weakPenalty", UpdateAthletics);
on("change:sociallyIneptPenalty", UpdateCha);
on("change:repeating_equipment:equipment_size", UpdateEquipment);
on("change:repeating_equipment:equipment_count", UpdateEquipment);
on("change:repeating_equipment:equipment_slots", UpdateLoad);
on("change:repeating_equipment:equipment_equip", UpdateLoad);
on("remove:repeating_equipment", UpdateLoad);
on("change:containerBack_load", UpdateLoad);
on("change:containerBack_size", UpdateLoad);
on("change:containerBack_equip", UpdateLoad);
on("change:essence_fire", UpdateLoad);
on("change:essence_water", UpdateLoad);
on("change:essence_earth", UpdateLoad);
on("change:essence_air", UpdateLoad);
on("change:bolts", UpdateLoad);
on("change:plates", UpdateLoad);
on("change:wires", UpdateLoad);
on("change:cogs", UpdateLoad);
on("change:rods", UpdateLoad);
on("change:lenses", UpdateLoad);
on("change:gunpowder", UpdateLoad);
on("change:repeating_backitem:backItem_size", UpdateBackItem);
on("change:repeating_backitem:backItem_count", UpdateBackItem);
on("change:repeating_backitem:backItem_slots", UpdateBackContainerLoad);
on("remove:repeating_backitem", UpdateLoad);
on("change:containerBack_name", UpdateBackContainer);
on("change:torsoTotalAV", UpdateDAV);
on("change:shieldName", UpdateEquippedShield);
on("change:shieldAV", UpdateDAV);
on("change:repeating_blessing:blessing_name", UpdateBlessing);
on("change:repeating_rune:rune_name", UpdateRune);
on("change:repeating_ritual:ritual_name", UpdateRitual);
on("change:repeating_spell:spell_name", UpdateSpell);
on("change:repeating_spell:spell_memorised", UpdateMemorisedSpells);
on("remove:repeating_spell", UpdateMemorisedSpells);
on("change:repeating_blessing:blessing_memorised", UpdateMemorisedBlessings);
on("remove:repeating_blessing", UpdateMemorisedBlessings);
on("change:repeating_curse:curse_name", UpdateCurse);
on("change:repeating_potion:potion_name", UpdatePotion);
on("change:repeating_blueprint:blueprint_automatonChassis", UpdateBlueprintAutomatonChassis);
on("change:repeating_blueprint:blueprint_type", UpdateBlueprintType);
on("change:repeating_blueprint:blueprint_limb", UpdateBlueprintLimb);
on("change:repeating_automaton:automaton_plating", UpdateAutomatonPlating);
on("change:repeating_automaton:automaton_quality", UpdateAutomatonStats);
on("change:repeating_automaton:automaton_chassis", UpdateAutomatonStats);
on("change:repeating_meleeWeapon:meleeWeapon_name", UpdateMeleeWeapon);
on("change:repeating_meleeWeapon:meleeWeapon_damage", UpdateMeleeWeapon);
on("change:repeating_meleeWeapon:meleeWeapon_skill", UpdateMeleeWeapon);
on("change:repeating_meleeWeapon:meleeWeapon_atk", UpdateMeleeWeaponRoll);
on("change:repeating_meleeWeapon:meleeWeapon_weaponExpert", UpdateMeleeWeapon);
on("change:repeating_rangedWeapon:rangedWeapon_name", UpdateRangedWeapon);
on("change:repeating_rangedWeapon:rangedWeapon_damage", UpdateRangedWeapon);
on("change:repeating_rangedWeapon:rangedWeapon_skill", UpdateRangedWeapon);
on("change:repeating_rangedWeapon:rangedWeapon_atk", UpdateRangedWeaponRoll);
on("change:repeating_rangedWeapon:rangedWeapon_weaponExpert", UpdateRangedWeapon);
on("change:repeating_rangedWeapon:rangedWeapon_quality", UpdateRangedWeapon);

on("clicked:repeating_npcAttack:npcattackrollbutton", RollNpcAttack);
on("change:repeating_npcAttack:npc_attack_atkMod", UpdateNpcAttackAtk);
on("change:repeating_npcAttack:npc_attack_atkAttribute", UpdateNpcAttackAtk);
on("change:repeating_npcAttack:npc_attack_difficultyMod", UpdateNpcAttackSaveDifficulty);
on("change:repeating_npcAttack:npc_attack_difficultyAttribute", UpdateNpcAttackSaveDifficulty);

on("change:headAV", UpdateTotalAV);
on("change:leftEyeAV", UpdateTotalAV);
on("change:rightEyeAV", UpdateTotalAV);
on("change:torsoAV", UpdateTotalAV);
on("change:leftArmAV", UpdateTotalAV);
on("change:rightArmAV", UpdateTotalAV);
on("change:leftHandAV", UpdateTotalAV);
on("change:rightHandAV", UpdateTotalAV);
on("change:leftLegAV", UpdateTotalAV);
on("change:rightLegAV", UpdateTotalAV);
on("change:leftFootAV", UpdateTotalAV);
on("change:rightFootAV", UpdateTotalAV);

on("change:headAugmentAV", UpdateTotalAV);
on("change:leftEyeAugmentAV", UpdateTotalAV);
on("change:rightEyeAugmentAV", UpdateTotalAV);
on("change:torsoAugmentAV", UpdateTotalAV);
on("change:leftArmAugmentAV", UpdateTotalAV);
on("change:rightArmAugmentAV", UpdateTotalAV);
on("change:leftHandAugmentAV", UpdateTotalAV);
on("change:rightHandAugmentAV", UpdateTotalAV);
on("change:leftLegAugmentAV", UpdateTotalAV);
on("change:rightLegAugmentAV", UpdateTotalAV);
on("change:leftFootAugmentAV", UpdateTotalAV);
on("change:rightFootAugmentAV", UpdateTotalAV);

on("change:augmentations_head", UpdateAugmentAV);
on("change:augmentations_leftEye", UpdateAugmentAV);
on("change:augmentations_rightEye", UpdateAugmentAV);
on("change:augmentations_torso", UpdateAugmentAV);
on("change:augmentations_leftArm", UpdateAugmentAV);
on("change:augmentations_rightArm", UpdateAugmentAV);
on("change:augmentations_leftHand", UpdateAugmentAV);
on("change:augmentations_rightHand", UpdateAugmentAV);
on("change:augmentations_leftLeg", UpdateAugmentAV);
on("change:augmentations_rightLeg", UpdateAugmentAV);
on("change:augmentations_leftFoot", UpdateAugmentAV);
on("change:augmentations_rightFoot", UpdateAugmentAV);

on("change:augmentations_head_quality", UpdateAugmentAV);
on("change:augmentations_leftEye_quality", UpdateAugmentAV);
on("change:augmentations_rightEye_quality", UpdateAugmentAV);
on("change:augmentations_torso_quality", UpdateAugmentAV);
on("change:augmentations_leftArm_quality", UpdateAugmentAV);
on("change:augmentations_rightArm_quality", UpdateAugmentAV);
on("change:augmentations_leftHand_quality", UpdateAugmentAV);
on("change:augmentations_rightHand_quality", UpdateAugmentAV);
on("change:augmentations_leftLeg_quality", UpdateAugmentAV);
on("change:augmentations_rightLeg_quality", UpdateAugmentAV);
on("change:augmentations_leftFoot_quality", UpdateAugmentAV);
on("change:augmentations_rightFoot_quality", UpdateAugmentAV);

on("change:augmentations_head_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_leftEye_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_rightEye_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_torso_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_leftArm_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_rightArm_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_leftHand_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_rightHand_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_leftLeg_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_rightLeg_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_leftFoot_quality", UpdateAugmentModuleCapacity);
on("change:augmentations_rightFoot_quality", UpdateAugmentModuleCapacity);

on("clicked:repeating_blessing:blessinginvoke", InvokeBlessing);
on("clicked:repeating_spell:spellcast", CastSpell);

on("change:repeating_spell:spell_saveDTSkill", UpdateSpellSaveDT);
on("change:repeating_spell:spell_saveDTAttribute", UpdateSpellSaveDT);
on("change:repeating_spell:spell_saveDTBonus", UpdateSpellSaveDT);

on("change:essence_air", UpdateSpells);
on("change:essence_fire", UpdateSpells);
on("change:essence_earth", UpdateSpells);
on("change:essence_water", UpdateSpells);

on("clicked:healing", UseHealing);

function UpdateAttributes() {
    UpdateAgi();
    UpdateBod();
    UpdateCha();
    UpdateInt();
    UpdateLog();
    UpdateWil();
}

function UpdateKnowledgeSkills() {
    UpdateAstronomy();
    UpdateEconomy();
    UpdateHistory();
    UpdateLiterature();
    UpdateMedicine();
    UpdateMythology();
    UpdateNature();
    UpdateSurvival();
}

function UpdateLevelStats() {
    UpdateHP();
}

function UpdateAgi() {
    getAttrs(["agility", "agileBonus", "clumsyPenalty"], function(values) {
        let agility = parseInt(values.agility)||0;
        let agileBonus = parseInt(values.agileBonus)||0;
        let clumsyPenalty = parseInt(values.clumsyPenalty)||0;

        setAttrs({
            "agi": Signed(agility-5+agileBonus+clumsyPenalty)
        });

        UpdatePiloting();
        UpdateStealth();
        UpdateArtisanship();
        UpdateGunsmithing();
        UpdateTinkering();
        UpdateArtillery();
        UpdateBrawling();
        UpdateBow();
        UpdatePistol();
        UpdateRifle();
        UpdateOneHandedMelee();
        UpdateInitiative();
        UpdateEvasion();
        UpdateNpcAttackAtks();
        UpdateNpcAttackSaveDifficulties();
      });
}

function UpdateBod() {
    getAttrs(["body", "addictPenalty"], function(values) {
        let body = parseInt(values.body)||0;
        let addictPenalty = parseInt(values.addictPenalty)||0;

        setAttrs({
            "bod": Signed(body - 5 + addictPenalty)
        });

        UpdateAthletics();
        UpdateVehicleMechanics();
        UpdateShield();
        UpdateTwoHandedMelee();
        UpdateUnarmedStrike();
        UpdateRangedWeapons(); // for damage and some atk values
        UpdateNpcAttackAtks();
        UpdateNpcAttackSaveDifficulties();
      });
}

function UpdateCha() {
    getAttrs(["charisma", "silverTongueBonus", "sociallyIneptPenalty"], function(values) {
        let charisma = parseInt(values.charisma)||0;
        let silverTongueBonus = parseInt(values.silverTongueBonus)||0;
        let sociallyIneptPenalty = parseInt(values.sociallyIneptPenalty)||0;

        setAttrs({
            "cha": Signed(charisma - 5 + silverTongueBonus + sociallyIneptPenalty)
        });

        UpdateDeception();
        UpdateIntimidation();
        UpdatePerformance();
        UpdatePersuasion();
        UpdateNpcAttackAtks();
        UpdateNpcAttackSaveDifficulties();
      });
}

function UpdateInt() {
    getAttrs(["intuition"], function(values) {
        let intuition = parseInt(values.intuition)||0;

        setAttrs({
            "int": Signed(intuition-5)
        });

        UpdatePerception();
        UpdateSurvival();
        UpdateInitiative();
        UpdateEvasion();
        UpdateNpcAttackAtks();
        UpdateNpcAttackSaveDifficulties();
      });
}

function UpdateLog() {
    getAttrs(["logic", "analyticalMindBonus", "dullPenalty"], function(values) {
        let logic = parseInt(values.logic)||0;
        let analyticalMindBonus = parseInt(values.analyticalMindBonus)||0;
        let dullPenalty = parseInt(values.dullPenalty)||0;

        setAttrs({
            "log": Signed(logic - 5 + analyticalMindBonus + dullPenalty)
        });

        UpdateAstronomy();
        UpdateEconomy();
        UpdateHistory();
        UpdateLiterature();
        UpdateMedicine();
        UpdateMythology();
        UpdateNature();
        UpdateClockworkMechanics();
        UpdateAutomachinery();
        UpdateAugmentation();
        UpdateAlchemy();
        UpdateRunecraft();
        UpdateNpcAttackAtks();
        UpdateNpcAttackSaveDifficulties();
        UpdateMaxMemorisedBlessings();
      });
}

function UpdateWil() {
    getAttrs(["willpower", "inspiringPresenceBonus"], function(values) {
        let willpower = parseInt(values.willpower)||0;
        let inspiringPresenceBonus = parseInt(values.inspiringPresenceBonus)||0;

        setAttrs({
            "wil": Signed(willpower - 5 + inspiringPresenceBonus)
        });

        UpdatePrayer();
        UpdateSpellwork();
        UpdateSummoning();
        UpdateNpcAttackAtks();
        UpdateNpcAttackSaveDifficulties();
        UpdateSRD();
      });
}

function UpdateAthletics() {
    getAttrs(["athletics", "bod", "strongBonus", "weakPenalty"], function(values) {
        let athletics = parseInt(values.athletics)||0;
        let bod = parseInt(values.bod)||0;
        let strongBonus = parseInt(values.strongBonus)||0;
        let weakPenalty = parseInt(values.weakPenalty)||0;

        let mod = athletics + bod + strongBonus + weakPenalty;

        setAttrs({
            "athleticsMod": Signed(mod),
            "athleticsPassive": 10+mod
        });

        UpdateHitDie();
        UpdateCarryCapacity();
        UpdateMeleeWeapons(); // for Powerful Strike
        UpdateRangedWeapons(); // for Powerful Strike
        UpdateSpellSaveDTs();
      });
}

function UpdatePerception() {
    getAttrs(["perception", "int"], function(values) {
        let perception = parseInt(values.perception)||0;
        let int = parseInt(values.int)||0;

        let mod = perception + int;

        setAttrs({
            "perceptionMod": Signed(mod),
            "perceptionPassive": 10+mod
        });
        
        UpdateSpellSaveDTs();
      });
}

function UpdatePiloting() {
    getAttrs(["piloting", "agi"], function(values) {
        let piloting = parseInt(values.piloting)||0;
        let agi = parseInt(values.agi)||0;

        let mod = piloting+agi;

        setAttrs({
            "pilotingMod": Signed(mod),
            "pilotingPassive": 10+mod
        });
        
        UpdateSpellSaveDTs();
      });
}

function UpdateStealth() {
    getAttrs(["stealth", "agi", "sneakyBonus"], function(values) {
        let stealth = parseInt(values.stealth)||0;
        let agi = parseInt(values.agi)||0;
        let sneakyBonus = parseInt(values.sneakyBonus)||0;

        let mod = stealth+agi+sneakyBonus;

        setAttrs({
            "stealthMod": Signed(mod),
            "stealthPassive": 10+mod
        });

        UpdateMeleeWeapons(); // for sneak attack
        UpdateRangedWeapons(); // for sneak attack
        UpdateSpellSaveDTs();
      });
}

function UpdateArtisanship() {
    getAttrs(["artisanship", "agi"], function(values) {
        let artisanship = parseInt(values.artisanship)||0;
        let agi = parseInt(values.agi)||0;

        let mod = artisanship+agi;

        setAttrs({
            "artisanshipMod": Signed(mod),
            "artisanshipPassive": 10+mod
        });
        
        UpdateSpellSaveDTs();
      });
}

function UpdateDeception() {
    getAttrs(["deception", "cha"], function(values) {
        let deception = parseInt(values.deception)||0;
        let cha = parseInt(values.cha)||0;

        let mod = deception+cha;

        setAttrs({
            "deceptionMod": Signed(mod),
            "deceptionPassive": 10+mod
        });
        
        UpdateSpellSaveDTs();
      });
}

function UpdateIntimidation() {
    getAttrs(["intimidation", "cha"], function(values) {
        let intimidation = parseInt(values.intimidation)||0;
        let cha = parseInt(values.cha)||0;

        let mod = intimidation+cha;

        setAttrs({
            "intimidationMod": Signed(mod),
            "intimidationPassive": 10+mod
        });
        
        UpdateSpellSaveDTs();
      });
}

function UpdatePerformance() {
    getAttrs(["performance", "cha"], function(values) {
        let performance = parseInt(values.performance)||0;
        let cha = parseInt(values.cha)||0;

        let mod = performance+cha;

        setAttrs({
            "performanceMod": Signed(mod),
            "performancePassive": 10+mod
        });
      });
}

function UpdatePersuasion() {
    getAttrs(["persuasion", "cha"], function(values) {
        let persuasion = parseInt(values.persuasion)||0;
        let cha = parseInt(values.cha)||0;

        let mod = persuasion+cha;

        setAttrs({
            "persuasionMod": Signed(mod),
            "persuasionPassive": 10+mod
        });
        
        UpdateSpellSaveDTs();
      });
}

function UpdateAstronomy() {
    getAttrs(["astronomy", "log", "educatedBonus"], function(values) {
        let astronomy = parseInt(values.astronomy)||0;
        let log = parseInt(values.log)||0;
        let educatedBonus = parseInt(values.educatedBonus)||0;

        let mod = astronomy + log + educatedBonus;

        setAttrs({
            "astronomyMod": Signed(mod),
            "astronomyPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateEconomy() {
    getAttrs(["economy", "log", "educatedBonus"], function(values) {
        let economy = parseInt(values.economy)||0;
        let log = parseInt(values.log)||0;
        let educatedBonus = parseInt(values.educatedBonus)||0;

        let mod = economy + log + educatedBonus;

        setAttrs({
            "economyMod": Signed(mod),
            "economyPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateHistory() {
    getAttrs(["history", "log", "educatedBonus"], function(values) {
        let history = parseInt(values.history)||0;
        let log = parseInt(values.log)||0;
        let educatedBonus = parseInt(values.educatedBonus)||0;

        let mod = history + log + educatedBonus;

        setAttrs({
            "historyMod": Signed(mod),
            "historyPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateLiterature() {
    getAttrs(["literature", "log", "educatedBonus"], function(values) {
        let literature = parseInt(values.literature)||0;
        let log = parseInt(values.log)||0;
        let educatedBonus = parseInt(values.educatedBonus)||0;

        let mod = literature + log + educatedBonus;

        setAttrs({
            "literatureMod": Signed(mod),
            "literaturePassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateMedicine() {
    getAttrs(["medicine", "log", "educatedBonus"], function(values) {
        let medicine = parseInt(values.medicine)||0;
        let log = parseInt(values.log)||0;
        let educatedBonus = parseInt(values.educatedBonus)||0;

        let mod = medicine + log + educatedBonus;

        setAttrs({
            "medicineMod": Signed(mod),
            "medicinePassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateMythology() {
    getAttrs(["mythology", "log", "educatedBonus"], function(values) {
        let mythology = parseInt(values.mythology)||0;
        let log = parseInt(values.log)||0;
        let educatedBonus = parseInt(values.educatedBonus)||0;

        let mod = mythology + log + educatedBonus;

        setAttrs({
            "mythologyMod": Signed(mod),
            "mythologyPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateNature() {
    getAttrs(["nature", "log", "educatedBonus"], function(values) {
        let nature = parseInt(values.nature)||0;
        let log = parseInt(values.log)||0;
        let educatedBonus = parseInt(values.educatedBonus)||0;

        let mod = nature + log + educatedBonus;

        setAttrs({
            "natureMod": Signed(mod),
            "naturePassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateSurvival() {
    getAttrs(["survival", "int", "educatedBonus"], function(values) {
        let survival = parseInt(values.survival)||0;
        let int = parseInt(values.int)||0;
        let educatedBonus = parseInt(values.educatedBonus)||0;

        let mod = survival + int + educatedBonus;

        setAttrs({
            "survivalMod": Signed(mod),
            "survivalPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateClockworkMechanics() {
    getAttrs(["clockworkmechanics", "log"], function(values) {
        let skill = parseInt(values.clockworkmechanics)||0;
        let stat = parseInt(values.log)||0;

        let mod = skill + stat;

        setAttrs({
            "clockworkmechanicsMod": Signed(mod),
            "clockworkmechanicsPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateAutomachinery() {
    getAttrs(["automachinery", "log"], function(values) {
        let skill = parseInt(values.automachinery)||0;
        let stat = parseInt(values.log)||0;

        let mod = skill + stat;

        setAttrs({
            "automachineryMod": Signed(mod),
            "automachineryPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateAugmentation() {
    getAttrs(["augmentation", "log"], function(values) {
        let skill = parseInt(values.augmentation)||0;
        let stat = parseInt(values.log)||0;

        let mod = skill + stat;

        setAttrs({
            "augmentationMod": Signed(mod),
            "augmentationPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateGunsmithing() {
    getAttrs(["gunsmithing", "agi"], function(values) {
        let skill = parseInt(values.gunsmithing)||0;
        let stat = parseInt(values.agi)||0;

        let mod = skill + stat;

        setAttrs({
            "gunsmithingMod": Signed(mod),
            "gunsmithingPassive": 10 + mod
        });

        UpdateRangedWeapons(); // For Gun Training
        UpdateSpellSaveDTs();
    });
}

function UpdateTinkering() {
    getAttrs(["tinkering", "agi"], function(values) {
        let skill = parseInt(values.tinkering)||0;
        let stat = parseInt(values.agi)||0;

        let mod = skill + stat;

        setAttrs({
            "tinkeringMod": Signed(mod),
            "tinkeringPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateVehicleMechanics() {
    getAttrs(["vehiclemechanics", "bod"], function(values) {
        let skill = parseInt(values.vehiclemechanics)||0;
        let stat = parseInt(values.bod)||0;

        let mod = skill + stat;

        setAttrs({
            "vehiclemechanicsMod": Signed(mod),
            "vehiclemechanicsPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateAlchemy() {
    getAttrs(["alchemy", "log"], function(values) {
        let skill = parseInt(values.alchemy)||0;
        let stat = parseInt(values.log)||0;

        let mod = skill + stat;

        setAttrs({
            "alchemyMod": Signed(mod),
            "alchemyPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdatePrayer() {
    getAttrs(["prayer", "wil"], function(values) {
        let skill = parseInt(values.prayer)||0;
        let stat = parseInt(values.wil)||0;

        let mod = skill + stat;

        setAttrs({
            "prayerMod": Signed(mod),
            "prayerPassive": 10 + mod
        });

        UpdateFaith();
        UpdateHealing();
        UpdateMaxMemorisedBlessings();
        UpdateSpellSaveDTs();
    });
}

function UpdateSpellwork() {
    getAttrs(["spellwork", "wil"], function(values) {
        let skill = parseInt(values.spellwork)||0;
        let stat = parseInt(values.wil)||0;

        let mod = skill + stat;

        setAttrs({
            "spellworkMod": Signed(mod),
            "spellworkPassive": 10 + mod
        });

        UpdateMaxMemorisedSpells();
        UpdateCursePowers();
        UpdateSRD();
        UpdateSpellSaveDTs();
    });
}

function UpdateRunecraft() {
    getAttrs(["runecraft", "log"], function(values) {
        let skill = parseInt(values.runecraft)||0;
        let stat = parseInt(values.log)||0;

        let mod = skill + stat;

        setAttrs({
            "runecraftMod": Signed(mod),
            "runecraftPassive": 10 + mod
        });

        UpdateMaxMemorisedSpells();
        UpdateSpellSaveDTs();
    });
}

function UpdateMaxMemorisedSpells() {
    getAttrs(["spellwork", "runecraft", "log"], function(values) {
        let spellwork = parseInt(values.spellwork)||0;
        let runecraft = parseInt(values.runecraft)||0;
        let log = parseInt(values.log)||0;

        let skillRankBonus = spellwork;

        if(runecraft >= 9) {
            skillRankBonus = Math.max(spellwork, runecraft);
        }

        setAttrs({
            "memorisedSpells_max": Math.max(1, log + skillRankBonus)
        });
    });
}

function UpdateMaxMemorisedBlessings() {
    getAttrs(["prayer", "log"], function(values) {
        let prayer = parseInt(values.prayer)||0;
        let log = parseInt(values.log)||0;

        setAttrs({
            "memorisedBlessings_max": Math.max(1, log + prayer)
        });
    });
}

function UpdateSummoning() {
    getAttrs(["summoning", "wil"], function(values) {
        let skill = parseInt(values.summoning)||0;
        let stat = parseInt(values.wil)||0;

        let mod = skill + stat;

        setAttrs({
            "summoningMod": Signed(mod),
            "summoningPassive": 10 + mod
        });
        
        UpdateSpellSaveDTs();
    });
}

function UpdateArtillery() {
    getAttrs(["artillery", "agi"], function(values) {
        let skill = parseInt(values.artillery)||0;
        let stat = parseInt(values.agi)||0;

        let mod = skill + stat;

        setAttrs({
            "artilleryMod": Signed(mod),
            "artilleryPassive": 10 + mod
        });

        UpdateRangedWeapons(); // for atk
        UpdateSpellSaveDTs();
    });
}

function UpdateBrawling() {
    getAttrs(["brawling", "agi"], function(values) {
        let skill = parseInt(values.brawling)||0;
        let stat = parseInt(values.agi)||0;

        let mod = skill + stat;

        setAttrs({
            "brawlingMod": Signed(mod),
            "brawlingPassive": 10 + mod
        });

        UpdateUnarmedStrike();
        UpdateMeleeWeapons(); // for atk
        UpdateSpellSaveDTs();
    });
}

function UpdateBow() {
    getAttrs(["bow", "agi"], function(values) {
        let skill = parseInt(values.bow)||0;
        let stat = parseInt(values.agi)||0;

        let mod = skill + stat;

        setAttrs({
            "bowMod": Signed(mod),
            "bowPassive": 10 + mod
        });
        
        UpdateRangedWeapons(); // for atk
        UpdateSpellSaveDTs();
    });
}

function UpdatePistol() {
    getAttrs(["pistol", "agi"], function(values) {
        let skill = parseInt(values.pistol)||0;
        let stat = parseInt(values.agi)||0;

        let mod = skill + stat;

        setAttrs({
            "pistolMod": Signed(mod),
            "pistolPassive": 10 + mod
        });
        
        UpdateRangedWeapons(); // for atk
        UpdateSpellSaveDTs();
    });
}

function UpdateRifle() {
    getAttrs(["rifle", "agi"], function(values) {
        let skill = parseInt(values.rifle)||0;
        let stat = parseInt(values.agi)||0;

        let mod = skill + stat;

        setAttrs({
            "rifleMod": Signed(mod),
            "riflePassive": 10 + mod
        });
        
        UpdateRangedWeapons(); // for atk
        UpdateSpellSaveDTs();
    });
}

function UpdateShield() {
    getAttrs(["shield", "bod"], function(values) {
        let skill = parseInt(values.shield)||0;
        let stat = parseInt(values.bod)||0;

        let mod = skill + stat;

        setAttrs({
            "shieldMod": Signed(mod),
            "shieldPassive": 10 + mod
        });

        UpdateDAV();
        UpdateMeleeWeapons(); // for atk
        UpdateSpellSaveDTs();
    });
}

function UpdateOneHandedMelee() {
    getAttrs(["onehandedmelee", "agi"], function(values) {
        let skill = parseInt(values.onehandedmelee)||0;
        let stat = parseInt(values.agi)||0;

        let mod = skill + stat;

        setAttrs({
            "onehandedmeleeMod": Signed(mod),
            "onehandedmeleePassive": 10 + mod
        });

        UpdateMeleeWeapons(); // for atk
        UpdateSpellSaveDTs();
    });
}

function UpdateTwoHandedMelee() {
    getAttrs(["twohandedmelee", "bod"], function(values) {
        let skill = parseInt(values.twohandedmelee)||0;
        let stat = parseInt(values.bod)||0;

        let mod = skill + stat;

        setAttrs({
            "twohandedmeleeMod": Signed(mod),
            "twohandedmeleePassive": 10 + mod
        });
        
        UpdateMeleeWeapons(); // for atk
        UpdateSpellSaveDTs();
    });
}

function UpdateHP() {
    getAttrs(["body", "level", "hitdie", "toughBonus", "fragilePenalty"], function(values) {
        let body = parseInt(values.body)||0;
        let level = parseInt(values.level)||0;
        let hitdie = values.hitdie||"d0";
        let hitdieMax = parseInt(hitdie.substring(1))||0;
        let toughBonus = parseInt(values.toughBonus)||0;
        let fragilePenalty = parseInt(values.fragilePenalty)||0;

        setAttrs({
            "hp_max": ((hitdieMax/2)+body+toughBonus+fragilePenalty)*level
        });
    });
}

function UpdateHitDie() {
    getAttrs(["athletics"], function(values) {
        let athletics = parseInt(values.athletics)||0;
        let hitDice = ["d4", "d6", "d8", "d10", "d12", "d20"];

        setAttrs({
            "hitdie": hitDice[Math.floor(athletics/3)+1]
        });

        UpdateHP();
    });
}

function UpdateInitiative() {
    getAttrs(["agi", "int"], function(values) {
        let agi = parseInt(values.agi)||0;
        let int = parseInt(values.int)||0;

        setAttrs({
            "initiative": Signed(agi+int)
        });
    });
}

function UpdateEvasion() {
    getAttrs(["agi", "int", "quickReflexesBonus"], function(values) {
        let agi = parseInt(values.agi)||0;
        let int = parseInt(values.int)||0;
        let quickReflexesBonus = parseInt(values.quickReflexesBonus)||0;

        setAttrs({
            "evasion": Signed(agi+int+quickReflexesBonus)
        });
    });
}

function UpdateUnarmedStrike() {
    getAttrs(["bod", "brawlingMod", "brawling"], function(values) {
        let bod = parseInt(values.bod)||0;
        let brawlingMod = parseInt(values.brawlingMod)||0;
        let brawling = parseInt(values.brawling)||0;

        let martialArtsDice = Math.floor((brawling+2)/3);
        let martialArtsDamage = "";
        if(martialArtsDice > 0) {
            martialArtsDamage = "" + martialArtsDice + "d4 + ";
        }

        setAttrs({
            "unarmedStrike_atk": Signed(brawlingMod),
            "unarmedStrike_damage": martialArtsDamage + Math.max(1, bod) + " Blunt"
        });
    });
}

function UpdateDAV() {
    getAttrs(
        [
            "torsoTotalAV",
            "shieldAV",
            "shield"
        ],
        function(values) {
            let torsoAV = parseInt(values.torsoTotalAV)||0;
            let shieldAV = values.shieldAV || "0";
            let shield = parseInt(values.shield)||0;
            let torsoAugment = values["augmentations_torso"] || "";
            let torsoAugmentQuality = parseInt(values["augmentations_torso_quality"]) || 0;

            let effectiveAV = 0;
            let splitAV = shieldAV.split("(");
            if(splitAV.length === 1) {
                effectiveAV = parseInt(shieldAV) || 0;
            }
            else if(shield >= 5) {
                effectiveAV = parseInt(splitAV[1].replace(")", "")) || 0;
            }
            else {
                effectiveAV = parseInt(shieldAV) || 0;
            }

            setAttrs({
                dav: torsoAV + effectiveAV
            });
        }
    );
}

function UpdateCarryCapacity() {
    getAttrs(["body", "athletics", "strongBonus", "weakPenalty"], function(values) {
        let body = parseInt(values.body)||0;
        let athletics = parseInt(values.athletics)||0;
        let strongBonus = parseInt(values.strongBonus)||0;
        let weakPenalty = parseInt(values.weakPenalty)||0;

        let athleticsBonus = Math.floor(athletics/2) * 5;
        let capacity = (body * 10) + athleticsBonus;

        if(strongBonus > 0)  {
            capacity = capacity * 2;
        }

        if(weakPenalty < 0) {
            capacity = Math.floor(capacity/2);
        }

        setAttrs({
            carryCapacity: "" + capacity + " Slots"
        });
    });
}

function UpdatePositiveQuality(eventInfo) {
    let oldQuality = eventInfo.previousValue;

    if(oldQuality !== undefined) {
        RemovePositiveQuality(eventInfo);
    }

    let newQuality = eventInfo.newValue;
    
    if(newQuality !== undefined) {
        AddPositiveQuality(eventInfo);
    }
}

function AddPositiveQuality(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_positiveQuality_" + rowId + "_";
    let descriptions = {
        "agile": "You gain a +2 bonus on all Agility tests.\nThis quality is incompatible with Clumsy.",
        "ambidextrous": "While dual-wielding, you can benefit from Extra Attacks of your off-hand weapon. If both weapons would give you Extra Attacks, only the one that gives you more attacks applies.\nYou lose these benefits if you lose a hand or arm until it is restored or replaced.",
        "analytical mind": "You gain a +2 bonus on all Logic tests.\nThis quality is incompatible with Dull.",
        "educated": "At Level 1, you gain a +1 bonus on all Knowledge skill tests. This bonus increases by +1 for each Level of Educated after 1.\nAt Level 2, whenever you fail a knowledge skill test made to recall information, you at least know where to find the information youâ€™re missing, provided you have at least 1 Rank in the skill.\nAt Level 3, you have advantage on knowledge skill tests made to recall information if you have at least 1 Rank in the skill.",
        "eidetic memory": "At Level 1, you can accurately recall anything you have experienced within the last 24 hours.\nAt Level 2, you can accurately recall anything you have experienced within the last month.\nAt Level 3, you can accurately recall anything you have experienced within the last year.",
        "elemental attunement (water)": "You can choose this quality only once and have to select one of the 4 elements: Water, Earth, Fire, Air.\nWhen you expend essence of the chosen element, you need one less essence of that element and the complexity of any formula using this essence is also one less for you.",
        "elemental attunement (earth)": "You can choose this quality only once and have to select one of the 4 elements: Water, Earth, Fire, Air.\nWhen you expend essence of the chosen element, you need one less essence of that element and the complexity of any formula using this essence is also one less for you.",
        "elemental attunement (fire)": "You can choose this quality only once and have to select one of the 4 elements: Water, Earth, Fire, Air.\nWhen you expend essence of the chosen element, you need one less essence of that element and the complexity of any formula using this essence is also one less for you.",
        "elemental attunement (air)": "You can choose this quality only once and have to select one of the 4 elements: Water, Earth, Fire, Air.\nWhen you expend essence of the chosen element, you need one less essence of that element and the complexity of any formula using this essence is also one less for you.",
        "empathetic": "You gain a +2 bonus on all Intuition tests made to judge the intentions or emotional state of another creature, for example when trying to tell if theyâ€™re telling the truth.\nThis quality is incompatible with Callous.",
        "essence sensitivity": "At Level 1, you can spend 10 minutes examining an unprocessed object (like a plant, a piece of rock or crystal, or an animal part) to find out what Essence could be extracted from it, if any.\nAt Level 2, you have Advantage on Evasion and Willpower tests against spells, curses and magical effects.\nAt Level 3, you have advantage on Spellwork, Runecraft, and Alchemy tests made to experiment for formulae and recipes.",
        "fast": "Your movement speed increases by 2m for each level of Fast.\nThis quality is incompatible with Slow.",
        "pious": "You have advantage on Prayer tests other than attacks and Mythology tests related to your own religion.",
        "quick reflexes": "You gain a +2 bonus on all Evasion tests.",
        "sniper": "Your ranged weapon attacks ignore half and three-quarters cover.\nIn addition, when you aim at specific body parts with ranged weapons, you ignore the targetâ€™s Shield Armor bonus on a hit.",
        "sharpshooter": "Attacking at long range doesnâ€™t impose disadvantage on your attack.",
        "tough": "Your maximum hit points increase by your character level for each level of Tough.\nAt Tough Level 3, when you take a Breather, you gain the benefits of a Short Rest.\nThis quality is incompatible with Fragile.",
        "weapon expert": "You can take this quality multiple times, but every time you have to choose a different type of weapon.\nYou gain a +2 bonus to the attack and damage when attacking with the chosen weapon type.",
        "sneaky": "You gain a +2 bonus to Stealth tests and can attempt to hide even when only lightly obscured.",
        "inspiring presence": "You and friendly creatures within 10m gain a +2 bonus to Willpower tests.",
        "strong": "You gain a +2 bonus to Athletics tests and your carry capacity doubles.\nThis quality is incompatible with Weak.",
        "silver tongue": "You gain a +2 bonus on all Charisma tests.\nThis quality is incompatible with Socially Inept."
    };

    let newQuality = eventInfo.newValue;
    let description = descriptions[newQuality.toLowerCase()];
    
    let attributes = {};

    if(description !== undefined) {
        attributes[prefix + "positiveQuality_description"] = description;
    }

    attributes.elementalAttunement = "";

    switch(newQuality.toLowerCase()) {
        case "agile":
            attributes.agileBonus = "+2";
            break;
        case "analytical mind":
            attributes.analyticalMindBonus = "+2";
            break;
        case "educated":
            UpdatePositiveQualityLevel(eventInfo);
            break;
        case "quick reflexes":
            attributes.quickReflexesBonus = "+2";
            break;
        case "tough":
            UpdatePositiveQualityLevel(eventInfo);
            break;
        case "sneaky":
            attributes.sneakyBonus = "+2";
            break;
        case "inspiring presence":
            attributes.inspiringPresenceBonus = "+2";
            break;
        case "strong":
            attributes.strongBonus = "+2";
            break;
        case "silver tongue":
            attributes.silverTongueBonus = "+2";
            break;
        case "elemental attunement (air)":
            attributes.elementalAttunement = "air";
            break;
        case "elemental attunement (earth)":
            attributes.elementalAttunement = "earth";
            break;
        case "elemental attunement (fire)":
            attributes.elementalAttunement = "fire";
            break;
        case "elemental attunement (water)":
            attributes.elementalAttunement = "water";
            break;
    }
    
    setAttrs(attributes);
}

function RemovePositiveQuality(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_positivequality_" + rowId + "_";

    let oldQuality = eventInfo.previousValue;
    if(eventInfo.triggerName.startsWith("remove:")) {
        oldQuality = eventInfo.removedInfo[prefix + "positiveQuality_name"];
    }

    if(oldQuality === undefined) {
        return;
    }

    let attributes = {};

    switch(oldQuality.toLowerCase()) {
        case "agile":
            attributes.agileBonus = "";
            break;
        case "analytical mind":
            attributes.analyticalMindBonus = "";
            break;
        case "educated":
            attributes.educatedBonus = "";
            break;
        case "quick reflexes":
            attributes.quickReflexesBonus = "";
            break;
        case "tough":
            attributes.toughBonus = "";
            break;
        case "sneaky":
            attributes.sneakyBonus = "";
            break;
        case "inspiring presence":
            attributes.inspiringPresenceBonus = "";
            break;
        case "strong":
            attributes.strongBonus = "";
            break;
        case "silver tongue":
            attributes.silverTongueBonus = "";
            break;
        case "elemental attunement (air)":
            attributes.elementalAttunement = "";
            break;
        case "elemental attunement (earth)":
            attributes.elementalAttunement = "";
            break;
        case "elemental attunement (fire)":
            attributes.elementalAttunement = "";
            break;
        case "elemental attunement (water)":
            attributes.elementalAttunement = "";
            break;
    }
    
    setAttrs(attributes);
}

function UpdatePositiveQualityLevel(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_positivequality_" + rowId + "_";
    
    getAttrs([prefix + "positiveQuality_name", prefix + "positiveQuality_level"], function(values) {
        let quality = values[prefix + "positiveQuality_name"] || "";
        let level = parseInt(values[prefix + "positiveQuality_level"]) || 0;

        switch(quality.toLowerCase()) {
            case "educated":
                setAttrs({
                    educatedBonus: level
                });
                break;
            case "tough":
                setAttrs({
                    toughBonus: level
                });
                break;
        }
    });
}

function UpdateNegativeQuality(eventInfo) {
    let oldQuality = eventInfo.previousValue;

    if(oldQuality !== undefined) {
        RemoveNegativeQuality(eventInfo);
    }

    let newQuality = eventInfo.newValue;
    
    if(newQuality !== undefined) {
        AddNegativeQuality(eventInfo);
    }
}

function AddNegativeQuality(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_negativeQuality_" + rowId + "_";
    let descriptions = {
        "addict": "You can select this quality more than once, but have to select a different drug each time.\nAt Level 1, you have a -1 penalty to all Body tests. This penalty increases by -1 for each Level after 1.\nAt Level 2, you have disadvantage on Body tests if you havenâ€™t had a dose of the chosen drug in the last 24 hours.\nAt Level 3, you have disadvantage on Body tests if you havenâ€™t had a dose of the chosen drug in the last 2 hours.",
        "callous": "You gain a -2 penalty on Intuition tests made to judge the intentions or emotional state of another creature, for example when trying to tell if theyâ€™re telling the truth.\nThis quality is incompatible with Empathetic.",
        "clumsy": "You have a -2 penalty to Agility tests.\nThis quality is incompatible with Agile.",
        "disgraced": "You have disadvantage on Prayer and Mythology tests related to your own religion.",
        "dull": "You have a -2 penalty to Logic tests.\nThis quality is incompatible with Analytical Mind.",
        "essence vulnerability": "You have disadvantage on Willpower tests made to resist spells, rituals, or curses.",
        "farsighted": "At Level 1, you have a -1 penalty to all Perception tests relying on sight. This penalty increases by -1 for each Level after 1.\nAt Level 2, you apply the same penalty to attack tests against targets within 6m of you.\nAt Level 3, you have disadvantage on Perception tests relying on sight.\nWearing prescription lenses can offset the level of this quality, or suppress it altogether.\nThis quality is incompatible with Nearsighted.",
        "fragile": "Your maximum hit points decrease by 3 times your character level for each level of Fragile.\nThis quality is incompatible with Tough.",
        "hard of hearing": "At Level 1, you have a -1 penalty to all Perception tests relying on hearing. This penalty increases by -1 for each Level after 1.\nAt Level 2, you apply the same penalty to Initiative and Evasion tests.\nAt Level 3, you have disadvantage on Perception tests relying on hearing.\nUsing hearing aids can offset the level of this quality, or suppress it altogether.",
        "nearsighted": "At Level 1, you have a -1 penalty to all Perception tests relying on sight. This penalty increases by -1 for each Level after 1.\nAt Level 2, you apply the same penalty to attack tests against targets that are 6m or more away from you.\nAt Level 3, you have disadvantage on Perception tests relying on sight.\nWearing prescription lenses can offset the level of this quality, or suppress it altogether.\nThis quality is incompatible with Farsighted.",
        "slow": "Your movement speed decreases by 2m for each level of Slow.\nThis quality is incompatible with Fast.",
        "weak": "You have a -2 penalty to Athletics tests and your carry capacity is halved.\nThis quality is incompatible with Strong.",
        "phobia": "You are irrationally afraid of something which will be referred to as the target of your phobia. You can have multiple instances of this quality, choosing a different target for each instance.\nWhile youâ€™re exposed to the target of your phobia, you have disadvantage on all tests. Being exposed means youâ€™re perceiving the target in whatever way.\nThe level of this quality is tied to how common the target of your phobia is. Keep in mind that different environments might make it more or less likely to encounter certain things and that should be factored in here. Talk to your GM to determine the level of your phobia.\nLevel 1 means your target is quite rare or specific and itâ€™s rather unlikely to encounter it. For example, you might be afraid of unicorns or ghosts.\nLevel 2 means you are likely to encounter your target, though not on a regular basis. For example, you might be afraid of power cores or wolves.\nLevel 3 means you are very likely to encounter your target on a regular basis if you donâ€™t actively avoid it. For example, you might be afraid of spiders or firearms.",
        "socially inept": "You have a -2 penalty to Charisma tests.\nThis quality is incompatible with Silver Tongue."
      };

    let newQuality = eventInfo.newValue;
    let description = descriptions[newQuality.toLowerCase()];

    if(description !== undefined) {
        let attributes = {};
        attributes[prefix + "negativeQuality_description"] = description;
        setAttrs(attributes);
    }

    switch(newQuality.toLowerCase()) {
        case "addict":
            UpdateNegativeQualityLevel(eventInfo);
            break;
        case "clumsy":
            setAttrs({
                clumsyPenalty: -2
            });
            break;
        case "dull":
            setAttrs({
                dullPenalty: -2
            });
            break;
        case "fragile":
            UpdateNegativeQualityLevel(eventInfo);
            break;
        case "weak":
            setAttrs({
                weakPenalty: -2
            });
            break;
        case "socially inept":
            setAttrs({
                sociallyIneptPenalty: -2
            });
            break;
    }
}

function RemoveNegativeQuality(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_negativequality_" + rowId + "_";

    let oldQuality = eventInfo.previousValue;
    if(eventInfo.triggerName.startsWith("remove:")) {
        oldQuality = eventInfo.removedInfo[prefix + "negativeQuality_name"];
    }

    if(oldQuality === undefined) {
        return;
    }

    switch(oldQuality.toLowerCase()) {
        case "addict":
            setAttrs({
                addictPenalty: 0
            });
            break;
        case "clumsy":
            setAttrs({
                clumsyPenalty: 0
            });
            break;
        case "dull":
            setAttrs({
                dullPenalty: 0
            });
            break;
        case "fragile":
            setAttrs({
                fragilePenalty: 0
            });
            break;
        case "weak":
            setAttrs({
                weakPenalty: 0
            });
            break;
        case "socially inept":
            setAttrs({
                sociallyIneptPenalty: 0
            });
            break;
    }
}

function UpdateNegativeQualityLevel(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_negativequality_" + rowId + "_";
    
    getAttrs([prefix + "negativeQuality_name", prefix + "negativeQuality_level"], function(values) {
        let quality = values[prefix + "negativeQuality_name"] || "";
        let level = parseInt(values[prefix + "negativeQuality_level"]) || 0;

        switch(quality.toLowerCase()) {
            case "addict":
                setAttrs({
                    addictPenalty: level * -1
                });
                break;
            case "fragile":
                setAttrs({
                    fragilePenalty: level * -2
                });
                break;
        }
    });
}

function UpdateEquipment(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_equipment_" + rowId + "_";

    getAttrs([prefix + "equipment_size", prefix + "equipment_count"], function(values) {
        let size = values[prefix + "equipment_size"] || "0";
        let count = parseInt(values[prefix + "equipment_count"]) || 0;

        let attributes = {};
        attributes[prefix + "equipment_slots"] = CalculateSlots(size, count);
        setAttrs(attributes);
    });
}

function UpdateLoad(eventInfo) {
    getAttrs(["containerBack_load", "containerBack_size", "containerBack_equip",
        "essence_fire", "essence_water", "essence_earth", "essence_air",
        "bolts", "plates", "wires", "cogs", "rods", "lenses", "gunpowder"
    ], function(values) {
        let backContainerIsEquipped = values.containerBack_equip == "on";
        
        // Essence Load
        let fireEssence = parseInt(values.essence_fire) || 0;
        let waterEssence = parseInt(values.essence_water) || 0;
        let earthEssence = parseInt(values.essence_earth) || 0;
        let airEssence = parseInt(values.essence_air) || 0;

        let essenceCount = fireEssence + waterEssence + earthEssence + airEssence;
        let essenceLoad = CalculateSlots("1/10", essenceCount);

        var load = essenceLoad;

        // Parts Load
        let bolts = parseInt(values.bolts) || 0;
        let plates = parseInt(values.plates) || 0;
        let wires = parseInt(values.wires) || 0;
        let cogs = parseInt(values.cogs) || 0;
        let rods = parseInt(values.rods) || 0;
        let lenses = parseInt(values.lenses) || 0;
        let gunpowder = parseInt(values.gunpowder) || 0;

        let partsLoad = CalculateSlots("1/20", bolts)
            + CalculateSlots("1/10", plates)
            + CalculateSlots("1/10", wires)
            + CalculateSlots("1/50", cogs)
            + CalculateSlots("1/10", rods)
            + CalculateSlots("1/50", lenses)
            + CalculateSlots("1/10", gunpowder);

        load += partsLoad;

        // Back Container Load
        if(backContainerIsEquipped) {
            let backContainerLoad = parseInt(values.containerBack_load) || 0;
            let backContainerSize = values.containerBack_size || "0";

            let backContainerSizeValue = 0;
            let backContainerSizeParts = backContainerSize.split("/");
            backContainerSize = parseInt(backContainerSizeParts[0]) || 0;

            load += backContainerSize + backContainerLoad;
        }

        setAttrs({
            inventory_load: "" + load + " Slots"
        });
        
        // Equipment Load
        getSectionIDs("equipment", function(ids) {
            for(var i = 0; i < ids.length; i++) {
                let prefix = "repeating_equipment_" + ids[i] + "_";

                getAttrs([prefix + "equipment_slots", prefix + "equipment_equip"], function(values) {
                    let isEquipped = values[prefix + "equipment_equip"] == 'on';

                    // Only count if the equipment is equipped
                    if(!isEquipped)
                        return;
                        
                    let slots = parseInt(values[prefix + "equipment_slots"]) || 0;
                    load += slots;

                    setAttrs({
                        inventory_load: "" + load + " Slots"
                    });
                });
            }
        });
    });
}

function UpdateBackItem(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_backitem_" + rowId + "_";

    getAttrs([prefix + "backitem_size", prefix + "backitem_count"], function(values) {
        let size = values[prefix + "backitem_size"] || "0";
        let count = parseInt(values[prefix + "backitem_count"]) || 0;

        let attributes = {};
        attributes[prefix + "backItem_slots"] = CalculateSlots(size, count);
        setAttrs(attributes);
    });
}

function UpdateBackContainerLoad(eventInfo) {
    getSectionIDs("backItem", function(ids) {
        let load = 0;
        setAttrs({
            containerBack_load: load
        });

        for(var i = 0; i < ids.length; i++) {
            let prefix = "repeating_backitem_" + ids[i] + "_";

            getAttrs([prefix + "backItem_slots"], function(values) {
                load += parseInt(values[prefix + "backItem_slots"]) || 0;

                setAttrs({
                    containerBack_load: load
                });
            });
        }
    });
}

function UpdateBackContainer() {
    let containers = {
        "backpack": {
            size: 3,
            capacity: 30
        },
        "travel pack": {
            size: 5,
            capacity: 50
        }
    };

    getAttrs(["containerBack_name"], function(values) {
        let container = values.containerBack_name || "";
        let listContainer = containers[container.toLowerCase()];

        if(listContainer !== undefined) {
            setAttrs({
                containerBack_size: ""+listContainer.size,
                containerBack_capacity: listContainer.capacity
            });
        }
    });
}

function UpdateEquippedShield() {
    let shields = {
        "buckler": {
            av: "1",
            type: "Light"
        },
        "round shield": {
            av: "2",
            type: "Light"
        },
        "kite shield": {
            av: "2 (3)",
            type: "Heavy"
        },
        "tower shield": {
            av: "2 (4)",
            type: "Heavy"
        }
    };

    getAttrs(["shieldName"], function(values) {
        let shieldName = values.shieldName || "";

        let listShield = shields[shieldName.toLowerCase()];
        
        if(listShield !== undefined) {
            setAttrs({
                shieldAV: listShield.av,
                shieldType: listShield.type
            });
        }
    });
}

function UpdateFaith() {
    getAttrs(["willpower", "prayer"], function(values) {
        let willpower = parseInt(values.willpower) || 0;
        let prayer = parseInt(values.prayer) || 0;

        setAttrs({
            faith_max: willpower * prayer
        });
    });
}

function UpdateHealing() {
    getAttrs(["prayer"], function(values) {
        let prayer = parseInt(values.prayer)||0;

        let healing = "0";

        if(prayer >= 3) {
            healing = "" + Math.floor(prayer / 3) + "d6 + " + prayer;
        }

        setAttrs({
            healing: healing
        });
    });
}

let blessings = {
    "blessing of regeneration": {
        action: "Major Action",
        components: "Motus, Vox",
        faith: 5,
        range: "10m",
        duration: "1 minute",
        description: "The target creature restores [P] hit points at the start of each of its turns for the duration."
    },
    "blessing of protection": {
        action: "Major Action",
        components: "Motus, Vox",
        faith: 3,
        range: "20m",
        duration: "10 minutes",
        description: "The target creature or object gains a +[P] bonus to all of its Armor Values for the duration."
    },
    "blessing of haste": {
        action: "Major Action",
        components: "Motus, Vox",
        faith: 10,
        range: "10m",
        duration: "1 minute",
        description: "The target creatureâ€™s movement speed increases by +[P] Ã— 2 m and it gains an additional Minor Action for the duration."
    },
    "blessing of attention": {
        action: "Major Action",
        components: "Vox",
        faith: 3,
        range: "20m",
        duration: "1 minute",
        description: "The target creature gains a +[P] bonus to all Evasion tests for the duration."
    },
    "blessing of burden": {
        action: "Major Action",
        components: "Vox",
        faith: 2,
        range: "Touch",
        duration: "[P] hours",
        description: "The target creatureâ€™s carry capacity is doubled for the duration."
    },
    "blessing of warding off evil": {
        action: "Major Action",
        components: "Motus, Vox",
        faith: 20,
        range: "Touch",
        area: "10m Dome",
        duration: "[P] hours",
        description: "You create a warded space around a target point on a surface you touch. For the duration, no unholy creature can enter the area or target another creature inside the area with an attack, spell, or other magical effect. Areas of Effect created from an unholy creature can not extend inside of the blessed area."
    },
    "blessing of sanctity": {
        action: "Major Action",
        components: "Motus, Vox",
        faith: 15,
        range: "Touch",
        duration: "[P] minutes",
        description: "For the duration, the target creatureâ€™s unholy trait is suppressed."
    },
    "blessing of purification": {
        action: "Minor Action",
        components: "Motus",
        faith: 4,
        range: "10m",
        description: "If the target is a creature, you remove [P] stacks of the poisoned condition from it.\nIf the target is a food or drink, you make it safe to consume, neutralising any poisons in it and removing any harmful impurities."
    },
    "blessing of health": {
        action: "Major Action",
        components: "Motus, Vox",
        faith: 7,
        range: "Touch",
        description: "You cure the target of a disease."
    },
    "blessing of wound closure": {
        action: "Minor Action",
        components: "Vox",
        faith: 5,
        range: "Touch",
        description: "The target creature loses [P] stacks of bleeding."
    },
    "blessing of guidance": {
        action: "Major Action",
        components: "Motus, Vox",
        faith: 10,
        range: "10m",
        duration: "1 minute",
        description: "For the duration, the target creature gains a +[P] bonus to all tests made with one attribute that you choose when bestowing this blessing."
    },
    "blessing of smiting": {
        action: "Minor Action",
        components: "Motus",
        faith: 3,
        range: "Touch",
        description: "The target of this blessing can be either a weapon, or up to 20 pieces of ammunition. The next time the target deals damage to an unholy creature, it deals an extra +[P] fire damage to it that ignores resistances, vulnerabilities and armor."
    },
    "blessing of comprehension": {
        action: "Major Action",
        components: "Vox",
        faith: 6,
        range: "20m",
        duration: "1 hour",
        description: "Up to [P] target creatures within range understand all spoken and written languages for the duration. The blessing fails for targets that donâ€™t understand any languages before the blessing is bestowed."
    },
    "blessing of comfort": {
        action: "Major Action",
        components: "Motus, Vox",
        faith: 5,
        range: "10m",
        duration: "[P] hours",
        description: "For the duration, the target creature is unaffected by extreme temperatures, like the heat of a desert or the cold of a glacier."
    }
}

function UpdateBlessing(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_blessing_" + rowId + "_";

    getAttrs([prefix+"blessing_name", "prayer"], function(values) {
        let blessingName = values[prefix+"blessing_name"] || "";

        let listBlessing = blessings[blessingName.toLowerCase()];
        if(listBlessing !== undefined) {
            let attributes = {};

            attributes[prefix+"blessing_action"] = listBlessing.action;
            attributes[prefix+"blessing_components"] = listBlessing.components;
            attributes[prefix+"blessing_faith"] = listBlessing.faith;
            attributes[prefix+"blessing_range"] = listBlessing.range;
            attributes[prefix+"blessing_area"] = listBlessing.area;
            attributes[prefix+"blessing_duration"] = listBlessing.duration;
            attributes[prefix+"blessing_description"] = listBlessing.description;

            setAttrs(attributes);
        }
    });
}

let runes= {
    "calidum": {
        target: "Object or Creature",
        natura: "1 Fire",
        description: "Target gets warmed up to nice and cozy temperatures in cold environments. A creature affected by the Calidum rune or wearing a piece of clothing with the Calidum rune suffers no ill effects from non-magical cold weather and gains a +[P] bonus on tests made to resist the frozen condition."
    },
    "frigus": {
        target: "Object or Creature",
        natura: "1 Water",
        description: "Target gets chilled down to nice and cozy temperatures in hot environments. A creature affected by the Frigus rune or wearing a piece of clothing with the Frigus rune suffers no ill effects from non-magical hot weather and gains a +[P] bonus on tests made to resist the burning condition."
    },
    "reparo": {
        target: "Object",
        natura: "2 Earth",
        description: "Target object regains [P] health points every hour, as any damage done to it is slowly mended. This does not restore any magical properties."
    },
    "sano": {
        target: "Creature",
        natura: "2 Earth",
        description: "Target creature regains [P] health points at the end of every rest."
    },
    "conservo": {
        target: "Object (Container)",
        natura: "1 Earth, 1 Water",
        description: "Perishable objects, like food for example, that are stored inside the target container stay fresh for an additional [P] days."
    },
    "respiratio": {
        target: "Creature",
        natura: "2 Air",
        description: "Target creature can hold its breath for an additional [P] minutes."
    },
    "purgo": {
        target: "Object (Container)",
        natura: "1 Water, 2 Fire",
        description: "Water and other drinks inside the target container are purified of all non-magical poisons and become safe to drink. Potions and Elixirs with a Potency below [P] are purified as well, turning them into water."
    },
    "levis": {
        target: "Object or Creature",
        natura: "1 Air, 1 Earth",
        description: "Target object or creature has its weight reduced by [P]kg to a minimum of 1kg."
    },
    "gravis": {
        target: "Object or Creature",
        natura: "2 Earth",
        description: "Target object or creature has its weight increased by [P]kg."
    },
    "sera": {
        target: "Object (Container)",
        natura: "2 Earth",
        description: "Target container becomes locked magically. The lock can be unlocked temporarily using a passphrase determined when carving the rune and locked again by the same phrase or a different one also determined when carving the rune. A Sera rune canâ€™t be picked but it can be forced open with brute force as if it was a lock with rating [P]."
    },
    "mundo": {
        target: "Object",
        natura: "2 Water",
        description: "Target object is cleaned and canâ€™t get soiled in any non-magical way."
    },
    "protego": {
        target: "Object (Clothing, Armor, or Shield)",
        natura: "2 Earth",
        description: "Target piece of clothing or armor, or shield gets a +1 bonus to its Armor Value. This bonus can not increase the targetâ€™s Armor Value above [P]."
    },
    "silentium": {
        target: "Surface (Door, Window, Wall, Floor, or Ceiling inside a closed room)",
        natura: "3 Air",
        description: "Target roomâ€™s walls, doors, windows, floors, and ceilings become soundproof while all doors and windows are closed. Sounds that arenâ€™t particularly loud, like explosions or yelling can neither enter nor escape the room while it is closed. The rune can only affect a room that is no larger than [P]m in any dimension, but can be stacked with other Silentium runes to increase that limit additively."
    },
    "damnum": {
        target: "Up to 10 pieces of Ammunition or 1 Weapon",
        natura: "1 Fire, or 1 Air, or 1 Earth, or 1 Water",
        description: "Target pieces of ammunition or weapon are enchanted to inflict additional effects based on the Element of Natura used when carving the rune.\nFire: On hit, they deal +[P] fire damage.\nAir: On hit, the target is pushed back 2m.\nEarth: On hit, the target takes +[P] blunt damage.\nWater: On hit, the target takes +[P] cold damage."
    },
    "clypeus cordis": {
        target: "Object (Armor or Shield)",
        natura: "2 Earth",
        description: "Generates a shimmering protective barrier around the wearer of the target armor or shield. The barrier has a pool of [P] health points. When the target object or its wearer takes damage, the barrier takes damage first with no vulnerabilities or resistances and any leftover damage carries over."
    },
    "radians": {
        target: "Object",
        natura: "1 Fire",
        description: "The rune emits a warm glow, emitting dim light in a [P] x 2m radius."
    },
    "supprimo": {
        target: "Object or Creature",
        natura: "2 Air, 2 Earth, 2 Fire, 2 Water",
        description: "Every curse with a Power of [P] or lower that is affecting the target is suppressed for the target as long as this rune is active. The rune fades after [P] hours, upon which any suppressed curses continue."
    },
    "visio obscura": {
        target: "Creature",
        natura: "1 Air, 1 Fire",
        description: "The target gains Night Vision out to [P] x 2m."
    },
    "vita surripuit": {
        target: "Object (Melee Weapon)",
        natura: "1 Earth, 1 Fire, 3 Water",
        description: "The target melee weapon is enhanced to steal health from enemies. Once per turn, when the weapon hits a creature, the wielder of the weapon heals for the damage dealt after armor, vulnerabilities and resistances (to a maximum of [P] hit points)."
    },
    "auge salus": {
        target: "Creature",
        natura: "2 Earth, 3 Water",
        description: "Target creatureâ€™s maximum hit points are increased by +[P]."
    }
}

function UpdateRune(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_rune_" + rowId + "_";

    getAttrs([prefix+"rune_name"], function(values) {
        let runeName = values[prefix+"rune_name"] || "";

        let listRune = runes[runeName.toLowerCase()];
        if(listRune !== undefined) {
            let attributes = {};

            attributes[prefix+"rune_target"] = listRune.target;
            attributes[prefix+"rune_natura"] = listRune.natura;
            attributes[prefix+"rune_description"] = listRune.description;

            setAttrs(attributes);
        }
    });
}

let rituals = {
    "scrying": {
        essence: "5 Air, 5 Water, 5 Earth",
        description: "As part of this ritual you infuse a reflective surface like a puddle of water, a mirror, or a shiny piece of metal that must not move while the ritual is being performed.\nChoose a target creature, object, or place. Make a Spellwork [WIL] test with a difficulty of 10 that is modified based on how familiar you are with the target and what sort of physical connection you have to it. If the target is a creature, the base difficulty is equal to that creatureâ€™s Willpower test instead of 10. If you succeed on your test, the ritual takes effect, otherwise it fails.\nFor the next [P] Ã— 10 minutes the target and its surroundings are visible and audible through the infused surface as if it was following it around. If the target is a creature, it feels observed."
    },
    "nightvision": {
        essence: "3 Fire, 3 Air",
        description: "As part of this ritual you infuse up to [P] willing creatures that must not move while the ritual is being performed.\nThe target creatures gain Nightvision for the next 12 hours."
    },
    "water breathing": {
        essence: "3 Air, 3 Water",
        description: "As part of this ritual you infuse up to [P] willing creatures that must not move while the ritual is being performed.\nThe target creatures gain the ability to breathe underwater for the next 12 hours."
    },
    "warming": {
        essence: "3 Fire",
        description: "As part of this ritual you infuse a willing creature that must not move while the ritual is being performed.\nThe target creature is unaffected by extreme cold temperatures for the next [P] days. No damage resistance is gained in this way."
    },
    "cooling": {
        essence: "2 Air, 1 Water",
        description: "As part of this ritual you infuse a willing creature that must not move while the ritual is being performed.\nThe target creature is unaffected by extreme heat for the next [P] days. No damage resistance is gained in this way."
    },
    "beauty": {
        essence: "2 Fire, 2 Air, 2 Earth, 2 Water",
        description: "As part of this ritual you infuse a willing humanoid creature that must not move while the ritual is being performed.\nThe target becomes a more beautiful version of itself and gains a +[P] bonus to Social tests for the next 24 hours, after which it is returned to its former appearance."
    },
    "disguise": {
        essence: "4 Air, 4 Earth",
        description: "As part of this ritual you infuse a willing human that must not move while the ritual is being performed.\nThe target turns into a different person with an appearance and voice of your choice. It can be any person you have seen before or a new person with an entirely made up appearance and voice, as long as the desired outcome is no more than 50 cm taller or smaller than the target. The target remains in this form for [P] hours, after which it reverts back."
    },
    "locate": {
        essence: "3 Air, 3 Water, 3 Earth",
        description: "As part of this ritual you infuse a map, compass, divining rod or something similar that must not move while the ritual is being performed.\nChoose a target creature, object, or place. Make a Spellwork [WIL] test with a difficulty of 10 that is modified based on how familiar you are with the target and what sort of physical connection you have to it. If the target is a creature, the base difficulty is equal to that creatureâ€™s Willpower test instead of 10. If you succeed on your test, the ritual takes effect, otherwise it fails.\nFor the next [P] Ã— 10 minutes the infused object shows the location of the target. For example, a dot on an infused map, or the compass pointing towards the target instead of north."
    },
    "astral projection": {
        essence: "10 Air, 5 Water",
        description: "You project your consciousness to a place of your choice within [P] km that you can see or describe (for example 200m north, or behind the door). You appear at the target location as an incorporeal spectral ghost that looks like yourself. While in this form, you can float in all directions at a speed of 20m and can move through objects and creatures. You can not interact with the world around you in any physical way but you can talk as normal. While in this form, your physical body remains in a deep meditative unconscious state and you are unable to perceive what it perceives until you end the ritual at any point as a Minor Action. If your physical body takes any damage, the ritual ends immediately."
    },
    "dreamwalk": {
        essence: "8 Air, 3 Water",
        description: "You project your consciousness and that of up to [P] other creatures into the dream of a target sleeping creature within [P] km. If the target creature is not unconscious, the ritual fails. You and the other dreamwalkers can choose to appear as silent, invisible observers or as participants within the dream and at any point while the ritual is ongoing, you and the other dreamwalkers can switch into different participants or back to silent observers. As participants, you can interact with the dream and the dreamer. As silent observers you can not interact with the dream or the dreamer, but observe everything.\nWhen a dreamwalker takes the form of a participant, they make a Deception vs Intuition contest against the dreamer. If the dreamer wins, they notice that something is off and may choose to expel that participant from their dream, ending the ritual for the affected dreamwalker."
    },
    "identify": {
        essence: "5 Air, 10 Water",
        description: "As part of the ritual you examine an object that must not move while the ritual is being performed.\nYou learn what the object is called, what it is used for, who created it (if it was crafted in any way), where it is from (if it was not crafted but harvested from somewhere like a piece of rock, a plant or a part of a creature), what it is worth in its current state, how much Essence can be extracted from it, and what Infusions or Rituals (if any) are affecting it."
    },
    "divination warding": {
        essence: "6 Air, 6 Water",
        description: "As part of the ritual you infuse an object, creature or place (a vehicle, room, or building) no larger than [P]m in any direction that must not move while the ritual is being performed.\nFor the next [P] hours, the target is warded against scrying and magical location, causing any such rituals or other magical effects to fail on them.\nIf this ritual is successfully performed on the same object or place for 10 consecutive times without a break for 10 days in a row, the effect becomes permanent on the target.\nIf the target is already affected by this ritual, it keeps the higher powered version."
    },
    "spirit warding": {
        essence: "4 Air, 6 Water, 2 Earth",
        description: "As part of the ritual you infuse a place (a vehicle, room, or building) no larger than [P]m in any direction that must not move while the ritual is being performed.\nFor the next [P] hours, the target is warded against spirits and creatures without a physical form (like ghosts, or astral projections), making it unable for them to enter the area in any way. Any such creature already in the area is expelled to the nearest unoccupied space outside of the target area.\nIf this ritual is successfully performed on the same place for 10 consecutive times without a break for 10 days in a row, the effect becomes permanent.\nIf the target is already affected by this ritual, it keeps the higher powered version."
    },
    "monster warding": {
        essence: "4 Fire, 4 Air, 4 Water, 4 Earth",
        description: "As part of the ritual you infuse a creature or place (a vehicle, room, or building) no larger than [P]m in any direction that must not move while the ritual is being performed.\nIf the target is a place:\nFor the next [P] hours, the target is warded against monsters, making it unable for them to enter the area in any way. Any such creature already in the area is expelled to the nearest unoccupied space outside of the target area.\nIf this ritual is successfully performed on the same place for 10 consecutive times without a break for 10 days in a row, the effect becomes permanent.\nIf the target is a creature:\nFor the next [P] hours, the target is warded against monsters, making it unable for them to possess or charm them. Ongoing possessions or charms by monsters are suspended for the duration of the warding. Also, all monsters have disadvantage on attacks against the target.\nIf the target is already affected by this ritual, it keeps the higher powered version."
    },
    "death warding": {
        essence: "5 Fire, 5 Air, 5 Water, 5 Earth",
        description: "As part of the ritual you infuse a creature that must not move while the ritual is being performed.\nFor the next [P] hours, the target is warded against death. The next time the target creature would die within that time, they are reduced to 1 hit point instead, ending the ritual.\nIf the target is already affected by this ritual, it keeps the higher powered version."
    },
    "[damage type] warding": {
        essence: "3 Fire, 3 Air, 3 Water, 3 Earth",
        description: "As part of the ritual you infuse a creature or object no larger than [P]m in any direction that must not move while the ritual is being performed.\nFor the next [P] hours, the target becomes resistant against one damage type of your choice.\nIf the target is already affected by this ritual with the same damage type selected, it keeps the higher powered version. If the target is affected by another version of this ritual with a different damage type selected, both versions of the ritual remain in effect."
    },
    "open portal": {
        essence: "20 Air",
        description: "As part of the ritual you infuse a surface.\nChoose a target location within [P] x 10km that you have either been to before, can see, or that you have an associated object of. An associated object can be anything that has either spent at least a year at the target location or has been there in the last 24 hours.\nAt the end of the ritual, a portal in the shape of your choice, but no larger than [P]m in any dimension opens on the surface you infused. At the same time a connected portal opens in the target location aligned just like the surface you infused. Both portals can only be walked through on one side and the other side is opaque and solid.\nThe portals remain open until [P] minutes have passed, upon which they collapse instantly, cutting any objects or creatures within clean through."
    },
    "blade bond": {
        essence: "10 Air, 5 Earth",
        description: "Even though the name suggests otherwise, this ritual works on any target object up to [P] Slots in size and weight. This ritual binds the target to you magically.\nAs a Minor Action, you can summon an object bound to you by this ritual, making it appear in your empty hand(s), on your body (if itâ€™s a piece of clothing or armor) or in an empty space directly in front of you.\nThe ritual is most commonly used on daggers and swords, which is where the name comes from, but can be and is used on all kinds of objects.\nAn object can only be bound to one creature by this ritual. Performing this ritual again on an object already bound by it to a creature will remove the previous bond."
    },
    "bought time": {
        essence: "20 Air, 20 Earth, 20 Fire, 20 Water",
        description: "At the end of this ritual, make a Spellwork [WIL] or Spellwork [BOD] test against 20 + [P].\nOn a success, the ritual succeeds and your life expectancy increases by [P] years. You can choose to also reduce your apparent age, meaning your physical appearance, by up to that same amount.\nOn a failure, the ritualâ€™s effect is reversed and you immediately grow [P] years older."
    }
};

function UpdateRitual(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_ritual_" + rowId + "_";

    getAttrs([prefix+"ritual_name"], function(values) {
        let ritualName = values[prefix+"ritual_name"] || "";

        let listRitual = rituals[ritualName.toLowerCase()];
        if(listRitual !== undefined) {
            let attributes = {};

            attributes[prefix+"ritual_essence"] = listRitual.essence;
            attributes[prefix+"ritual_description"] = listRitual.description;

            setAttrs(attributes);
        }
    });
}

let spells = {
    "fire bolt": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Fire",
        range: "20m",
        attackType: "Ranged",
        damage: "[P]d6 Fire",
        description: "You hurl a flame at a target within range. Make a ranged spell attack against the target. If it hits, you deal [P]d6 fire damage to them and they gain 1 stack of burning."
    },
    "fireball": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "5 Fire",
        range: "20m",
        area: "10m Sphere",
        saveType: "Evasion",
        saveDTType: "srd",
        damage: "[P]d6 Fire",
        description: "You hurl a ball of fire that explodes. All creatures and objects in the target area must make an Evasion test. A target takes [P]d6 fire damage and gains 1 stack of burning on a failed test. On a successful test it takes half damage and no stack of burning."
    },
    "water bolt": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Water",
        range: "20m",
        attackType: "Ranged",
        damage: "[P]d6 Blunt",
        description: "You hurl a mote of water at a target within range. Make a ranged spell attack against the target. If it hits, you deal [P]d6 blunt damage to them and they become wet."
    },
    "waterball": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "5 Water",
        range: "20m",
        area: "10m Sphere",
        saveType: "Evasion",
        saveDTType: "srd",
        damage: "[P]d6 Blunt",
        description: "You hurl a ball of water that explodes. All creatures and objects in the target area must make an Evasion test. A target takes [P]d6 blunt damage and becomes wet on a failed test. On a successful test it takes half damage and doesnâ€™t become wet."
    },
    "tremor": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Earth",
        range: "20m",
        saveType: "Evasion",
        saveDTType: "srd",
        damage: "[P]d6 Blunt",
        description: "The ground beneath a target within range shakes. The target must make an Evasion test. It takes [P]d6 blunt damage on a fail and falls prone. On a successful test it takes half damage and doesnâ€™t fall prone."
    },
    "earthquake": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "5 Earth",
        range: "20m",
        area: "10m Circle",
        saveType: "Evasion",
        saveDTType: "srd",
        damage: "[P]d6 Blunt",
        description: "The ground in the target area within range shakes. All creatures must make an Evasion test. A target takes [P]d6 blunt damage on a fail and falls prone. On a successful test it takes half damage and doesnâ€™t fall prone."
    },
    "air bolt": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Air",
        range: "20m",
        attackType: "Ranged",
        damage: "[P]d6 Slashing",
        description: "You send a mote of condensed air at a target within range. Make a ranged spell attack against the target. If it hits, you deal [P]d6 slashing damage to them and push them 2m away from you."
    },
    "air bomb": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "5 Air",
        range: "20m",
        area: "10m Sphere",
        saveType: "Evasion",
        saveDTType: "srd",
        damage: "[P]d6 Blunt",
        description: "You hurl a mote of condensed air that explodes. All creatures and objects in the target area must make an Evasion test. A target takes [P]d6 blunt damage and is pushed 2m away from the center of the explosion. On a successful test it takes half damage and is not pushed away."
    },
    "icicle": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "2 Water, 2 Air",
        range: "20m",
        attackType: "Ranged",
        damage: "[P]d6+[P] Cold",
        description: "You hurl a pointy icicle at a target within range. Make a ranged spell attack against the target. If it hits, you deal [P]d6 + [P] cold damage to them and they gain 1 stack of bleeding."
    },
    "lava mote": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "2 Fire, 2 Earth",
        range: "20m",
        attackType: "Ranged",
        damage: "[P]d6 Blunt + [P] Fire",
        description: "You hurl a mote of molten rock at a target within range. Make a ranged spell attack against the target. If it hits, you deal [P]d6 blunt + [P] fire damage to them and they gain 1 stack of burning."
    },
    "spark": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "2 Fire, 2 Air",
        range: "20m",
        attackType: "Ranged",
        damage: "[P]d6+[P] Electrical",
        description: "You send an electrical spark to a target within range. Make a ranged spell attack against the target. If it hits, you deal [P]d6 + [P] electrical damage to them and they become nauseous until the end of their next turn."
    },
    "steam cloud": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Fire, 3 Water",
        range: "20m",
        area: "10m Sphere",
        saveType: "Body",
        saveDTType: "srd",
        damage: "[P]d6+[P] Fire",
        description: "You create a cloud of hot water vapour in the target area that disperses quickly. All creatures in the area must make a Body test. They take [P]d6 + [P] fire damage and become wet on a failed test. On a successful test, they take half damage and donâ€™t become wet."
    },
    "acid splash": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Water, 3 Earth",
        range: "20m",
        area: "10m Circle",
        attackType: "Ranged",
        damage: "[P]d8+[P] Acid",
        description: "You hurl a mote of acid at a target within range. Make a ranged spell attack against the target. If it hits, you deal [P]d8 + [P] acid damage to them."
    },
    "acid rain": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "5 Water, 5 Earth",
        range: "20m",
        area: "10m/20m Cylinder",
        saveType: "Evasion",
        saveDTType: "srd",
        damage: "[P]d8+[P] Acid",
        description: "You make it rain acid in the target area. All creatures in the area must make an Evasion test. They take [P]d8 + [P] acid damage on a failed test. On a successful test, they take half damage."
    },
    "dust cloud": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "2 Earth, 2 Air",
        range: "20m",
        area: "10m Sphere",
        duration: "[P] minutes",
        description: "You create a cloud of dust in the target area that remains for the duration. The area in the cloud is heavily obscured. A strong wind can disperse the cloud, ending the spell."
    },
    "break warding": {
        action: "Major Action",
        components: "Vox",
        natura: "1 Air, 5 Fire, 1 Earth",
        range: "Touch",
        description: "You break a warding with a Power less or equal to [P], ending its effect on the target creature, object or place (a vehicle, room, or building). You can use this spell to attempt to break a warding with a higher power, but you need to succeed on a Spellwork [WIL] test against 10 + the wardingâ€™s power."
    },
    "levitate": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "4 Air",
        range: "20m",
        duration: "[P] minutes (C)",
        saveType: "Willpower",
        saveDTType: "srd",
        description: "You attempt to lift a target creature or object no heavier than [P] x 50 kg within range up to 10m up into the air for the duration. If the target is an unwilling creature, it can make a Willpower test to resist the spell on a success. While affected, the target has its speed reduced to 0 and canâ€™t benefit from effects that increase its speed. The target can use a Major Action on its turn to repeat the Willpower test, ending the spell on a success.\nOn each of your turns while this spell is active, you can use a Minor Action to move the target up to 10m in any direction, but not through solid objects."
    },
    "unlock": {
        action: "Major Action",
        components: "Motus",
        natura: "3 Air, 1 Earth",
        range: "10m",
        description: "You unlock a target lock within range with a lock raring of [P] or lower. If the lock rating of the target is higher, you need to succeed on a Spellwork [WIL] test against 10 + the target lockâ€™s rating, otherwise the spell fails.\nAlternatively, you can unlock a magical lock, in which case you apply the same rules except instead of the lock rating, you use the Power of the magic that keeps the lock locked."
    },
    "deflect": {
        action: "Minor Reaction",
        components: "Motus",
        natura: "1 Air, 1 Earth",
        range: "Self",
        description: "When youâ€™re attacked by a creature you can see, you can use this spell to attempt to deflect the attack. You gain a +5 + [P] bonus to your Evasion test against the triggering attack. You can declare using this spell after rolling your Evasion test but before you know whether you would be hit or not."
    },
    "reflect": {
        action: "Major Reaction",
        components: "Motus, Vox",
        natura: "1 Air, 2 Earth, 1 Water",
        range: "Self",
        attackType: "Ranged",
        description: "When youâ€™re attacked by a creature you can see, you can use this spell to attempt to deflect the attack and possibly make it reflect back to the attacker. You gain a +5 + [P] bonus to your Evasion test against the triggering attack. You can declare using this spell after rolling your Evasion test but before you know whether you would be hit or not. If the attack misses you, make a melee spell attack (if the triggering attack was a melee attack) or a ranged spell attack (if the triggering attack was a ranged attack) against the attacker. On a hit, the attacker takes the damage of his own attack."
    },
    "control fire": {
        action: "Minor Action",
        components: "Motus",
        natura: "1 Fire",
        range: "[P] x 10m",
        description: "You control the element of fire in a small manner around you. Choose one of the following effects:\n- You instantly light or snuff out all flammable objects (candles, oil-lamps, braziers, bonfires, and the like) in a [P]m cube within range.\n- You change the colour of all fires in a [P]m cube within range to any colour you like.\n- You warm up an object that you can see that is no larger than [P]m in any dimension for up to 10 minutes, after which it may cool down again. You canâ€™t make it hot enough to hurt someone this way.\n- You remove [P] stacks of burning from a creature within range that you can see."
    },
    "control water": {
        action: "Minor Action",
        components: "Motus",
        natura: "1 Water",
        range: "[P] x 10m",
        description: "You control the element of water in a small manner around you. Choose one of the following effects:\n- You instantly freeze or unfreeze up to [P] liters of water within range that you can see.\n- You force any droplets of rain that would fall on a target creature or object no larger than [P]m in any dimension within range that you can see to avoid the target just before they would hit it and fall to the ground next to it instead.\n- You instantly dry or wet a surface, object, or creature no larger than [P]m in any dimension that you can see within range."
    },
    "blink": {
        action: "Minor Action",
        components: "Motus",
        natura: "3 Air",
        range: "[P] x 5m",
        description: "You along with everything youâ€™re wearing or carrying instantly disappear and reappear in an unoccupied space within range. If you try to blink into a space that is occupied, the spell fails and the Natura is lost."
    },
    "group blink": {
        action: "Minor Action",
        components: "Motus",
        natura: "5 Air",
        range: "[P] x 5m",
        description: "You and up to [P] creatures youâ€™re touching along with everything you and them are wearing or carrying instantly disappear and reappear in an unoccupied space within range. If you try to blink into a space that is occupied, the spell fails and the Natura is lost. If there is enough space at the target location for at least yourself, the spell still takes effect but any target creature that doesn't fit the target space with you is left behind."
    },
    "teleport": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "6 Air",
        range: "[P] x 10km",
        description: "Pick a target location within range that you have either been to before, can see, or that you have an associated object of. An associated object can be anything that has either spent at least a year at the target location or has been there in the last 24 hours.\nYou along with everything youâ€™re wearing or carrying instantly disappear and reappear in an unoccupied space close to the target. If there is no unoccupied space close to the target, the spell fails and the Natura is lost."
    },
    "group teleport": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "10 Air",
        range: "[P] x 10km",
        description: "Pick a target location within range that you have either been to before, can see, or that you have an associated object of. An associated object can be anything that has either spent at least a year at the target location or has been there in the last 24 hours.\nYou and up to [P] creatures youâ€™re touching along with everything you and them are wearing or carrying instantly disappear and reappear in an unoccupied space close to the target. If there is no unoccupied space close to the target, the spell fails and the Natura is lost. If there is enough space at the target location for at least yourself, the spell still takes effect but any target creature that doesn't fit the target space with you is left behind."
    },
    "glow": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "2 Fire",
        description: "An object you touch starts glowing, giving off bright light in a 10m radius and dim light in a 10 m radius beyond that for up to [P] hours or until you end the spell at any point requiring no action. Casting this spell on an object that is already affected by this spell, resets the duration to the new Glow spellâ€™s duration and increases the light radius additively."
    },
    "hex": {
        action: "Minor Reaction",
        components: "Vox",
        natura: "1 Air, 2 Water",
        range: "[P] x 10m",
        description: "When a creature you can see or hear within range makes a test that youâ€™re aware of, you can cast this spell to impose disadvantage on the creatureâ€™s roll."
    },
    "stupor": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Earth, 3 Water",
        duration: "1 minute (C)",
        description: "You speak a powerful command at a target creature you can see within range. The target must make a Willpower test against 10 + [P]. On a failure, the target becomes paralyzed for the duration."
    },
    "mindlink": {
        action: "Major Action",
        components: "Motus",
        natura: "5 Air",
        range: "[P]km",
        duration: "5 minutes (C)",
        description: "You create a temporary mental connection between yourself and a creature within range that you have met before. If the creature is willing, the connection is established, allowing you to talk to them telepathically for the duration."
    },
    "silence": {
        action: "Major Action",
        components: "Vox",
        natura: "5 Air",
        duration: "[P] minutes (C)",
        description: "A target creature within range becomes unable to speak, sing, or otherwise make sounds with their mouth."
    },
    "restrain": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Earth",
        range: "10m",
        duration: "1 minute (C)",
        description: "A target creature within range must succeed on a DT 10 + [P] Athletics [BOD] or Evasion test or become restrained by magical chains, vines, or similar, that appear and wrap around it. At the end of each of the targetâ€™s turns, it can attempt a DT 10 + [P] Athletics [BOD] test to break free, ending the spell on a success."
    },
    "chain pull": {
        action: "Minor Action",
        components: "Motus",
        natura: "1 Air, 1 Earth",
        range: "[P] x 10m",
        attackType: "Ranged",
        description: "Make a ranged spell attack against a target creature within range. On a hit, the target gets pulled up to [P] x 4m towards you by a magical chain, vine, or similar."
    },
    "air bubble": {
        action: "Major Action",
        components: "Motus",
        natura: "3 Air",
        range: "Touch",
        duration: "[P] hours",
        description: "The target creatureâ€™s head is surrounded by a bubble of breathable air for the duration. Gases, smoke, dust, and liquids are kept out of the bubble and the air inside the bubble is always fresh and breathable, no matter the surrounding environment."
    },
    "command": {
        action: "Major Action",
        components: "Vox",
        natura: "5 Air, 1 Fire, 1 Water",
        duration: "[P] minutes",
        saveType: "Willpower",
        saveDTType: "srd",
        description: "You utter a simple command to a target creature that can hear and understand you. The target must succeed on a Willpower test or become charmed by you. While charmed in this way, the target must obey and fulfill the command you uttered when casting the spell to the best of its ability. If the command would result in the target getting hurt, it has advantage on the Willpower test. At the end of each of the targetâ€™s turns, it can repeat the Willpower test and end the spell on a success."
    },
    "enthrall": {
        action: "Major Action",
        components: "Vox",
        natura: "10 Air, 3 Fire, 2 Water",
        duration: "[P] hours",
        saveType: "Willpower",
        saveDTType: "srd",
        description: "You utter a command to a target creature that can hear and understand you. The target must succeed on a Willpower test or become charmed by you. While charmed in this way, the target must obey and fulfill the command you uttered when casting the spell to the best of its ability. If the command would result in the target getting hurt, it has advantage on the Willpower test."
    },
    "clean": {
        action: "Minor Action",
        components: "Motus",
        natura: "1 Air",
        range: "10m",
        description: "You magically clean up to [P] creatures of your choice that you can see within range. Their skin, hair, clothes, and equipment are dried and cleaned of any dirt or grime. Alternatively, you can target an area up to [P]m in any dimension and affect all surfaces and objects not worn or carried by creatures inside it in the same way."
    },
    "ignite": {
        action: "Major Action",
        components: "Motus, Vox",
        natura: "3 Fire",
        range: "20m",
        description: "The target object or creature ignites and gains [P] stacks of the burning condition."
    }
};

function UpdateSpell(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];

    DoUpdateSpell(rowId);
}

function UpdateSpells() {
    getSectionIDs("spell", function(ids) {
        for(var i = 0; i < ids.length; i++) {
            DoUpdateSpell(ids[i]);
        }
    });
}

function DoUpdateSpell(rowId) {
    let prefix = "repeating_spell_" + rowId + "_spell_";

    getAttrs(
        [
            prefix+"name",
            "spellwork",
            "essence_air",
            "essence_earth",
            "essence_fire",
            "essence_water",
            "elementalAttunement"
        ],
        function(values) {
            let spellName = values[prefix+"name"] || "";
            let spellworkRanks = parseInt(values["spellwork"]) || 0;
            let airEssence = parseInt(values["essence_air"]) || 0;
            let earthEssence = parseInt(values["essence_earth"]) || 0;
            let fireEssence = parseInt(values["essence_fire"]) || 0;
            let waterEssence = parseInt(values["essence_water"]) || 0;
            let elementalAttunement = values["elementalAttunement"] || "";

            let listSpell = spells[spellName.toLowerCase()];
            let attributes = {};

            if(listSpell !== undefined) {

                attributes[prefix+"action"] = (listSpell.action||"");
                attributes[prefix+"components"] = (listSpell.components||"");
                attributes[prefix+"natura"] = (listSpell.natura||"");
                attributes[prefix+"range"] = (listSpell.range||"");
                attributes[prefix+"area"] = (listSpell.area||"");
                attributes[prefix+"duration"] = (listSpell.duration||"");
                attributes[prefix+"description"] = (listSpell.description||"");
                attributes[prefix+"attackType"] = (listSpell.attackType||"none");
                attributes[prefix+"saveType"] = (listSpell.saveType||"none");
                attributes[prefix+"saveDTType"] = (listSpell.saveDTType||"");
                attributes[prefix+"damage"] = (listSpell.damage||"");
            }

            // Parse Natura field
            if(listSpell.natura != undefined) {
                let naturaRegex = /[+-]?\d* (?:Fire|Air|Earth|Water)/gi;
                let matches = listSpell.natura.match(naturaRegex);
                let fireCost = 0;
                let waterCost = 0;
                let earthCost = 0;
                let airCost = 0;

                for(let match of matches) {
                    let splitMatch = match.split(" ");
                    let amount = parseInt(splitMatch[0]);
                    let element = splitMatch[1];

                    switch(element.toLowerCase()) {
                        case "fire":
                            fireCost += amount;
                            break;
                        case "water":
                            waterCost += amount;
                            break;
                        case "earth":
                            earthCost += amount;
                            break;
                        case "air":
                            airCost += amount;
                            break;
                    }
                }
                
                // Elemental Attunement
                if(elementalAttunement.toLowerCase() == "fire") {
                    fireCost = Math.max(fireCost, fireCost-1);
                }
                if(elementalAttunement.toLowerCase() == "water") {
                    waterCost = Math.max(waterCost, waterCost-1);
                }
                if(elementalAttunement.toLowerCase() == "earth") {
                    earthCost = Math.max(earthCost, earthCost-1);
                }
                if(elementalAttunement.toLowerCase() == "air") {
                    airCost = Math.max(airCost, airCost-1);
                }

                if(fireCost > fireEssence
                    || waterCost > waterEssence
                    || earthCost > earthEssence
                    || airCost > airEssence) {
                    attributes[prefix + "error"] = "Not enough Essence!";
                }
                else {
                    attributes[prefix + "error"] = " ";
                }
            }
            
            setAttrs(attributes);
        }
    );
}

let meleeWeapons = {
    "brass knuckle": {
        skill: "Brawling",
        properties: {
            light: true
        },
        damage: "1d4 Blunt"
    },
    "cestus": {
        skill: "Brawling",
        properties: {
            light: true
        },
        damage: "1d6 Blunt"
    },
    "knife": {
        skill: "One-Handed Melee",
        properties: {
            light: true
        },
        damage: "1d4 Slashing"
    },
    "dagger": {
        skill: "One-Handed Melee",
        properties: {
            light: true
        },
        damage: "1d4 Piercing"
    },
    "throwing knife": {
        skill: "One-Handed Melee",
        properties: {
            light: true,
            thrown: {
                close: "6m",
                long: "18m"
            }
        },
        damage: "1d4 Piercing"
    },
    "broadsword": {
        skill: "One-Handed Melee",
        damage: "1d8 Slashing"
    },
    "longsword": {
        skill: "One-Handed Melee",
        properties: {
            Versatile: "1d12"
        },
        damage: "1d10 Slashing"
    },
    "cutlass": {
        skill: "One-Handed Melee",
        properties: {
            light: true
        },
        damage: "1d6 Slashing"
    },
    "rapier": {
        skill: "One-Handed Melee",
        damage: "1d8 Slashing"
    },
    "smallsword": {
        skill: "One-Handed Melee",
        properties: {
            light: true
        },
        damage: "1d6 Piercing"
    },
    "cane sword": {
        skill: "One-Handed Melee",
        damage: "1d6 Slashing"
    },
    "hardened cane": {
        skill: "One-Handed Melee",
        damage: "1d6 Blunt"
    },
    "baton": {
        skill: "One-Handed Melee",
        properties: {
            light: true
        },
        damage: "1d8 Blunt"
    },
    "spiked club": {
        skill: "One-Handed Melee",
        damage: "1d6 Blunt 1d4 Piercing"
    },
    "mace": {
        skill: "One-Handed Melee",
        damage: "1d8 Blunt"
    },
    "warhammer": {
        skill: "One-Handed Melee",
        properties: {
            Versatile: "1d10"
        },
        damage: "1d8 Blunt"
    },
    "war pick": {
        skill: "One-Handed Melee",
        properties: {
            Versatile: "1d10"
        },
        damage: "1d8 Piercing"
    },
    "battle axe": {
        skill: "One-Handed Melee",
        properties: {
            Versatile: "1d10"
        },
        damage: "1d8 Slashing"
    },
    "throwing axe": {
        skill: "One-Handed Melee",
        properties: {
            thrown: {
                close: "6m",
                long: "18m"
            }
        },
        damage: "1d6 Slashing"
    },
    "hatchet": {
        skill: "One-Handed Melee",
        properties: {
            light: true
        },
        damage: "1d6 Slashing"
    },
    "staff": {
        skill: "One-Handed Melee",
        properties: {
            Versatile: "1d8"
        },
        damage: "1d6 Blunt"
    },
    "greatsword": {
        skill: "Two-Handed Melee",
        properties: {
            twoHanded: true
        },
        damage: "2d6 Slashing"
    },
    "maul": {
        skill: "Two-Handed Melee",
        properties: {
            twoHanded: true
        },
        damage: "1d12 Blunt"
    },
    "pike": {
        skill: "Two-Handed Melee",
        properties: {
            twoHanded: true
        },
        damage: "1d8 Piercing"
    },
    "halberd": {
        skill: "Two-Handed Melee",
        properties: {
            twoHanded: true
        },
        damage: "1d8 Slashing"
    },
    "glaive": {
        skill: "Two-Handed Melee",
        properties: {
            twoHanded: true
        },
        damage: "1d10 Piercing"
    },
    "whip": {
        skill: "Two-Handed Melee",
        properties: {
            twoHanded: true
        },
        damage: "1d6 Slashing"
    }
};

function UpdateMeleeWeapon(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];

    DoUpdateMeleeWeapon(rowId);
    UpdateMeleeWeaponRoll(eventInfo);
}

function UpdateMeleeWeapons() {
    getSectionIDs("meleeWeapon", function(ids) {
        for(var i = 0; i < ids.length; i++) {
            let prefix = "repeating_meleeWeapon_" + ids[i] + "_";

            DoUpdateMeleeWeapon(ids[i]);
            UpdateMeleeWeaponRoll({sourceAttribute: prefix});
        }
    });
}

function DoUpdateMeleeWeapon(id) {
    let prefix = "repeating_meleeWeapon_" + id + "_";
    
    getAttrs([prefix+"meleeWeapon_name", prefix+"meleeWeapon_weaponExpert", prefix+"meleeWeapon_skill", prefix+"meleeWeapon_damage"], function(values) {
        let weaponName = values[prefix+"meleeWeapon_name"] || "";
        let isWeaponExpert = values[prefix + "meleeWeapon_weaponExpert"] == 'on';
        let weaponSkill = values[prefix+"meleeWeapon_skill"] || "";
        let weaponDamage = values[prefix+"meleeWeapon_damage"] || "";

        let listWeapon = meleeWeapons[weaponName.toLowerCase()];
        let skill = listWeapon !== undefined? listWeapon.skill : weaponSkill;

        let sanitizedSkillName = skill.toLowerCase().replace(" ", "").replace("-", "");

        let attributes = {};

        if(listWeapon !== undefined) {
            attributes[prefix+"meleeWeapon_skill"] = listWeapon.skill;
        }

        getAttrs([sanitizedSkillName + "Mod", "bod", "brawling"], function(values) {
            let skillMod = values[sanitizedSkillName + "Mod"] || "+0";
            let bod = values["bod"] || "+0";
            let brawlingRanks = parseInt(values["brawling"]) || 0;

            // ATK
            attributes[prefix+"meleeWeapon_atk"] = skillMod;
            // Weapon Expert
            if(isWeaponExpert) {
                attributes[prefix+"meleeWeapon_atk"] += "+2";
            }

            // Damage
            let damageParts = weaponDamage.split(" ");
            if(listWeapon !== undefined) {
                damageParts = listWeapon.damage.split(" ");
            }
            let bodIndex = damageParts[0].search(/[\+\-]\d*[dD]?\d*\[BOD\]/g);
            if(bodIndex == -1) {
                damageParts[0] += bod + "[BOD]";
            }
            else {
                damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[BOD\]/g, bod + "[BOD]");
            }
            // Weapon Expert
            if(isWeaponExpert) {
                let weaponExpertIndex = damageParts[0].search(/[\+\-]\d*[dD]?\d*\[WeaponExpert\]/g);
                if(weaponExpertIndex == -1) {
                    damageParts[0] += "+2[WeaponExpert]";
                }
                else {
                    damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[WeaponExpert\]/g, "+2[WeaponExpert]");
                }
            }
            else {
                damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[WeaponExpert\]/g, "");
            }
            // Martial Arts
            if(skill == "Brawling" && brawlingRanks > 0) {
                let martialArtsDice = Math.floor((brawlingRanks + 2) / 3)
                let martialArtsIndex = damageParts[0].search(/[\+\-]\d*[dD]?\d*\[MartialArts\]/g);
                if(martialArtsIndex == -1) {
                    damageParts[0] += "+" + martialArtsDice + "d4[MartialArts]";
                }
                else {
                    damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[MartialArts\]/g, "+" + martialArtsDice + "d4[MartialArts]");
                }
            }
            else {
                damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[MartialArts\]/g, "");
            }

            let damageText = damageParts[0];
            for(let i = 1; i < damageParts.length; i++) {
                damageText += " " + damageParts[i];
            }

            attributes[prefix+"meleeWeapon_damage"] = damageText;

            setAttrs(attributes);
        });
    });
}

function UpdateMeleeWeaponRoll(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_meleeWeapon_" + rowId + "_";
    
    let attributes = {};

    getAttrs([prefix+"meleeWeapon_name", prefix+"meleeWeapon_damage", prefix+"meleeWeapon_atk", "athletics", "stealth"], function(values) {
        let weaponName = values[prefix+"meleeWeapon_name"] || "";
        let weaponDamage = values[prefix+"meleeWeapon_damage"] || "";
        let weaponAtk = values[prefix+"meleeWeapon_atk"] || "";
        let athleticsRanks = parseInt(values["athletics"]) || 0;
        let stealthRanks = parseInt(values["stealth"]) || 0;

        let damageParts = weaponDamage.split(" ");
        let roll = "?{Secret?|Open Roll,|Secret Roll,/w gm} &{template:custom} {{name=" + weaponName + " Attack}}";

        // To Hit
        if(weaponAtk != "") {
            roll += GetCustomTemplateAtkString(weaponAtk);
        }

        // Damage
        roll += "{{damage="
        let crit = "{{critdamage="
        let diceRegex = /\+?\d*d\d*/g;
        for(let i = 0; i < damageParts.length; i += 2) {
            roll += " [[";
            roll += damageParts[i] + "]] ";
            roll += damageParts[i + 1];
            
            // Crit
            crit += " +[[";
            let damageDice = damageParts[i].match(diceRegex);
            if(damageDice) {
                for(let j = 0; j < damageDice.length; j++) {
                    crit += damageDice[j];
                }
                crit += "]] ";
                crit += damageParts[i + 1];
            }
        }
        crit += "}}";
        roll += "}}";

        // Powerful Strikes
        if(athleticsRanks > 0) {
            roll += "{{powerfulstrikes=+" + athleticsRanks + " " + damageParts[1] + "}}"
        }

        // Sneak Attack
        let sneakAttackDamage = "";
        if(stealthRanks >= 3) {
            let sneakAttackDice = Math.floor(stealthRanks / 3);
            if(stealthRanks < 10) {
                sneakAttackDamage = sneakAttackDice + "d6";
            }
            else {
                sneakAttackDamage = sneakAttackDice + "d8";
            }
            roll += "{{sneakattack=+[[" + sneakAttackDamage + "]] " + damageParts[1] + "}}";
            roll += "{{sneakattackcrit=+[[" + sneakAttackDamage + "]] " + damageParts[1] + "}}";
        }

        attributes[prefix+"meleeWeapon_roll"] = roll + crit;

        setAttrs(attributes);
    });
}

let rangedWeapons = {
    "derringer": {
        skill: "Pistol",
        properties: {
            light: true,
            armorPiercing: 1
        },
        damage: "1d4 Piercing",
        range: "6m/20m",
        ammoMax: 1,
        ammoType: "Bullet"
    },
    "flintlock pistol": {
        skill: "Pistol",
        properties: {
            light: true,
            armorPiercing: 1
        },
        damage: "1d6 Piercing",
        range: "8m/30m",
        ammoMax: 1,
        ammoType: "Bullet"
    },
    "revolver": {
        skill: "Pistol",
        properties: {
            light: true,
            armorPiercing: 1
        },
        damage: "1d6 Piercing",
        range: "8m/30m",
        ammoMax: 6,
        ammoType: "Bullet"
    },
    "pepperbox": {
        skill: "Pistol",
        properties: {
            light: true,
            armorPiercing: 2
        },
        damage: "1d8 Piercing",
        range: "6m/20m",
        ammoMax: 4,
        ammoType: "Bullet"
    },
    "flintlock rifle": {
        skill: "Rifle",
        properties: {
            armorPiercing: 3,
            twoHanded: true
        },
        damage: "1d10 Piercing",
        range: "12m/40m",
        ammoMax: 1,
        ammoType: "Bullet"
    },
    "blunderbuss": {
        skill: "Rifle",
        properties: {
            heavy: true,
            armorPiercing: 3,
            twoHanded: true
        },
        damage: "2d6 Piercing",
        range: "6m/20m",
        ammoMax: 1,
        ammoType: "Shell"
    },
    "lever-action rifle": {
        skill: "Rifle",
        properties: {
            armorPiercing: 3,
            twoHanded: true
        },
        damage: "1d10 Piercing",
        range: "8m/30m",
        ammoMax: 7,
        ammoType: "Round"
    },
    "bolt-action rifle": {
        skill: "Rifle",
        properties: {
            armorPiercing: 3,
            twoHanded: true
        },
        damage: "1d10 Piercing",
        range: "12m/40m",
        ammoMax: 10,
        ammoType: "Round"
    },
    "shotgun": {
        skill: "Rifle",
        properties: {
            armorPiercing: 3,
            twoHanded: true
        },
        damage: "2d6 Piercing",
        range: "8m/30m",
        ammoMax: 2,
        ammoType: "Shell"
    },
    "hand-crossbow": {
        skill: "Pistol",
        properties: {
            light: true,
            silent: true,
            armorPiercing: 1
        },
        damage: "1d4 Piercing",
        range: "12m/40m",
        ammoMax: 1,
        ammoType: "Bolt"
    },
    "crossbow": {
        skill: "Rifle",
        properties: {
            twoHanded: true,
            silent: true,
            armorPiercing: 2
        },
        damage: "1d8 Piercing",
        range: "30m/120m",
        ammoMax: 1,
        ammoType: "Bolt"
    },
    "shortbow": {
        skill: "Bow",
        properties: {
            twoHanded: true,
            silent: true
        },
        damage: "1d8 Piercing",
        range: "24m/100m",
        ammoMax: 1,
        ammoType: "Arrow"
    },
    "longbow": {
        skill: "Bow",
        properties: {
            twoHanded: true,
            silent: true
        },
        damage: "1d10 Piercing",
        range: "46m/180m",
        ammoMax: 1,
        ammoType: "Arrow"
    },
    "rocket launcher": {
        skill: "Artillery",
        properties: {
            twoHanded: true,
            heavy: true
        },
        damage: "2d10+[Q] Blunt 1d10 Fire",
        range: "8m/30m",
        ammoMax: 1,
        ammoType: "Rocket"
    },
    "machine gun (normal)": {
        skill: "Artillery",
        properties: {
            twoHanded: true,
            heavy: true,
            armorPiercing: 5
        },
        damage: "3d8 Piercing",
        range: "8m/30m",
        ammoMax: 10,
        ammoType: "Salvo"
    },
    "machine gun (spray)": {
        skill: "Artillery",
        properties: {
            twoHanded: true,
            heavy: true,
            armorPiercing: 5
        },
        damage: "1d8 Piercing",
        range: "8m Cone",
        ammoMax: 10,
        ammoType: "Salvo"
    },
    "flamethrower": {
        skill: "Artillery",
        properties: {
            twoHanded: true,
            heavy: true
        },
        damage: "4d6 Fire 1d4 Burning",
        range: "6m Cone",
        ammoMax: 20,
        ammoType: "Fuel"
    },
    "railgun": {
        skill: "Artillery",
        properties: {
            twoHanded: true,
            heavy: true,
            powered: 4,
            armorPiercing: 10
        },
        damage: "4d12 Piercing",
        range: "100m/500m",
        ammoMax: 1,
        ammoType: "Rail Dart"
    }
}

function UpdateRangedWeapon(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];

    DoUpdateRangedWeapon(rowId);
    UpdateRangedWeaponRoll(eventInfo);
}

function UpdateRangedWeapons() {
    getSectionIDs("rangedWeapon", function(ids) {
        for(var i = 0; i < ids.length; i++) {
            let prefix = "repeating_rangedWeapon_" + ids[i] + "_";

            DoUpdateRangedWeapon(ids[i]);
            UpdateRangedWeaponRoll({sourceAttribute: prefix});
        }
    });
}

function DoUpdateRangedWeapon(id) {
    let prefix = "repeating_rangedWeapon_" + id + "_";
    
    getAttrs([prefix+"rangedWeapon_name", prefix+"rangedWeapon_weaponExpert", prefix+"rangedWeapon_quality", prefix+"rangedWeapon_skill", prefix+"rangedWeapon_damage"], function(values) {
        let weaponName = values[prefix+"rangedWeapon_name"] || "";
        let isWeaponExpert = values[prefix + "rangedWeapon_weaponExpert"] == 'on';
        let weaponQuality = parseInt(values[prefix + "rangedWeapon_quality"]) || 0;
        let weaponSkill = values[prefix+"rangedWeapon_skill"] || "";
        let weaponDamage = values[prefix+"rangedWeapon_damage"] || "";

        let listWeapon = rangedWeapons[weaponName.toLowerCase()];
        let skill = listWeapon !== undefined ? listWeapon.skill : weaponSkill;

        let attributes = {};
        
        if(listWeapon !== undefined) {
            attributes[prefix+"rangedWeapon_skill"] = listWeapon.skill;
            attributes[prefix+"rangedWeapon_range"] = listWeapon.range;
            attributes[prefix+"rangedWeapon_ammo"] = listWeapon.ammoMax;
        }

        let sanitizedSkillName = skill.toLowerCase().replace(" ", "").replace("-", "");

        getAttrs([sanitizedSkillName + "Mod", "bod", "agi", "gunsmithing", sanitizedSkillName], function(values) {
            let skillMod = values[sanitizedSkillName + "Mod"] || "+0";
            let bod = values["bod"] || "+0";
            let agi = values["agi"] || "+0";
            let gunsmithing = parseInt(values["gunsmithing"]) || 0;
            let skillRanks = parseInt(values[sanitizedSkillName]) || 0;

            // ATK with Gun Training
            if(gunsmithing > skillRanks) {
                attributes[prefix+"rangedWeapon_atk"] = Signed(Math.max(skillRanks, Math.floor(gunsmithing / 2)) + parseInt(agi));
            }
            else {
                attributes[prefix+"rangedWeapon_atk"] = skillMod;
            }
            // Weapon Expert
            if(isWeaponExpert) {    
                attributes[prefix+"rangedWeapon_atk"] += "+2";
            }

            // Damage
            // Fill in Quality
            let damage = weaponDamage;
            if(listWeapon !== undefined) {
                damage = listWeapon.damage;
            }
            let damageParts = damage.replaceAll("[Q]", weaponQuality).split(" ");
            // Gunsmith Extra Damage
            if(weaponQuality >= 5) {
                let diceRegex = /^(\d*)([dD]\d*)/;
                // We check if there even is a dice component at the start
                // (has to be at start to be considered base damage dice)
                let regexMatch = damageParts[0].match(diceRegex);
                if(regexMatch) {
                    let dieCount = parseInt(regexMatch[1]); // first capture group is die count
                    let dieSize = regexMatch[2]; // second capture group is die including the "d"
                    let extraDamageDice = Math.floor(weaponQuality / 5) + dieSize;
                    
                    let extraDamageIndex = damageParts[0].search(/[\+\-]\d*[dD]?\d*\[ExtraDamage\]/g);
                    if(extraDamageIndex == -1) {
                        damageParts[0] += "+" + extraDamageDice + "[ExtraDamage]";
                    }
                    else {
                        damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[ExtraDamage\]/g, "+" + extraDamageDice + "[ExtraDamage]");
                    }
                }
            }
            else {
                damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[ExtraDamage\]/g, "");
            }
            // Attribute Mod
            if(skill == "Pistol" || skill == "Rifle") {
                let agiIndex = damageParts[0].search(/[\+\-]\d*[dD]?\d*\[AGI\]/g);
                let bodIndex = damageParts[0].search(/[\+\-]\d*d?\[dD]*\[BOD\]/g);
                if(agiIndex > -1) {
                    damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[AGI\]/g, agi + "[AGI]");
                }
                if(bodIndex > -1) {
                    damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[BOD\]/g, agi + "[AGI]");
                }
                if(agiIndex == -1 && bodIndex == -1) {
                    damageParts[0] += agi + "[AGI]";
                }
            }
            else if (skill == "Bow") {
                let agiIndex = damageParts[0].search(/[\+\-]\d*[dD]?\d*\[AGI\]/g);
                let bodIndex = damageParts[0].search(/[\+\-]\d*[dD]?\d*\[BOD\]/g);
                if(agiIndex > -1) {
                    damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[AGI\]/g, bod + "[BOD]");
                }
                if(bodIndex > -1) {
                    damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[BOD\]/g, bod + "[BOD]");
                }
                if(agiIndex == -1 && bodIndex == -1) {
                    damageParts[0] += bod + "[BOD]";
                }
            }
            else {
                damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[BOD\]/g, "");
                damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[AGI\]/g, "");
            }
            // Weapon Expert
            if(isWeaponExpert) {
                let weaponExpertIndex = damageParts[0].search(/[\+\-]\d*[dD]?\d*\[WeaponExpert\]/g);
                if(weaponExpertIndex == -1) {
                    damageParts[0] += "+2[WeaponExpert]";
                }
                else {
                    damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[WeaponExpert\]/g, "+2[WeaponExpert]");
                }
            }
            else {
                damageParts[0] = damageParts[0].replaceAll(/[\+\-]\d*[dD]?\d*\[WeaponExpert\]/g, "");
            }

            let damageText = damageParts[0];
            for(let i = 1; i < damageParts.length; i++) {
                damageText += " " + damageParts[i];
            }

            attributes[prefix+"rangedWeapon_damage"] = damageText;

            setAttrs(attributes);
        });
    });
}

function UpdateRangedWeaponRoll(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_rangedWeapon_" + rowId + "_";
    
    let attributes = {};

    getAttrs([prefix+"rangedWeapon_name", prefix+"rangedWeapon_damage", prefix+"rangedWeapon_atk", "athletics", "stealth", "artillery", prefix+"rangedWeapon_skill"], function(values) {
        let weaponName = values[prefix+"rangedWeapon_name"] || "";
        let weaponDamage = values[prefix+"rangedWeapon_damage"] || "";
        let weaponAtk = values[prefix+"rangedWeapon_atk"] || "";
        let athleticsRanks = parseInt(values["athletics"]) || 0;
        let stealthRanks = parseInt(values["stealth"]) || 0;
        let artilleryRanks = parseInt(values["artillery"]) || 0;
        let weaponSkill = values[prefix+"rangedWeapon_skill"] || "";

        let damageParts = weaponDamage.split(" ");
        let roll = "?{Secret?|Open Roll,|Secret Roll,/w gm} &{template:custom} {{name=" + weaponName + " Attack}}";

        // To Hit
        if(weaponAtk != "") {
            roll += GetCustomTemplateAtkString(weaponAtk);
        }

        // Damage
        roll += "{{damage="
        let crit = "{{critdamage="
        let diceRegex = /\+?\d*d\d*/g;
        for(let i = 0; i < damageParts.length; i += 2) {
            roll += " [[";
            roll += damageParts[i] + "]] ";
            roll += damageParts[i + 1];
            
            // Crit
            crit += " +[[";
            let damageDice = damageParts[i].match(diceRegex);
            if(damageDice) {
                for(let j = 0; j < damageDice.length; j++) {
                    crit += damageDice[j];
                }
                crit += "]] ";
                crit += damageParts[i + 1];
            }
        }
        crit += "}}";
        roll += "}}";

        // Powerful Strikes
        if(athleticsRanks > 0 && weaponSkill == "Bow") {
            roll += "{{powerfulstrikes=+" + athleticsRanks + " " + damageParts[1] + "}}"
        }

        // Sneak Attack
        if(stealthRanks >= 3) {
            let sneakAttackDamage = "";
            let sneakAttackDice = Math.floor(stealthRanks / 3);
            if(stealthRanks < 10) {
                sneakAttackDamage = sneakAttackDice + "d6";
            }
            else {
                sneakAttackDamage = sneakAttackDice + "d8";
            }
            roll += "{{sneakattack=+[[" + sneakAttackDamage + "]] " + damageParts[1] + "}}";
            crit += "{{sneakattackcrit=+[[" + sneakAttackDamage + "]] " + damageParts[1] + "}}";
        }

        // Siege Weapons
        if(weaponSkill == "Artillery" && artilleryRanks >= 7) {
            roll += "{{siegeweapon=+[[" + artilleryRanks + "d6]] Piercing}}"
            crit += "{{siegeweaponcrit=+[[" + artilleryRanks + "d6]] Piercing}}"
        }

        attributes[prefix+"rangedWeapon_roll"] = roll + crit;

        setAttrs(attributes);
    });
}

let curses = {
    "lycanthropy": {
        natura: "20 Fire",
        target: "1 Creature (Human)",
        sacrifice: "Fresh blood drawn directly from the target within the last hour that must be trifled over a silver blade.",
        description: "Also known as the werewolf curse. This curse turns a human into a werewolf. Every full moon at nightfall the target turns into a humanoid wolf creature (Use the Werewolf stat sheet). While in this form, it is driven by an insatiable hunger for meat, especially that of humans. At dawn, the target turns back into its human form and loses all memories of anything that happened while turned.",
        breakingCondition: "The curse can be broken by trifling fresh blood of the witch that inflicted the curse drawn within the last hour onto a silver blade and stabbing the target with it."
    },
    "bad luck": {
        natura: "5 Fire, 5 Air, 5 Earth, 5 Water",
        target: "1 Creature",
        sacrifice: "A symbol of luck such as a four leaf clover that must be burnt along with a strand of hair taken off of the target within the last hour.",
        description: "The target creature has disadvantage on all tests.",
        breakingCondition: "Once a day at the end of a Long Rest, the target can attempt to break the curse by performing a difficult task and rolling a 20 on at least one of the d20s on the associated test."
    },
    "eternal nightmares": {
        natura: "10 Air, 10 Water",
        target: "1 Creature",
        sacrifice: "A lock of the target's hair, burned with black wax and placed under their bed or pillow.",
        description: "The target creature is plagued by vivid, horrifying nightmares whenever they sleep. Long Rests only recover half of their health point maximum - [P] health points.",
        breakingCondition: "The target must defeat a creature spawned from their nightmares in the dream world. In order to do that, the target must be made aware of the situation in their dream by means of a Dreamwalk ritual."
    },
    "rusting decay": {
        natura: "10 Earth",
        target: "1 Object (weapon, or piece of armor)",
        sacrifice: "A piece of metal that has naturally rusted over 50 years or more, ground into powder and sprinkled over the object.",
        description: "The target object constantly corrodes.\nIf it is a piece of armor, its AV is cumulatively reduced by 1 every day at dawn. Once its AV hits 0, it crumbles to dust and is destroyed.\nIf it is a weapon, it gets a cumulative -1 penalty to all damage rolls daily at dawn. After 10 - [P] + [Q] days (where [Q] is the weaponâ€™s quality or 0 if it has no associated quality) the weapon crumbles to dust and is destroyed.",
        breakingCondition: "None."
    },
    "forked tongue": {
        natura: "10 Air, 5 Water",
        target: "1 Creature",
        sacrifice: "The burned tongue of a songbird, which must be eaten by the target.",
        description: "The target creature cannot speak the truth. Every spoken statement is twisted into a lie, even if unintentional.",
        breakingCondition: "The target must witness the witch that inflicted the curse on it speaking 3 lies within one day."
    },
    "shattered fate": {
        natura: "5 Fire, 5 Air, 5 Earth, 5 Water",
        target: "1 Creature",
        sacrifice: "A mirror that the target has looked into within the last day, shattered and buried at a crossroads.",
        description: "Whenever the target rolls a natural 20 on a test, they must reroll and use the new result.",
        breakingCondition: "The target must voluntarily fail a task at great personal cost."
    },
    "gluttony": {
        natura: "10 Earth, 5 Water",
        target: "1 Creature",
        sacrifice: "A food item the target has taken a bite out of within the last 24 hours that must be fed to an animal with black fur or feathers at midnight.",
        description: "The target can never feel full. They must consume three times as much food daily to avoid exhaustion, but no amount of food can ever truly satisfy them.",
        breakingCondition: "The target must fast for seven full days (no food, only water), enduring the hardship without falling unconscious or dying. At the dawn of the 8th day the curse is broken."
    },
    "silence": {
        natura: "20 Air",
        target: "1 Creature",
        sacrifice: "The written notes of a melody that the target has hummed or whistled within the last hour, which you must eat.",
        description: "The target is rendered mute. They cannot speak or produce vocal sounds.",
        breakingCondition: "The target must witness the witch that inflicted the curse humming, whistling, or singing the melody that she ate."
    },
    "grasping roots": {
        natura: "17 Earth",
        target: "a [P] x 10m square area",
        sacrifice: "A branch of an ancient tree mixed with the blood of a medium or larger carnivore that must be implanted in the centre of the target area. Creatures smeared with some of the same blood when inflicting the curse can pass the area unaffected.",
        description: "The target area becomes overgrown with aggressive moving roots and vines.\nMovement through the cursed area is halved.\nAt the start of each creatureâ€™s turn in the area, they must succeed on an Athletics or Evasion test against 10 + [P] or be restrained until the start of their next turn.",
        breakingCondition: "Burn the branch of the ancient tree at the centre of the area."
    },
    "sanguine seal": {
        natura: "7 Fire, 10 Earth, 3 Water",
        target: "a room or building up to [P] x 10m in its largest dimension",
        sacrifice: "Blood of the person who most recently owned or controlled the structure, which must be smeared over one of the roomâ€™s or buildingâ€™s entrances.",
        description: "All doors, windows, and other access points in the target area can only be opened by creatures marked with the blood used in the sacrifice.\nAll others find doors and windows impossibly sealed. Theyâ€™re unable to open the doors and windows by any means short of magic.",
        breakingCondition: "The person whose blood was used for the sacrifice must personally ask someone who isnâ€™t marked by the blood to enter the target area."
    }
};

function UpdateCurse(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_curse_" + rowId + "_";

    getAttrs([prefix+"curse_name", "spellwork"], function(values) {
        let curseName = values[prefix+"curse_name"] || "";
        let spellworkRanks = parseInt(values["spellwork"]) || 0;

        let listCurse = curses[curseName.toLowerCase()];
        if(listCurse !== undefined) {
            let attributes = {};

            attributes[prefix+"curse_natura"] = (listCurse.natura||"").replaceAll("[P]", spellworkRanks);
            attributes[prefix+"curse_target"] = (listCurse.target||"").replaceAll("[P]", spellworkRanks);
            attributes[prefix+"curse_sacrifice"] = (listCurse.sacrifice||"").replaceAll("[P]", spellworkRanks);
            attributes[prefix+"curse_description"] = (listCurse.description||"").replaceAll("[P]", spellworkRanks);
            attributes[prefix+"curse_breakingCondition"] = (listCurse.breakingCondition||"").replaceAll("[P]", spellworkRanks);

            setAttrs(attributes);
        }
    });
}

function UpdateCursePowers() {
    getSectionIDs("curse", function(ids) {
        for(var i = 0; i < ids.length; i++) {
            let prefix = "repeating_curse_" + ids[i] + "_";

            getAttrs([prefix + "curse_name", "spellwork"], function(values) {
                let curseName = values[prefix+"curse_name"] || "";
                let spellworkRanks = parseInt(values["spellwork"]) || 0;
                
                let listCurse = curses[curseName.toLowerCase()];
                if(listCurse !== undefined) {
                    let attributes = {};

                    attributes[prefix+"curse_natura"] = (listCurse.natura||"").replaceAll("[P]", spellworkRanks);
                    attributes[prefix+"curse_target"] = (listCurse.target||"").replaceAll("[P]", spellworkRanks);
                    attributes[prefix+"curse_sacrifice"] = (listCurse.sacrifice||"").replaceAll("[P]", spellworkRanks);
                    attributes[prefix+"curse_description"] = (listCurse.description||"").replaceAll("[P]", spellworkRanks);
                    attributes[prefix+"curse_breakingCondition"] = (listCurse.breakingCondition||"").replaceAll("[P]", spellworkRanks);

                    setAttrs(attributes);
                }
            });
        }
    });
}

let potions = {
    "healing": {
        essence: "2 Water, 2 Fire, 2 Earth, 2 Air",
        effect: "Restores [P]d4 hit points."
    },
    "cleansing": {
        essence: "3 Water, 3 Earth",
        effect: "Cures all stacks of poison."
    },
    "haste": {
        essence: "2 Fire, 3 Air",
        effect: "Grants +1 Minor Action each turn for [P] turns."
    },
    "restoration": {
        essence: "5 Earth",
        effect: "At the start of your turn, you regain 1d4 hit points for the next [P] turns."
    },
    "water breathing": {
        essence: "3 Water, 2 Air",
        effect: "For the next [P] hours, you can breathe underwater."
    },
    "flight": {
        essence: "6 Air",
        effect: "For the next [P] minutes, you can fly with a speed equal to your walking speed."
    },
    "charm": {
        essence: "3 Water, 2 Fire",
        effect: "For the next [P] hours, you have advantage on Persuasion tests."
    },
    "muscle": {
        essence: "1 Fire, 4 Earth",
        effect: "For the next [P] hours, you have advantage on Athletics tests."
    },
    "fire immunity": {
        essence: "6 Water",
        effect: "For the next [P] minutes, you are immune to Fire damage."
    },
    "lightning immunity": {
        essence: "6 Earth",
        effect: "For the next [P] minutes, you are immune to Lightning damage."
    },
    "acid immunity": {
        essence: "3 Earth, 3 Water",
        effect: "For the next [P] minutes, you are immune to Acid damage."
    },
    "poison immunity": {
        essence: "3 Earth, 3 Water",
        effect: "For the next [P] minutes, you are immune to Poison damage. You can still gain additional poison stacks."
    },
    "hardening": {
        essence: "6 Earth",
        effect: "For the next minute, you gain a +[P] bonus to all your Armor Values."
    },
    "night vision": {
        essence: "1 Water, 3 Fire, 1 Air",
        effect: "For the next [P] hours, you can see in dim light as if it was bright light and in total darkness as if it were dim light."
    },
    "explosion": {
        essence: "6 Fire",
        effect: "When this potion is thrown, it explodes in a 10m radius sphere, dealing [P]d6 Fire damage to creatures and objects in the area."
    },
    "last stand": {
        essence: "2 Water, 4 Fire, 2 Earth, 2 Air",
        effect: "For the next minute, if damage from any source other than a critical or deadly hit would reduce you to 0 hit points, you keep 1 hit point. At the end of that minute, if youâ€™re at 1 hit point still, you immediately drop unconscious."
    },
    "wound closure": {
        essence: "4 Water, 1 Fire, 1 Earth",
        effect: "Cures all stacks of bleeding."
    }
};

function UpdatePotion(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_potion_" + rowId + "_";

    getAttrs([prefix+"potion_name"], function(values) {
        let potionName = values[prefix+"potion_name"] || "";

        let listPotion = potions[potionName.toLowerCase()];
        if(listPotion !== undefined) {
            let attributes = {};

            attributes[prefix+"potion_essence"] = listPotion.essence;
            attributes[prefix+"potion_effect"] = listPotion.effect;

            setAttrs(attributes);
        }
    });
}

function UpdateMemorisedSpells() {
    getSectionIDs("spell", function(ids) {
        let memorised = 0;
        setAttrs({
            memorisedSpells: memorised
        });

        for(var i = 0; i < ids.length; i++) {
            let prefix = "repeating_spell_" + ids[i] + "_spell_";

            getAttrs([prefix + "memorised"], function(values) {
                if(values[prefix + "memorised"] == 'on') {
                    memorised++;

                    setAttrs({
                        memorisedSpells: memorised
                    });
                }
            });
        }
    });
}

function UpdateMemorisedBlessings() {
    getSectionIDs("blessing", function(ids) {
        let memorised = 0;
        setAttrs({
            memorisedBlessings: memorised
        });

        for(var i = 0; i < ids.length; i++) {
            let prefix = "repeating_blessing_" + ids[i] + "_blessing_";

            getAttrs([prefix + "memorised"], function(values) {
                if(values[prefix + "memorised"] == 'on') {
                    memorised++;

                    setAttrs({
                        memorisedBlessings: memorised
                    });
                }
            });
        }
    });
}

function UpdateBlueprintAutomatonChassis(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_blueprint_" + rowId + "_";

    let attributes = {};

    switch(eventInfo.newValue.toLowerCase()) {
        case "small":
            attributes[prefix + "blueprint_minCR"] = 2;
            break;
        case "medium":
            attributes[prefix + "blueprint_minCR"] = 4;
            break;
        case "large":
            attributes[prefix + "blueprint_minCR"] = 6;
            break;
        default:
            return;
    }

    setAttrs(attributes);
}

function UpdateBlueprintType(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_blueprint_" + rowId + "_";

    let attributes = {};

    switch(eventInfo.newValue.toLowerCase()) {
        case "prosthetic":
            attributes[prefix + "blueprint_minCR"] = 1;
            break;
        case "automaton":
            getAttrs([prefix + "blueprint_automatonChassis"], function(values) {
                switch(values[prefix + "blueprint_automatonChassis"].toLowerCase()) {
                    case "small":
                        attributes[prefix + "blueprint_minCR"] = 2;
                        break;
                    case "medium":
                        attributes[prefix + "blueprint_minCR"] = 4;
                        break;
                    case "large":
                        attributes[prefix + "blueprint_minCR"] = 6;
                        break;
                    default:
                        return;
                }

                setAttrs(attributes);
            });
            return;
        case "autolimb":
            getAttrs([prefix + "blueprint_limb"], function(values) {
                let limb = values[prefix + "blueprint_limb"].toLowerCase();
                let attributes = {};

                switch(limb) {
                    case "arm":
                        attributes[prefix + "blueprint_minCR"] = 3;
                        break;
                    case "leg":
                        attributes[prefix + "blueprint_minCR"] = 3;
                        break;
                    case "hand":
                        attributes[prefix + "blueprint_minCR"] = 2;
                        break;
                    case "foot":
                        attributes[prefix + "blueprint_minCR"] = 2;
                        break;
                    case "ear":
                        attributes[prefix + "blueprint_minCR"] = 1;
                        break;
                    case "eye":
                        attributes[prefix + "blueprint_minCR"] = 1;
                        break;
                    case "nose":
                        attributes[prefix + "blueprint_minCR"] = 1;
                        break;
                    case "jaw":
                        attributes[prefix + "blueprint_minCR"] = 1;
                        break;
                }

                setAttrs(attributes);
            });
            return;
        default:
            return;
    }

    setAttrs(attributes);
}

function UpdateBlueprintLimb(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_blueprint_" + rowId + "_";

    getAttrs([prefix + "blueprint_type"], function(values) {
        let type = values[prefix + "blueprint_type"].toLowerCase();
        let attributes = {};

        if(type === "autolimb") {
            switch(eventInfo.newValue.toLowerCase()) {
                case "arm":
                    attributes[prefix + "blueprint_minCR"] = 3;
                    break;
                case "leg":
                    attributes[prefix + "blueprint_minCR"] = 3;
                    break;
                case "hand":
                    attributes[prefix + "blueprint_minCR"] = 2;
                    break;
                case "foot":
                    attributes[prefix + "blueprint_minCR"] = 2;
                    break;
                case "ear":
                    attributes[prefix + "blueprint_minCR"] = 1;
                    break;
                case "eye":
                    attributes[prefix + "blueprint_minCR"] = 1;
                    break;
                case "nose":
                    attributes[prefix + "blueprint_minCR"] = 1;
                    break;
                case "jaw":
                    attributes[prefix + "blueprint_minCR"] = 1;
                    break;
            }

            setAttrs(attributes);
        }
    });
}

let platings = {
    "none": {
        dav: 0,
        evasionMod: 2,
        speedMod: 4
    },
    "aluminium": {
        dav: 1,
        evasionMod: 1,
        speedMod: 2
    },
    "copper": {
        dav: 2,
        evasionMod: 0,
        speedMod: 0
    },
    "steel": {
        dav: 4,
        evasionMod: -2,
        speedMod: -2
    },
    "ceramic": {
        dav: 6,
        evasionMod: -4,
        speedMod: -4
    },
    "titanium": {
        dav: 8,
        evasionMod: -6,
        speedMod: -6
    }
};

function UpdateAutomatonPlating(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_automaton_" + rowId + "_";

    getAttrs([prefix + "automaton_plating"], function(values) {
        let plating = values[prefix + "automaton_plating"].toLowerCase();
        let attributes = {};

        if(plating in platings) {
            attributes[prefix + "automaton_dav"] = platings[plating].dav;
            setAttrs(attributes);
        }
    });
}

let automatonChassisSizes = {
    "small": {
        maxHp: 25,
        coreRating: 2,
        maxModules: 0,
        carryCapacity: 25,
        hpCapQualityMultiplier: 1
    },
    "medium": {
        maxHp: 50,
        coreRating: 4,
        maxModules: 5,
        carryCapacity: 50,
        hpCapQualityMultiplier: 2
    },
    "large": {
        maxHp: 100,
        coreRating: 6,
        maxModules: 10,
        carryCapacity: 100,
        hpCapQualityMultiplier: 5
    }
}

function UpdateAutomatonStats(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_automaton_" + rowId + "_";

    getAttrs([prefix + "automaton_chassis", prefix + "automaton_quality"], function(values) {
        let chassis = values[prefix + "automaton_chassis"].toLowerCase();
        let attributes = {};

        if(chassis in automatonChassisSizes) {
            let quality = parseInt(values[prefix + "automaton_quality"]) || 0;
            let qualityModifier = quality * automatonChassisSizes[chassis].hpCapQualityMultiplier;

            attributes[prefix + "automaton_hp_max"] = automatonChassisSizes[chassis].maxHp + qualityModifier;
            attributes[prefix + "automaton_coreRating"] = automatonChassisSizes[chassis].coreRating;
            attributes[prefix + "automaton_modules_max"] = automatonChassisSizes[chassis].maxModules + qualityModifier;
            setAttrs(attributes);
        }
    });
}

let attributeMods = {
    Agility: "[AGI]",
    Body: "[BOD]",
    Charisma: "[CHA]",
    Intuition: "[INT]",
    Logic: "[LOG]",
    Willpower: "[WIL]"
};

function RollNpcAttack(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_npcAttack_" + rowId + "_npc_attack_";

    getAttrs(
        [
            prefix + "name",                // Name
            prefix + "type",                // Melee / Ranged / Special
            prefix + "type2",               // Weapon / Unarmed / Spell / Innate
            prefix + "isAttackTest",        // isAttackTest Checkbox
            prefix + "requiresSave",        // requiresSave Checkbox
            prefix + "atk",                 // ATK
            prefix + "difficulty",          // DT
            prefix + "saveAttribute",       // Save Attribute
            prefix + "saveSkill",           // Save Skill
            prefix + "damage",              // Damage
            prefix + "description"          // Description
        ],
        function(values) {
            let name = values[prefix + "name"] || "";
            let type = values[prefix + "type"] || "";
            let type2 = values[prefix + "type2"] || "";
            let isAttackTest = values[prefix + "isAttackTest"] == "on";
            let requiresSave = values[prefix + "requiresSave"] == "on";
            let atk = values[prefix + "atk"] || "";
            let difficulty = values[prefix + "difficulty"] || "";
            let saveAttribute = values[prefix + "saveAttribute"] || "";
            let saveSkill = values[prefix + "saveSkill"] || "";
            let damage = values[prefix + "damage"] || "";
            let description = values[prefix + "description"] || "";

            let roll = "?{Secret|Open,|Secret,/w gm} &{template:custom}";

            roll += "{{name=" + name + "}}";
            roll += "{{type=" + type + " " + type2 + "}}";

            // Attack Test
            if(isAttackTest) {
                roll += GetCustomTemplateAtkString(atk);
            }

            // Save Test
            if(requiresSave) {
                roll += "{{save=DT " + difficulty;

                if(saveSkill == "Evasion") {
                    roll += " Evasion";
                }
                else if(saveSkill != "none") {
                    roll += " " + saveSkill + " " + attributeMods[saveAttribute];
                }
                else {
                    roll += " " + saveAttribute;
                }

                roll += "}}";
            }

            // Damage Roll
            if(damage != "") {
                roll += DamageStringToTemplateRollString(damage);
            }

            // Description
            if(description != "") {
                roll += "{{description=" + description + "}}";
            }

            startRoll(roll, (r) => {
                finishRoll(r.rollId);
            });
        }
    );
}

function UpdateNpcAttackAtks() {
    getSectionIDs("npcAttack", function(ids) {
        for(let rowId of ids) {
            DoUpdateNpcAttackAtk(rowId);
        }
    });
}

function UpdateNpcAttackAtk(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    DoUpdateNpcAttackAtk(rowId);
}

function DoUpdateNpcAttackAtk(rowId) {
    let prefix = "repeating_npcAttack_" + rowId + "_npc_attack_";

    getAttrs([prefix + "atkMod", prefix + "atkAttribute", "agi", "bod", "cha", "int", "log", "wil"], function (values){
        let atkMod = parseInt(values[prefix + "atkMod"]) || 0;
        let atkAttribute = values[prefix + "atkAttribute"] || "";
        let attributeMods = {
            Agility      : parseInt(values["agi"]) || 0,
            Body         : parseInt(values["bod"]) || 0,
            Charisma     : parseInt(values["cha"]) || 0,
            Intelligence : parseInt(values["int"]) || 0,
            Logic        : parseInt(values["log"]) || 0,
            Willpower    : parseInt(values["wil"]) || 0
        };

        let atk = atkMod;

        if(atkAttribute != "" && atkAttribute != "none") {
            atk += attributeMods[atkAttribute];
        }

        let attributes = {};
        attributes[prefix + "atk"] = Signed(atk);

        setAttrs(attributes);
    });
}

function UpdateNpcAttackSaveDifficulties() {
    getSectionIDs("npcAttack", function(ids) {
        for(let rowId of ids) {
            DoUpdateNpcAttackSaveDifficulty(rowId);
        }
    });
}

function UpdateNpcAttackSaveDifficulty(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    DoUpdateNpcAttackSaveDifficulty(rowId);
}

function DoUpdateNpcAttackSaveDifficulty(rowId) {
    let prefix = "repeating_npcAttack_" + rowId + "_npc_attack_";

    getAttrs([prefix + "difficultyMod", prefix + "difficultyAttribute", "agi", "bod", "cha", "int", "log", "wil"], function (values){
        let difficultyMod = parseInt(values[prefix + "difficultyMod"]) || 0;
        let difficultyAttribute = values[prefix + "difficultyAttribute"] || "";
        let attributeMods = {
            Agility      : parseInt(values["agi"]) || 0,
            Body         : parseInt(values["bod"]) || 0,
            Charisma     : parseInt(values["cha"]) || 0,
            Intelligence : parseInt(values["int"]) || 0,
            Logic        : parseInt(values["log"]) || 0,
            Willpower    : parseInt(values["wil"]) || 0
        };

        let difficulty = 0;
        difficulty += difficultyMod;

        if(difficultyAttribute != "" && difficultyAttribute != "none") {
            difficulty += attributeMods[difficultyAttribute];
        }

        let attributes = {};
        attributes[prefix + "difficulty"] = difficulty;

        setAttrs(attributes);
    });
}

function UpdateTotalAV(eventInfo) {
    let bodyPart = "";
    if(eventInfo.sourceAttribute.search("augment") > -1) {
        bodyPart = eventInfo.sourceAttribute.substring(0, eventInfo.sourceAttribute.length-9);
    }
    else {
        
        bodyPart = eventInfo.sourceAttribute.substring(0, eventInfo.sourceAttribute.length-2);
    }

    getAttrs(
        [
            bodyPart + "AV",
            bodyPart + "AugmentAV"
        ],
        function(values) {
            let baseAV = parseInt(values[bodyPart + "AV"]) || 0;
            let augmentAV = parseInt(values[bodyPart + "AugmentAV"]) || 0;

            let attributes = {};

            attributes[bodyPart + "TotalAV"] = baseAV + augmentAV;

            setAttrs(attributes);
        }
    );
}

function UpdateAugmentAV(eventInfo) {
    let bodyPart = eventInfo.sourceAttribute.split("_")[1];

    getAttrs(
        [
            "augmentations_" + bodyPart + "_quality",
            "augmentations_" + bodyPart
        ],
        function(values) {
            let quality = parseInt(values["augmentations_" + bodyPart + "_quality"]) || 0;
            let augmentation = values["augmentations_" + bodyPart] || "";

            let attributes = {};

            if(augmentation == "prosthetic" || augmentation == "autolimb") {
                attributes[bodyPart + "AugmentAV"] = Signed(quality);
            }
            else {
                attributes[bodyPart + "AugmentAV"] = "+0";
            }

            setAttrs(attributes);
        }
    );
}

function UpdateAugmentModuleCapacity(eventInfo) {
    let bodyPart = eventInfo.sourceAttribute.split("_")[1];

    getAttrs(
        [
            "augmentations_" + bodyPart + "_quality"
        ],
        function(values) {
            let quality = parseInt(values["augmentations_" + bodyPart + "_quality"]) || 0;

            let attributes = {};

            attributes["augmentations_" + bodyPart + "_moduleCapacity"] = Math.floor(quality / 2);

            if(bodyPart == "leftEye" || bodyPart == "rightEye" || bodyPart == "jaw") {
                attributes["augmentations_" + bodyPart + "_moduleCapacity"] += 1;
            }
            else if(bodyPart == "leftFoot" || bodyPart == "rightFoot" || bodyPart == "leftHand" || bodyPart == "rightHand" || bodyPart == "head") {
                attributes["augmentations_" + bodyPart + "_moduleCapacity"] += 2;
            }
            else if(bodyPart == "leftLeg" || bodyPart == "rightLeg" || bodyPart == "leftArm" || bodyPart == "rightArm") {
                attributes["augmentations_" + bodyPart + "_moduleCapacity"] += 3;
            }
            else if(bodyPart == "torso") {
                attributes["augmentations_" + bodyPart + "_moduleCapacity"] += 4;
            }

            setAttrs(attributes);
        }
    );
}

function InvokeBlessing(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_blessing_" + rowId + "_blessing_";

    getAttrs(
        [
            prefix + "name",
            prefix + "action",
            prefix + "components",
            prefix + "faith",
            prefix + "range",
            prefix + "area",
            prefix + "duration",
            prefix + "description",
            "faith",
            "prayer"
        ],
        function(values) {
            let name = values[prefix + "name"] || "";
            let action = values[prefix + "action"] || "";
            let components = values[prefix + "components"] || "";
            let blessingFaith = parseInt(values[prefix + "faith"]) || 0;
            let range = values[prefix + "range"] || "";
            let area = values[prefix + "area"] || "";
            let duration = values[prefix + "duration"] || "";
            let description = values[prefix + "description"] || "";
            let faithPool = parseInt(values["faith"]) || 0;
            let prayerRanks = parseInt(values["prayer"]) || 0;

            if(faithPool >= blessingFaith) {
                // Invoke Blessing
                let rollString = `?{Secret|Open,|Secret,/w gm} &{template:custom}`;

                // Name
                rollString += `{{name=${name}}}`;
                // Action
                rollString += `{{action=${action}}}`;
                // Components
                rollString += `{{components=${components}}}`;
                // Power
                rollString += `{{power=[[${prayerRanks}[Prayer Ranks]`;
                // Additional Faith for extra Power
                if(faithPool > blessingFaith) {
                    rollString += `?{Spend more Faith?|+0 Faith, `;
                    for(let i = 1; i <= prayerRanks && (i + blessingFaith) <= faithPool; i++) {
                        rollString += `|+${i} Faith,+${i}[+${i} Faith]`;
                    }
                    rollString += `}]]}}`;
                }
                // Range
                if(range != "") {
                    rollString += `{{range=${range}}}`;
                }
                // Area
                if(area != "") {
                    rollString += `{{area=${area}}}`;
                }
                // Duration
                if(duration != "") {
                    rollString += `{{duration=${duration}}}`;
                }
                // Description
                if(description != "") {
                    rollString += `{{description=${description}}}`;
                }
                
                startRoll(rollString, (r) => {
                    let blessingPower = r.results["power"].result;
                    let expendedFaith = blessingFaith + (blessingPower - prayerRanks);

                    setAttrs({
                        faith: faithPool - expendedFaith
                    });

                    finishRoll(r.rollId);
                });
            }
            else {
                // Can't invoke blessing!
                console.error(`Can't invoke ${name}! Not enough Faith available.`);
            }
        }
    );
}

function CastSpell(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    let prefix = "repeating_spell_" + rowId + "_spell_";

    getAttrs(
        [
            prefix + "name",
            prefix + "action",
            prefix + "components",
            prefix + "natura",
            prefix + "range",
            prefix + "area",
            prefix + "duration",
            prefix + "description",
            prefix + "attackType",
            prefix + "saveType",
            prefix + "saveDT",
            prefix + "saveDTType",
            prefix + "damage",
            "essence_fire",
            "essence_water",
            "essence_earth",
            "essence_air",
            "spellwork",
            "srd",
            "elementalAttunement",
            "stealth",
            "spellworkMod"
        ],
        function(values) {
            let name = values[prefix + "name"] || "";
            let action = values[prefix + "action"] || "";
            let components = values[prefix + "components"] || "";
            let natura = values[prefix + "natura"] || "";
            let range = values[prefix + "range"] || "";
            let area = values[prefix + "area"] || "";
            let duration = values[prefix + "duration"] || "";
            let description = values[prefix + "description"] || "";
            let spellworkRanks = parseInt(values["spellwork"]) || 0;
            let stealthRanks = parseInt(values["stealth"]) || 0;
            let spellworkMod = values["spellworkMod"] || "";

            let attackType = values[prefix + "attackType"] || "";
            let saveType = values[prefix + "saveType"] || "";
            let srd = parseInt(values["srd"]) || 0;
            let saveDT = values[prefix + "saveDT"] || "";
            let saveDTType = values[prefix + "saveDTType"] || "";
            let damage = values[prefix + "damage"] || "";
            
            let fireEssence = parseInt(values["essence_fire"]) || 0;
            let waterEssence = parseInt(values["essence_water"]) || 0;
            let earthEssence = parseInt(values["essence_earth"]) || 0;
            let airEssence = parseInt(values["essence_air"]) || 0;

            let elementalAttunement = values["elementalAttunement"] || "";
            
            let fireCost = 0;
            let waterCost = 0;
            let airCost = 0;
            let earthCost = 0;

            // Parse Natura field
            if(natura != "") {
                let naturaRegex = /[+-]?\d* (?:Fire|Air|Earth|Water)/gi;
                let matches = natura.match(naturaRegex);

                for(let match of matches) {
                    let splitMatch = match.split(" ");
                    let amount = parseInt(splitMatch[0]);
                    let element = splitMatch[1];

                    switch(element.toLowerCase()) {
                        case "fire":
                            fireCost += amount;
                            break;
                        case "water":
                            waterCost += amount;
                            break;
                        case "earth":
                            earthCost += amount;
                            break;
                        case "air":
                            airCost += amount;
                            break;
                    }
                }
                
                // Elemental Attunement
                if(elementalAttunement.toLowerCase() == "fire") {
                    fireCost = Math.max(fireCost, fireCost-1);
                }
                if(elementalAttunement.toLowerCase() == "water") {
                    waterCost = Math.max(waterCost, waterCost-1);
                }
                if(elementalAttunement.toLowerCase() == "earth") {
                    earthCost = Math.max(earthCost, earthCost-1);
                }
                if(elementalAttunement.toLowerCase() == "air") {
                    airCost = Math.max(airCost, airCost-1);
                }
            }

            // Cast Spell
            if(fireEssence >= fireCost
                && waterEssence >= waterCost
                && earthEssence >= earthCost
                && airEssence >= airCost)
            {
                let rollString = `?{Secret|Open,|Secret,/w gm} &{template:custom}`;

                // Name
                rollString += `{{name=${name}}}`;
                // Action
                rollString += `{{action=${action}}}`;
                // Components
                rollString += `{{components=${components}}}`;
                // Power
                let power = spellworkRanks;
                rollString += `{{power=${power}}}`;
                // Range
                if(range != "") {
                    rollString += `{{range=${range}}}`;
                }
                // Area
                if(area != "") {
                    rollString += `{{area=${area}}}`;
                }
                // Duration
                if(duration != "") {
                    rollString += `{{duration=${duration}}}`;
                }
                // Attack
                if(attackType != "none") {
                    rollString += GetCustomTemplateAtkString(spellworkMod);
                }
                // Save
                if(saveType != "none") {
                    if(saveDTType.toLowerCase() == "srd") {
                        rollString += `{{save=DT @{srd} ${saveType} Test}}`;
                    }
                    else {
                        rollString += `{{save=DT ${saveDT} ${saveType} Test}}`;
                    }
                }

                // Damage
                if(damage != "") {
                    let isAttack = attackType != "none";
                    let powerAdjustedDamage = damage.replaceAll("[P]", power);
                    rollString += DamageStringToTemplateRollString(powerAdjustedDamage, isAttack, stealthRanks);
                }

                // Description
                if(description != "") {
                    rollString += `{{description=${description}}}`;
                }
                
                startRoll(rollString, (r) => {
                    setAttrs({
                        essence_fire: fireEssence - fireCost,
                        essence_water: waterEssence - waterCost,
                        essence_earth: earthEssence - earthCost,
                        essence_air: airEssence - airCost
                    });

                    finishRoll(r.rollId);
                });
            }
            else {
                // Can't cast spell!
                console.error(`Can't cast ${name}! Not enough Essence available.`);
            }
        }
    );
}


function UpdateSRD() {
    getAttrs(
        [
            "wil",
            "spellwork"
        ],
        function(values) {
            let wil = parseInt(values["wil"]) || 0;
            let spellworkRanks = parseInt(values["spellwork"]) || 0;

            let attributes = {};

            attributes["srd"] = 10 + wil + spellworkRanks;

            setAttrs(attributes);
        }
    );
}

function UpdateSpellSaveDTs() {
    getSectionIDs("spell", function(ids) {
        for(let rowId of ids) {
            DoUpdateSpellSaveDT(rowId);
        }
    });
}

function UpdateSpellSaveDT(eventInfo) {
    let rowId = eventInfo.sourceAttribute.split("_")[2];
    DoUpdateSpellSaveDT(rowId);
}

function DoUpdateSpellSaveDT(rowId) {
    let prefix = "repeating_spell_" + rowId + "_spell_";

    let attributes = [
        prefix + "saveDTSkill",
        prefix + "saveDTAttribute",
        prefix + "saveDTBonus"
    ].concat(SKILLS, ATTRIBUTES, ATTRIBUTE_MODS);

    getAttrs(attributes,
        function(values) {
            let skill = values[prefix + "saveDTSkill"] || "";
            let attribute = values[prefix + "saveDTAttribute"] || "";
            let bonus = parseInt(values[prefix + "saveDTBonus"]) || 0;
            let skills = ParseSkills(values);
            let attributeScores = ParseAttributes(values);
            let attributeMods = ParseAttributeMods(values);

            let saveDT = bonus;
            
            if(skill != "-") {
                saveDT += skills[skill.toLowerCase()] || 0;

                if(attribute != "-") {
                    saveDT += attributeMods[attribute.substring(0, 3).toLowerCase()] || 0;
                }
            }
            else if(attribute != "-") {
                saveDT += attributeScores[attribute.toLowerCase()] || 0;
            }

            let attributes = {};
            attributes[prefix + "saveDT"] = saveDT;
            setAttrs(attributes);
        }
    );
}

function UseHealing() {
    getAttrs(["prayer", "faith"], function(values) {
        let faith = parseInt(values["faith"]) || 0;

        startRoll("&{template:custom} {{name=Healing}} {{result=[[@{healing}]]}}", (r) => {
            setAttrs({
                faith: faith - 1
            });
            finishRoll(r.rollId);
        })
    });
}

// Helper Functions
function Signed(n) {
    return (n<0?"":"+") + n;
}

function CalculateSlots(size, count) {
    let sizeParts = size.split("/");

    if(sizeParts.length > 1) {
        let slotsPerStack = parseInt(sizeParts[0]) || 0;
        let maxCountPerStack = parseInt(sizeParts[1]) || 1;

        return Math.ceil(count / maxCountPerStack) * slotsPerStack;
    }

    return (parseInt(sizeParts[0]) || 0) * count;
}

function ParseSkills(values) {
    let skills = {};

    for(let skill of SKILLS) {
        skills[skill] = parseInt(values[skill]) || 0;
    }

    return skills;
}

function ParseAttributes(values) {
    let attributes = {};

    for(let attribute of ATTRIBUTES) {
        attributes[attribute] = parseInt(values[attribute]) || 0;
    }

    return attributes;
}

function ParseAttributeMods(values) {
    let attributeMods = {};

    for(let mod of ATTRIBUTE_MODS) {
        attributeMods[mod] = parseInt(values[mod]) || 0;
    }

    return attributeMods;
}

function CapitalizeFirstLetter(str) {
  if (!str || str == "") return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function DamageStringToTemplateRollString(damage, isAttack, stealthRanks) {
    let rollString = "";
    let damagePartRegex = /(?:[+-]?\d+d\d+)*(?:[+-]?\d+)*(?:[+-]?\d+d\d+)* [a-z]+/gi;
    let damageParts = damage.match(damagePartRegex);

    let damageRolls = {};
    let critDamageRolls = {};
    let baseDamageType = "";

    for(let i = 0; i < damageParts.length; i++) {
        let split = damageParts[i].split(" ");
        let damageAmount = split[0];
        let damageType = split[1].toLowerCase();

        if(i === 0) {
            baseDamageType = damageType;
        }
        
        if(damageRolls[damageType] === undefined) {
            damageRolls[damageType] = `${damageAmount}`;
        }
        else {
            let plusSign = !damageAmount.startsWith("-") ? "+" : "";
            damageRolls[damageType] += `${plusSign}${damageAmount}`;
        }
        
        // Crit
        let diceRegex = /[+-]?\d+d\d+/gi;
        let damageDice = damageAmount.match(diceRegex);

        if(critDamageRolls[damageType] === undefined) {
            critDamageRolls[damageType] = "";
            
            for(let j = 0; j < damageDice.length; j++) {
                let plusSign = !damageDice[j].startsWith("-") && j>0 ? "+" : "";
                critDamageRolls[damageType] += `${plusSign}${damageDice[j]}`;
            }
        }
        else {
            for(let j = 0; j <= damageDice.length; j++) {
                let plusSign = !damageDice[j].startsWith("-") ? "+" : "";
                critDamageRolls[damageType] += `${plusSign}${damageDice[j]}`;
            }
        }
    }

    rollString += `{{damage=`;
    for(let damageType in damageRolls) {
        rollString += ` [[${damageRolls[damageType]}]] ${DamageTypeEmoji(damageType)}`;
    }
    rollString += `}}`;

    rollString += `{{critdamage=`;
    for(let damageType in critDamageRolls) {
        rollString += ` +[[${critDamageRolls[damageType]}]] ${DamageTypeEmoji(damageType)}`;
    }
    rollString += `}}`;

    if(isAttack) {
        // Sneak Attack
        if(stealthRanks >= 3) {
            let sneakAttackDamage = "";
            let sneakAttackDice = Math.floor(stealthRanks / 3);
            if(stealthRanks < 10) {
                sneakAttackDamage = sneakAttackDice + "d6";
            }
            else {
                sneakAttackDamage = sneakAttackDice + "d8";
            }
            rollString += `{{sneakattack=+[[${sneakAttackDamage}]] ${DamageTypeEmoji(baseDamageType)}}}`;
            rollString += `{{sneakattackcrit=+[[${sneakAttackDamage}]] ${DamageTypeEmoji(baseDamageType)}}}`;
        }
    }

    return rollString;
}

function DamageTypeEmoji(damageType) {
    if(DAMAGE_TYPES[damageType]) {
        return DAMAGE_TYPES[damageType];
    }
    
    return CapitalizeFirstLetter(damageType);
}

function GetCustomTemplateAtkString(mod) {
    return `?{Roll Type|` +
        `Normal,[[1d20${mod}]] {{atk=$[[0]]&#125;&#125; {{atkresult=$[[0]]&#125;&#125;|` +
        `Advantage,[[{[[1d20${mod}]]&#44;[[1d20${mod}]]&#125;kh1]] {{atk=$[[0]]&#125;&#125; {{atkadvantage=$[[1]]&#125;&#125; {{advflag=[[1]]&#125;&#125;|` +
        `Disadvantage,[[{[[1d20${mod}]]&#44;[[1d20${mod}]]&#125;kl1]] {{atk=$[[0]]&#125;&#125; {{atkadvantage=$[[1]]&#125;&#125; {{disadvflag=[[1]]&#125;&#125;}`
}
</script>

<!-- Custom Template -->
<rolltemplate class="sheet-rolltemplate-custom">
    <div class="sheet-template-container">
	    <div class="sheet-template-header">
            {{name}}
            {{#power}}[P{{power}}]{{/power}}
            {{#quality}}[Q{{quality}}]{{/quality}}
        </div>
	    {{#action}}
        <div class="sheet-template-action">
            {{action}}
        </div>
        {{/action}}
	    {{#components}}
        <div class="sheet-template-components">
            {{components}}
        </div>
        {{/components}}
	    {{#range}}
        <div class="sheet-template-detail">
            Range: {{range}}
        </div>
        {{/range}}
	    {{#area}}
        <div class="sheet-template-detail">
            Area: {{area}}
        </div>
        {{/area}}
	    {{#duration}}
        <div class="sheet-template-detail">
            Duration: {{duration}}
        </div>
        {{/duration}}
	    {{#result}}
        <hr class="sheet-template-divider"/>
        <div class="sheet-template-test">
            <div class="sheet-template-roll">{{result}}</div>
        </div>
        {{/result}}
	    {{#atk}}
        <hr class="sheet-template-divider"/>
        <div class="sheet-template-test">
            {{#advflag}}
            {{#^rollLess() atk atkadvantage}}
            <div class="sheet-template-roll">{{atk}}</div>
            <div class="sheet-template-roll sheet-template-roll-grey">{{atkadvantage}}</div>
            {{/^rollLess() atk atkadvantage}}
            {{#rollLess() atk atkadvantage}}
            <div class="sheet-template-roll sheet-template-roll-grey">{{atk}}</div>
            <div class="sheet-template-roll">{{atkadvantage}}</div>
            {{/rollLess() atk atkadvantage}}
            {{/advflag}}
            {{^advflag}}
            {{#disadvflag}}
            {{#^rollLess() atk atkadvantage}}
            <div class="sheet-template-roll sheet-template-roll-grey">{{atk}}</div>
            <div class="sheet-template-roll">{{atkadvantage}}</div>
            {{/^rollLess() atk atkadvantage}}
            {{#rollLess() atk atkadvantage}}
            <div class="sheet-template-roll">{{atk}}</div>
            <div class="sheet-template-roll sheet-template-roll-grey">{{atkadvantage}}</div>
            {{/rollLess() atk atkadvantage}}
            {{/disadvflag}}
            {{^disadvflag}}
            <div class="sheet-template-roll">{{atk}}</div>
            {{#atkadvantage}}
            <div class="sheet-template-roll">{{atkadvantage}}</div>
            {{/atkadvantage}}
            {{/disadvflag}}
            {{/advflag}}
            <br/>
            <span>Attack</span>
        </div>
        {{/atk}}
	    {{#save}}
        <hr class="sheet-template-divider"/>
        <div class="sheet-template-test">
            {{save}}
        </div>
        {{/save}}
        {{#damage}}
        <hr class="sheet-template-divider"/>
        <div class="sheet-template-damage">
            {{damage}}
            {{#rollWasCrit() atk}}
            {{critdamage}}
            {{/rollWasCrit() atk}}
            {{#rollWasCrit() atkadvantage}}
            {{#^rollWasCrit() atk}}
            {{critdamage}}
            {{/^rollWasCrit() atk}}
            {{/rollWasCrit() atkadvantage}}
            <br/>
            <span class="sheet-template-label">Damage</span>
        </div>
        {{/damage}}
        {{#sneakattack}}
        <hr class="sheet-template-divider"/>
        <div class="sheet-template-damage">
            {{sneakattack}}
            {{#rollWasCrit() atk}}
            {{sneakattackcrit}}
            {{/rollWasCrit() atk}}
            {{#rollWasCrit() atkadvantage}}
            {{#^rollWasCrit() atk}}
            {{sneakattackcrit}}
            {{/^rollWasCrit() atk}}
            {{/rollWasCrit() atkadvantage}}
            <br/>
            <span class="sheet-template-label">Sneak Attack</span>
        </div>
        {{/sneakattack}}
        {{#powerfulstrikes}}
        <hr class="sheet-template-divider"/>
        <div class="sheet-template-damage">
            {{powerfulstrikes}}
            <br/>
            <span class="sheet-template-label">Powerful Strikes</span>
        </div>
        {{/powerfulstrikes}}
        {{#siegeweapon}}
        <hr class="sheet-template-divider"/>
        <div class="sheet-template-damage">
            {{siegeweapon}}
            {{#rollWasCrit() atk}}
            {{siegeweaponcrit}}
            {{/rollWasCrit() atk}}
            {{#rollWasCrit() atkadvantage}}
            {{#^rollWasCrit() atk}}
            {{siegeweaponcrit}}
            {{/^rollWasCrit() atk}}
            {{/rollWasCrit() atkadvantage}}
            <br/>
            <span class="sheet-template-label">Siege Weapon</span>
        </div>
        {{/siegeweapon}}
        {{#description}}
        <hr class="sheet-template-divider"/>
	    <div class="sheet-template-description">
            {{description}}
        </div>
        {{/description}}
    </div>
</rolltemplate>